{
  "hash": "6c6a71a8cda7d2c0b9fd6e13b8bba4ba",
  "result": {
    "engine": "knitr",
    "markdown": "---\nbibliography: referencias.bib\nnocite: '@*'\n---\n\n\n\n\n\n::: {style=\"font-size: 1.5em; font-weight: bold; margin-bottom: 0.8em; margin-top: 0.5em;\"}\nAnálisis Geoestadístico Funcional de la Temperatura y el Ozono en el Estado de California durante marzo de 2024\n:::\n\n# Análisis Geoestadístico Funcional\n\n## Planteamiento del problema\n\n### Introducción\n\nLa calidad del aire es un elemento fundamental para la salud pública, el bienestar de las comunidades y el equilibrio de los ecosistemas. El deterioro de este recurso no solo incrementa el riesgo de enfermedades respiratorias y cardiovasculares, sino que también afecta la productividad, la calidad de vida y el funcionamiento de los sistemas naturales. En los últimos años, la preocupación por la contaminación atmosférica ha crecido debido a la combinación de factores antropogénicos y ambientales que intensifican la presencia de compuestos dañinos en la atmósfera, entre ellos el ozono troposférico y las variaciones extremas de temperatura.\n\nEn el estado de California, esta problemática adquiere una dimensión particular. Su elevada densidad poblacional, el tránsito vehicular, la actividad industrial y ciertos fenómenos naturales, como los incendios forestales, cada vez más frecuentes, contribuyen a que numerosas ciudades presenten niveles críticos de contaminación. Estas condiciones hacen necesario un análisis más profundo de la dinámica espacial y temporal de los contaminantes atmosféricos. En este contexto, el uso de herramientas estadísticas avanzadas, como el análisis funcional y la predicción espacial, se convierte en un enfoque útil para comprender los patrones subyacentes y apoyar la toma de decisiones en materia ambiental.\n\n### Descripción de los datos\n\nLos datos objeto de este estudio provienen de la [Agencia de Protección Ambiental (EPA)](https://www.epa.gov/) de los Estados Unidos y corresponden a registros horarios obtenidos de las estaciones de monitoreo durante el mes de marzo de 2024. En particular, se analizan las variables **Temperatura ambiente (Temp)** y **Ozono (**$O_3$**)**.\n\n#### Unidades\n\n-   **Temperatura ambiente:** Medida en grados celsius (C°) con una intensidad horaria.\n\n-   **Ozono:** Medida en partes por billón (ppb) con una intensidad horaria.\n\n### Objetivos\n\n#### Objetivo general\n\nAnalizar las estructuras temporales y espaciales de las variables ozono y temperatura en California durante marzo de 2024 mediante técnicas de análisis de datos funcionales (FDA), con el fin de construir un modelo de covarianza espacial basado en componentes principales funcionales (FPCA) que permita realizar predicciones espacialmente coherentes de ambas variables.\n\n#### Objetivos específicos\n\n1.  Construir las curvas funcionales de ozono y temperatura mediante un proceso de suavizamiento apropiado, empleando bases de B-splines cúbicas y estimando el parámetro de penalización $(\\lambda)$ por validación cruzada.\n\n2.  Aplicar el análisis de componentes principales funcionales (FPCA) y obtener los scores funcionales, para luego estudiar y modelar la dependencia espacial mediante la construcción del semivariograma empírico y el ajuste de modelos teóricos.\n\n3.  Implementar Kriging Funcional para generar mapas de predicción espacial y mapas de incertidumbre, utilizando los componentes principales y la estructura espacial estimada, con el fin de representar la distribución esperada de las variables y evaluar la precisión de las estimaciones.\n\n## Análisis Geoestadístico Funcional\n\n### Variable Temperatura\n\nEn el siguiente bloque se muestra el código utilizado para imputar los valores faltantes en las 127 estaciones de California a lo largo de las 744 observaciones temporales. A partir de los modelos ajustados en el [Análisis Univariado](#cap1), se estimó un semivariograma para cada instante en el tiempo, seleccionando el modelo adecuado según el criterio de MSE. Finalmente, la predicción espacial se llevó a cabo mediante la función `krige()` del paquete `gstat`.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\nkrig_list <- list()\n\nProgress <- txtProgressBar(min = 0, max = nrow(Temp), style = 3)\n\nfor (i in 1:nrow(Temp)){\n  \n  y_T <- Temp[i,] #Tomar una fecha\n  y_T <- cbind(colnames(y_T),t(y_T[1,]))\n  y_T <- y_T[-1,]\n  y_T <- as.data.frame(y_T)\n  y_T <- na.omit(y_T)\n  y_T$V1 <- as.numeric(y_T$V1)\n  y_T <- inner_join(y_T, EstacionesT, by=c(\"V1\"=\"AQSID\"))\n  datosT <- y_T[,c(13,14,2)]\n  colnames(datosT)=c(\"Este\",\"Norte\",\"Temperatura\")\n  datosT$Temperatura <- as.numeric(datosT$Temperatura)\n  temp <- as.geodata(datosT)\n  vg <- quiet(\n        variog(temp, trend = ~Norte+Este+I(Este^2)+I(Este^3),\n               estimator.type = \"modulus\", pairs.min=50,\n               max.dist=7e5))\n  \n  est1 <- quiet(\n          variofit(vg, cov.model = \"exponential\", ini=ini1_exp_T,\n                   fix.nugget = F,\n                   wei = \"cressie\"))\n\n  est3 <- quiet(\n          variofit(vg, cov.model = \"spherical\", ini=ini1_es_T,\n                   fix.nugget = F,\n                   wei = \"cressie\"))\n  \n  par1 <- c(est1$nugget, est1$cov.pars[1], est1$cov.pars[2])\n  par3 <- c(est3$nugget, est3$cov.pars[1], est3$cov.pars[2])\n  \n  mse1 <- MSE_sv(vg$v, par1, NA, model = \"exponencial\", vg$u)\n  mse3 <- MSE_sv(vg$v, par3, NA, model = \"spherical\", vg$u)\n  \n  mse_values <- c(exponential = mse1, spherical = mse3)\n  best_model <- names(which.min(mse_values))\n  \n  best_fit <- switch(best_model,\n                     exponential = est1,\n                     gaussian = est2,\n                     spherical = est3)\n  \n  model_gstat <- switch(best_model,\n                        exponential = \"Exp\",\n                        gaussian = \"Gau\",\n                        spherical = \"Sph\")\n  \n  vgm_best <- gstat::vgm(psill = best_fit$cov.pars[1],\n                  model = model_gstat,\n                  range = best_fit$cov.pars[2],\n                  nugget = best_fit$nugget)\n\n  y_T_NA <- Temp[i, ]\n  y_T_NA <- cbind(colnames(y_T_NA), t(y_T_NA[1,]))\n  y_T_NA <- y_T_NA[-1,]\n  y_T_NA <- as.data.frame(y_T_NA)\n  y_T_NA <- y_T_NA[is.na(y_T_NA$V2), ]  # Filtrar las estaciones sin dato\n  y_T_NA$V1 <- as.numeric(y_T_NA$V1)\n  Estaciones <- y_T_NA$V1 \n  y_T_NA <- inner_join(y_T_NA, EstacionesT, by = c(\"V1\" = \"AQSID\"))\n  y_T_NA <- y_T_NA[,c(13,14,2)]\n  colnames(y_T_NA)=c(\"Este\",\"Norte\",\"Temperatura\")\n  \n  if (nrow(y_T_NA)==0) {\n    warning(paste(\"No valores faltantes a estimar\", i))\n    next\n  }\n                       \n  pred_grid <- y_T_NA[, c(\"Este\", \"Norte\")]\n  coordinates(datosT) <- ~Este+Norte\n  coordinates(pred_grid) <- ~Este + Norte\n  \n  krig_result <- quiet(gstat::krige(\n    formula = Temperatura ~ Norte + Este + I(Este^2) + I(Este^3),\n    locations = ~ Norte + Este,\n    data = as.data.frame(datosT),\n    newdata = pred_grid,\n    model = vgm_best,\n    nmin =20\n  ))\n  \n  Temp[i, as.character(Estaciones)] <- t(krig_result@data[[\"var1.pred\"]])\n  \n  setTxtProgressBar(Progress, i)\n}\n\nTemp[,-1] <- lapply(Temp[ , -1], function(x) round(as.numeric(x), 1))\n```\n:::\n\n\n\n\n\n\nEn el siguiente gráfico se presentan las series de tiempo de los valores observados de manera horaria para 127 estaciones en el mes de marzo de 2024.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Librerias necesarias ------------------------------------\n\nset.seed(123)\n\nlibrary(dplyr)\nlibrary(geoR)\nlibrary(sp)\nlibrary(readxl)\nlibrary(tidyr)\nlibrary(sf)\nlibrary(ggplot2)\nlibrary(knitr)\nlibrary(plotly)\nlibrary(leaflet)\nlibrary(raster)\nlibrary(stars)\nlibrary(fda)\nlibrary(fda.usc)\nlibrary(terra)\nlibrary(SpatFD)\nlibrary(gstat)\nlibrary(rcartocolor)\n\n#Gráficos de dispersión ----------------------------------\n\nsimple_scatter_plot <- function(datos, variable1, variable2) {\n\n    plot1 <- ggplot(as.data.frame(datos),\n                    aes(x = .data[[variable1]], y = .data[[variable2]],\n                               color = as.factor(1))) +\n                    geom_point() +\n                    scale_colour_viridis_d() +\n                    labs(\n                        x = variable1,\n                        y = variable2\n                        ) +\n                    theme_light() +\n                    theme(legend.position = \"none\")\n\n    return(plot1)\n\n}\n\n#-----------------------------------------------------------\n\nTemp <- read_excel(\"Temp_imp.xlsx\", sheet = \"Temperatura\")\nTemp <- as.data.frame(Temp)\nEstacionesT <- read_excel(\"Temp_imp.xlsx\", sheet = \"Estaciones\")\nEstacionesT <- EstacionesT[,c(1,12,13)]\n\n#Para el mapa de California -------------------------------\n\nsh_mundos<-st_read(\"admin00.shp\",quiet=TRUE)\nsh_mundos <- sh_mundos %>% filter(CNTRY_NAME==\"United States\")\nsh_mundos <- sh_mundos %>% filter(ADMIN_NAME==\"California\")\n\nCRS_UTM_NY = \"+init=epsg:3310\"\n\nsh_mundos_wgs84 <- st_transform(sh_mundos, crs = 4326)\n\nsh_mundos_utm <- st_transform(sh_mundos, crs = CRS(\"EPSG:3310\"))\n\nsh_mundos_sp_utm <- as(sh_mundos_utm, \"Spatial\")\n\nsh_mundos_utm_simple <- st_union(sh_mundos_utm)\nsh_mundos_sp_utm_simple <- as(sh_mundos_utm_simple, \"Spatial\")\n\n#Grilla para hacer kriging ------------------------------\n\nnew <- sp::spsample(as(sh_mundos_utm, \"Spatial\"), n = 10000, type = \"regular\")\n\nproj4string(new) <- CRS(\"EPSG:3310\")\ninvisible(coordinates(new) ~ Este + Norte)\ncolnames(new@coords) <- c(\"Este\", \"Norte\")\n\nTemp$DateTime <- as.POSIXct(Temp$DateTime,\n                            format = \"%m/%d/%y %H:%M:%S\",\n                            tz = \"America/Bogota\")\n\ncols <- rainbow(ncol(Temp)-1)\n\nggplot() +\n  lapply(2:ncol(Temp), function(i) {\n    geom_line(aes(x = Temp$DateTime, y = Temp[[i]]), \n              color = cols[i-1],\n              alpha = 0.8)\n  }) +\n  labs(x = \"Fecha\", y = \"Temperatura\")+\n  theme_light()\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n\n\n\n#### Modelamiento con B-Splines\n\nPara aplicar la metodología funcional es necesario suavizar previamente los datos. Para ello, se una base de B-Splines conformada por $k=64$ funciones. Luego de esto, se determinó el valor óptimo del parámetro de penalización $\\lambda$ mediante **validación cruzada**.\n\nEn el siguiente gráfico se muestra el comportamiento del GCV a lo largo del rango de valores evaluados para del parámetro de penalización, junto con un resumen tabular de los resultados obtenidos.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntemp <- as.matrix(Temp[,-1])\n\nk <- round(ncol(temp)/2)\n\nBSpl <- create.bspline.basis(rangeval=c(0,744),\n                                    nbasis=k, norder=4)\nloglam = seq(17.25,18.25,0.01)\nnlam = length(loglam)\ndfsave = rep(NA,nlam)\ngcvsave = rep(NA,nlam)\nfor (ilam in 1:nlam) {\nlambda = loglam[ilam]\nfdParobj = fdPar(BSpl, Lfdobj=NULL, lambda= lambda)\nsmoothlist = smooth.basis(1:nrow(temp), temp, fdParobj)\ndfsave[ilam] = smoothlist$df\ngcvsave[ilam] = sum(smoothlist$gcv)\n}\n\nggplot(data.frame(\n                  loglam = loglam,\n                  gcv = gcvsave\n                  ),\n    aes(x = loglam, y = gcv)) +\n    geom_point(size = .8) +\n    geom_line() +\n    labs(\n        x = expression(lambda),\n        y = expression(GCV(lambda)),\n        title = \"Parámetros de suavizamiento versus GCV\"\n    ) +\n    theme_light()+theme(\n        plot.title = element_text(hjust = 0.5,\n                                  face = \"bold\")\n    )\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n\n```{.r .cell-code}\nbest.idx     <- which.min(gcvsave)\nbest.lambda  <- loglam[best.idx]\n\nknitr::kable(data.frame(lambda = best.lambda,\n                         GCV=round(min(gcvsave), 3)),\n             escape = F,\n             col.names = c(\"$$\\\\lambda$$\", \"$$GCV$$\"),\n             align='c')\n```\n\n::: {.cell-output-display}\n\n\n| $$\\lambda$$ | $$GCV$$  |\n|:-----------:|:--------:|\n|    17.82    | 1307.184 |\n\n\n:::\n:::\n\n\n\n\n\nCon los valores estimados de $k$ y $\\lambda$ se procede a realizar el suavizamiento mediante B-Splines. En la siguiente figura se muestran las curvas suavizadas obtenidas a partir de esta base.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nFtemp <- Data2fd(y=temp, basisobj=BSpl, lambda = best.lambda)\n\ninicio <- as.POSIXct(\"2024-03-01 00:00:00\", tz = \"America/Bogota\")\ninicio <- inicio + (0:743)*3600\n\nt_eval <- seq(0, 744, length.out = 744)\n\neval_Ftemp <- eval.fd(t_eval, Ftemp)\neval_Ftemp <- as.data.frame(eval_Ftemp)\neval_Ftemp$t <- inicio\neval_Ftemp$t1 <- t_eval\n\neval_Ftemp <- pivot_longer(\n  eval_Ftemp,\n  cols = c(-t,-t1),\n  names_to = \"Estacion\",\n  values_to = \"Temperatura\"\n)\n\nggplot(eval_Ftemp, aes(x = t, y = Temperatura, group = Estacion, col=Estacion)) +\n  geom_line(linewidth = 0.7) + \n  labs(\n    title = \"Datos suavizados de la Temperatura\",\n    x = \"Hora-Día\",\n    y = \"Temperatura C°\"\n  ) +\n  theme_light() +\n  theme(\n    plot.title = element_text(hjust = 0.5, face = \"bold\"),  \n    legend.position = \"none\"\n  )\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\n\nLos resultados muestran que el suavizamiento logra reproducir de forma consistente la tendencia y la variabilidad general de las series de tiempo originales. Por lo tanto, se concluye que los valores de $k$ y $\\lambda$ proporcionan un balance apropiado entre fidelidad y suavidad.\n\n##### Estadística descriptiva\n\nAdicionalmente, con el propósito de caracterizar las tendencias capturadas por el ajuste, se presenta un resumen descriptivo del proceso de suavizamiento.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmeanfdh <- mean.fd(Ftemp)\nvarfdh <-var.fd(Ftemp)\nstdvfdh <- stddev.fd(Ftemp)\n```\n:::\n\n\n\n\n\n::: panel-tabset\n###### Media\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(eval_Ftemp, aes(x = t, y = Temperatura, group = Estacion, col=Estacion)) +\n  geom_line(linewidth = 0.7, show.legend = F) + \n  geom_line(data = data.frame(t = eval_Ftemp$t,\n                              Media =  eval.fd(eval_Ftemp$t1, meanfdh)),\n            aes(x = t, y = mean,, group = 1),\n            linewidth = 1.2, col=\"red\",\n            inherit.aes = FALSE )+\n  labs(\n    title = \"Media de los suavizados de la Temperatura\",\n    x = \"Hora-Día\",\n    y = \"Temperatura C°\"\n  ) +\n  theme_light() +\n  theme(\n    plot.title = element_text(hjust = 0.5, face = \"bold\"),  \n  )\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n\n###### Varianza\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(varfdh, main=\" Superficie de varianza\", xlab = \"t\", ylab = \"s\")\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n\n\n###### SD\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata.frame(\n  t = eval_Ftemp$t,\n  std = as.vector(eval.fd(eval_Ftemp$t1, stdvfdh))\n) %>% \n  ggplot(aes(x = t, y = std)) +\n  geom_line(color = \"steelblue\", linewidth = 1) +\n  labs(\n    title = \"Desviación estándar\",\n    x = \"Hora-Día\",\n    y = \"Temperatura °C\"\n  ) +\n  theme_light() +\n  theme(\n    plot.title = element_text(hjust = 0.5, face = \"bold\")\n  )\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n\n:::\n\n#### Componentes Principales\n\nSe lleva a cabo un **análisis de componentes funcional (ACPF)** con el propóstio de reducir la dimensión de las funciones. Para ello, se emplea la función `pca.fd()` del paquete `fda`.\n\nSe seleccionaron las 10 primeras funciones propias como base para el análisis. A continuación, se presenta de forma gráfica el porcentaje de varianza acumulada explicado por cada componente.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nPCA = pca.fd(Ftemp, 10)\n\ndata.frame(\n  Dim = 1:10,\n  Perc = round(PCA$varprop*100,2)\n) %>% \n  ggplot(aes(x = Dim, y = Perc)) +\n  geom_col(fill = \"#7EC0EE\", width = 0.7, alpha = 0.8) +\n  geom_line(aes(y = Perc), linewidth = 0.8) +\n  geom_point(size = 1.5) +\n  geom_text(aes(label = paste0(round(Perc,1), \"%\")),\n            vjust = -0.5, size = 3) +\n  scale_x_continuous(breaks = 1:10) +\n  labs(\n    title = \"Valores propios del FPCA\",\n    x = \"Dimensiones\",\n    y = \"Porcentaje de varianza explicada\"\n  ) +\n  theme_light() +\n  theme(\n    plot.title = element_text(hjust = 0.5, face = \"bold\")\n  )\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n\n\nDebido a que los tres primeros componentes principales concentran más del 90 % de la variabilidad total de las funciones, se opta por utilizar únicamente estos componentes en el análisis geoestadístico.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoordsT <- EstacionesT[,c(2,3)]\nPC1T <- cbind(Scores=PCA$scores[,1], coordsT)\nPC2T <- cbind(Scores=PCA$scores[,2], coordsT)\nPC3T <- cbind(Scores=PCA$scores[,3], coordsT)\n```\n:::\n\n\n\n\n\nPara avanzar con el análisis geoestadístico, se examina primero el comportamiento de la media con el fin de determinar si existe algún efecto espacial que deba corregirse mediante un modelo de regresión adecuado. A continuación, se presentan las matrices de correlación y los gráficos de dispersión para los Scores y las coordenadas, cuyo propósito es identificar patrones que sugieran la presencia de una tendencia espacial en la media.\n\n::: panel-tabset\n\n##### Primer Componente\n\n::: panel-tabset\n###### Matriz\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npander::pander(cor(PC1T))\n```\n\n::: {.cell-output-display}\n\n------------------------------------------\n   &nbsp;     Scores     Este      Norte  \n------------ --------- --------- ---------\n **Scores**      1      0.2639    -0.1515 \n\n  **Este**    0.2639       1      -0.7656 \n\n **Norte**    -0.1515   -0.7656      1    \n------------------------------------------\n\n\n:::\n:::\n\n\n\n\n\n###### Gráficos de dispersión\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npO1 <- simple_scatter_plot(PC1T, \"Este\", \"Scores\")\npO2 <- simple_scatter_plot(PC1T, \"Norte\", \"Scores\")\n\ncowplot::plot_grid(pO1,pO2)\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n\n\n:::\n\n##### Segundo Componente\n\n::: panel-tabset\n###### Matriz\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npander::pander(cor(PC2T))\n```\n\n::: {.cell-output-display}\n\n------------------------------------------\n   &nbsp;     Scores     Este      Norte  \n------------ --------- --------- ---------\n **Scores**      1      -0.2497   0.06783 \n\n  **Este**    -0.2497      1      -0.7656 \n\n **Norte**    0.06783   -0.7656      1    \n------------------------------------------\n\n\n:::\n:::\n\n\n\n\n\n###### Gráficos de dispersión\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npO1 <- simple_scatter_plot(PC2T, \"Este\", \"Scores\")\npO2 <- simple_scatter_plot(PC2T, \"Norte\", \"Scores\")\n\ncowplot::plot_grid(pO1,pO2)\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n\n\n:::\n\n##### Tercer Componente\n\n::: panel-tabset\n###### Matriz\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npander::pander(cor(PC3T))\n```\n\n::: {.cell-output-display}\n\n--------------------------------------------\n   &nbsp;      Scores      Este      Norte  \n------------ ---------- ---------- ---------\n **Scores**      1       -0.02491   0.1259  \n\n  **Este**    -0.02491      1       -0.7656 \n\n **Norte**     0.1259    -0.7656       1    \n--------------------------------------------\n\n\n:::\n:::\n\n\n\n\n\n###### Gráficos de dispersión\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npO1 <- simple_scatter_plot(PC3T, \"Este\", \"Scores\")\npO2 <- simple_scatter_plot(PC3T, \"Norte\", \"Scores\")\n\ncowplot::plot_grid(pO1,pO2)\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n\n\n:::\n\n:::\n\nComo se observa, los scores presentan media cero y no se identifica un patrón evidente entre ellos y las coordenadas Este y Norte. En consecuencia, se procede a modelar el semivariograma.\n\n#### Estructura de Covarianza Espacial\n\n##### Modelos Individuales\n\nEn segunda instancia, se analiza la variabilidad de la variable incrementos, derivada de los Scores, mediante las función `variogram()` y `fit.variogram()`, con el propósito de caracterizar su estructura espacial y ajustar el modelo de semivariograma correspondiente.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npuntaje=PCA$scores[,c(1:3)]\ncolnames(puntaje)=c(\"f1\",\"f2\",\"f3\")\nrownames(puntaje) = EstacionesT$AQSID\npuntajes=as.data.frame(puntaje)\ncoordinates(puntajes)=coordsT\n\nvg_PC1_T <-  variogram(f1~1,puntajes, cressie=T)\nvg_PC2_T <-  variogram(f2~1,puntajes, cressie=T)\nvg_PC3_T <-  variogram(f3~1,puntajes, cressie=T)\n\nvgcross <- gstat(NULL, id = \"f1\", form = f1 ~ 1, data = puntajes)\nvgcross <- gstat(vgcross, id = \"f2\", form = f2 ~ 1, data = puntajes)\nvgcross <- gstat(vgcross, id = \"f3\", form = f3 ~ 1, data = puntajes)\n\nvgm.cross <- variogram(vgcross,, cressie=T)\n```\n:::\n\n\n\n\n\n::: panel-tabset\n\n###### Primer Componente\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexp_pc1T <- fit.variogram(vg_PC1_T, vgm(\"Exp\"),\n                          fit.method = 2)\nplot(vg_PC1_T, model = exp_pc1T)\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n\n```{.r .cell-code}\npander::pander(exp_pc1T)\n```\n\n::: {.cell-output-display}\n\n--------------------------------------------------------------------\n model   psill   range   kappa   ang1   ang2   ang3   anis1   anis2 \n------- ------- ------- ------- ------ ------ ------ ------- -------\n  Nug      0       0       0      0      0      0       1       1   \n\n  Exp    5615    18273    0.5     0      0      0       1       1   \n--------------------------------------------------------------------\n\n\n:::\n:::\n\n\n\n\n\n\n###### Segundo Componente\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexp_pc2T <- fit.variogram(vg_PC2_T, vgm(\"Wav\"),\n                          fit.method = 7)\nplot(vg_PC2_T, model = exp_pc2T)\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n\n```{.r .cell-code}\npander::pander(exp_pc2T)\n```\n\n::: {.cell-output-display}\n\n---------------------------------------------------------------------\n model   psill   range    kappa   ang1   ang2   ang3   anis1   anis2 \n------- ------- -------- ------- ------ ------ ------ ------- -------\n  Nug    442.3     0        0      0      0      0       1       1   \n\n  Wav    109.6   120168    0.5     0      0      0       1       1   \n---------------------------------------------------------------------\n\n\n:::\n:::\n\n\n\n\n\n\n###### Tercer Componente\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexp_pc3T <- fit.variogram(vg_PC3_T, vgm(\"Exp\"),\n                          fit.method = 7)\nplot(vg_PC3_T, model = exp_pc3T)\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n\n```{.r .cell-code}\npander::pander(exp_pc3T)\n```\n\n::: {.cell-output-display}\n\n--------------------------------------------------------------------\n model   psill   range   kappa   ang1   ang2   ang3   anis1   anis2 \n------- ------- ------- ------- ------ ------ ------ ------- -------\n  Nug    155.4     0       0      0      0      0       1       1   \n\n  Exp    223.5   67327    0.5     0      0      0       1       1   \n--------------------------------------------------------------------\n\n\n:::\n:::\n\n\n\n\n\n:::\n\nSe observa un buen ajuste para la primera función propia mediante un modelo **Exponencial**, incluso con un efecto pepita nulo. ncluso sin requerir un efecto pepita. En contraste, para la segunda función propia se identifica un nugget elevado; aun así, el modelo **Wave** logra representar adecuadamente su comportamiento oscilatorio. En el caso de la tercera función propia, aunque también presenta un nugget considerable, el modelo **Exponencial** captura de manera satisfactoria la estructura del semivariograma.\n\nA partir de estos resultados, se infiere que las estructuras de dependencia son compatibles principalmente con modelos **Exponenciales** o **Wave**, por lo que estos resultan los candidatos más adecuados para construir el modelo lineal de corregionalización.\n\n##### Modelo Lineal de Corregionalización\n\nEl variograma cruzado se presenta en seguida:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(vgm.cross)\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n\n\n\nSe opta por un **modelo Wave** para realizar el ajuste mediante la función `fit.lmc()` de `gstat`:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvgcross <- gstat(vgcross, id = \"f1\", model = exp_pc2T,\n                 fill.all = T)\n\ng <- fit.lmc(vgm.cross, vgcross, fit.method=6, correct.diagonal=1.01)\n\nplot(vgm.cross, model = g$model)\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n\n\n\n\nEl resumen de los modelos ajustados para el modelo lineal de corregionalización se presenta de forma tabular a continuación:\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npander::pander(g$model)\n```\n\n::: {.cell-output-display}\n\n\n  * **f1**:\n\n    ---------------------------------------------------------------------\n     model   psill   range    kappa   ang1   ang2   ang3   anis1   anis2\n    ------- ------- -------- ------- ------ ------ ------ ------- -------\n      Nug    4378      0        0      0      0      0       1       1\n\n      Wav    1314    120168    0.5     0      0      0       1       1\n    ---------------------------------------------------------------------\n\n  * **f1.f2**:\n\n    ----------------------------------------------------------------------\n     model   psill    range    kappa   ang1   ang2   ang3   anis1   anis2\n    ------- -------- -------- ------- ------ ------ ------ ------- -------\n      Nug    1.258      0        0      0      0      0       1       1\n\n      Wav    -26.27   120168    0.5     0      0      0       1       1\n    ----------------------------------------------------------------------\n\n  * **f1.f3**:\n\n    ---------------------------------------------------------------------\n     model   psill   range    kappa   ang1   ang2   ang3   anis1   anis2\n    ------- ------- -------- ------- ------ ------ ------ ------- -------\n      Nug    25.81     0        0      0      0      0       1       1\n\n      Wav    71.34   120168    0.5     0      0      0       1       1\n    ---------------------------------------------------------------------\n\n  * **f2**:\n\n    ---------------------------------------------------------------------\n     model   psill   range    kappa   ang1   ang2   ang3   anis1   anis2\n    ------- ------- -------- ------- ------ ------ ------ ------- -------\n      Nug    496.1     0        0      0      0      0       1       1\n\n      Wav    83.63   120168    0.5     0      0      0       1       1\n    ---------------------------------------------------------------------\n\n  * **f2.f3**:\n\n    ---------------------------------------------------------------------\n     model   psill   range    kappa   ang1   ang2   ang3   anis1   anis2\n    ------- ------- -------- ------- ------ ------ ------ ------- -------\n      Nug    22.78     0        0      0      0      0       1       1\n\n      Wav    -56.9   120168    0.5     0      0      0       1       1\n    ---------------------------------------------------------------------\n\n  * **f3**:\n\n    ---------------------------------------------------------------------\n     model   psill   range    kappa   ang1   ang2   ang3   anis1   anis2\n    ------- ------- -------- ------- ------ ------ ------ ------- -------\n      Nug    244.6     0        0      0      0      0       1       1\n\n      Wav    123.2   120168    0.5     0      0      0       1       1\n    ---------------------------------------------------------------------\n\n  * **f3.NA**:\n\n    ---------------------------------------------------------------------\n     model   psill   range    kappa   ang1   ang2   ang3   anis1   anis2\n    ------- ------- -------- ------- ------ ------ ------ ------- -------\n      Nug    442.3     0        0      0      0      0       1       1\n\n      Wav    109.6   120168    0.5     0      0      0       1       1\n    ---------------------------------------------------------------------\n\n  * **f3.f3**:\n\n    ---------------------------------------------------------------------\n     model   psill   range    kappa   ang1   ang2   ang3   anis1   anis2\n    ------- ------- -------- ------- ------ ------ ------ ------- -------\n      Nug    442.3     0        0      0      0      0       1       1\n\n      Wav    109.6   120168    0.5     0      0      0       1       1\n    ---------------------------------------------------------------------\n\n\n<!-- end of list -->\n\n\n\n:::\n:::\n\n\n\n\n\n::: {.callout-caution appearance=\"simple\"}\n##### En desarrollo...\n:::\n\n#### Kriging Funcional\n\nEn esta sección se presentan los resultados del Kriging Funcional aplicando los distintos métodos estudiados en clase.\n\n##### Método de Scores\n\nA partir de los modelos teóricos ajustados para los semivariogramas de cada función propia, se construyen las predicciones en los puntos no observados. La grilla de ubicaciones se genera mediante la función `spsample()` del paquete `sp`, mientras que las predicciones se obtienen utilizando la función `krige()` de `gstat`. De manera similar a como se hizo en el [Análisis Univariado](#cap1), se especificíco el parámetro `nmin=20` con el fin de mitigar el efecto de las largas distancias que se presentan en el estado de California.  \n\nLos resultados se presentan en la figura siguiente, donde se aprecia que las predicciones obtenidas reproducen adecuadamente el patrón general capturado por el suavizamiento funcional.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nproj4string(puntajes) <- CRS(\"EPSG:3310\")\n\ng_CP1<-gstat(id = \"f1\", form = f1 ~ 1,\n             data = puntajes, model = exp_pc1T)\ng_CP2<-gstat(id = \"f2\", form = f2 ~ 1,\n             data = puntajes, model = exp_pc2T)\ng_CP3<-gstat(id = \"f3\", form = f3 ~ 1,\n             data = puntajes, model = exp_pc3T)\n\n#Kriging ------------------------------------------------\n\ninvisible(predic_CP1 <- predict(g_CP1, newdata = new, nmin = 20))\ninvisible(predic_CP2 <- predict(g_CP2, newdata = new, nmin = 20))\ninvisible(predic_CP3 <- predict(g_CP3, newdata = new, nmin = 20))\n\npred_pca <- cbind(\n  predic_CP1@data[\"f1.pred\"], \n  predic_CP2@data[\"f2.pred\"], \n  predic_CP3@data[\"f3.pred\"]\n)\n\nnames(pred_pca) <- c(\"PC1.pred\", \"PC2.pred\", \"PC3.pred\")\n\nV_matrix <- PCA$harmonics$coefs[,c(1:3)]\n\ncoef_predichos_variacion <- as.matrix(V_matrix) %*% t(pred_pca) \n\nmean_coefs <- PCA$meanfd$coefs\nmean_coefs <- as.vector(mean_coefs)\n\ncoef_predichos_totales <- sweep(x = coef_predichos_variacion, # Matriz de variación (k x N_new)\n                                MARGIN = 1,                     # Sumar por FILAS (cada fila es un coeficiente de base)\n                                STATS = mean_coefs,             # Vector de la media (k x 1)\n                                FUN = \"+\")\n\nfd_temp_pred <- fd(coef = coef_predichos_totales, basisobj = PCA$harmonics$basis)\ntemp_pred_eval <- eval.fd(1:744, fd_temp_pred)\n\ntemp_pred <- as.data.frame(temp_pred_eval)\ntemp_pred$t <- inicio\n\npred_Ftemp <- pivot_longer(\n  temp_pred,\n  cols = -t,\n  names_to = \"Estacion\",\n  values_to = \"Temperatura\"\n)\n\nggplot(pred_Ftemp, aes(x = t, y = Temperatura, group = Estacion, col=Estacion)) +\n  geom_line(linewidth = 0.7) + \n  labs(\n    title = \"Estimaciones por Kriging Funcional \\n para marzo de 2024\",\n    x = \"Hora-Día\",\n    y = \"Temperatura C°\"\n  ) +\n  theme_light() +\n  theme(\n    plot.title = element_text(hjust = 0.5, face = \"bold\"),  \n    legend.position = \"none\"\n  )\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::\n\n\n\n\n\n###### Mapas de predicción\n\nSe escogieron cuatro momentos en el tiempo correspondientes (1, 7, 14 y 28 de marzo) a 4 días diferentes para la misma hora (12:00 m). \n\n::: panel-tabset\n\n####### Primer momento\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmelt_s <- data.frame(Value = pred_Ftemp[pred_Ftemp$t==\"2024-03-01 12:00:00\",3], \n                     X = new@coords[,1], Y = new@coords[,2])\n\nmelt_s <- st_as_sf(melt_s,\n                coords = c(\"X\", \"Y\"),\n                crs = CRS_UTM_NY)\n\nggplot() +\n  geom_sf(data = sh_mundos, fill = \"gray90\", color = \"gray30\", linewidth = 0.5) +\n  geom_sf(\n    data = melt_s, \n    aes(col = Temperatura), \n    size = 3,          \n    alpha = 0.8 \n  ) +\n  scale_color_carto_c(palette = 'Prism', na.value = '#111111') +\n  labs(\n    title = \"1 de marzo de 2024 - 12:00:00\",\n    color = \"Temperatura\"\n  ) +\n  theme_light()+\n  theme(\n    plot.title = element_text(hjust = 0.5, face = \"bold\"))\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n:::\n\n\n\n\n\n####### Segundo momento\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmelt_s <- data.frame(Value = pred_Ftemp[pred_Ftemp$t==\"2024-03-07 12:00:00\",3], \n                     X = new@coords[,1], Y = new@coords[,2])\n\nmelt_s <- st_as_sf(melt_s,\n                coords = c(\"X\", \"Y\"),\n                crs = CRS_UTM_NY)\n\nggplot() +\n  geom_sf(data = sh_mundos, fill = \"gray90\", color = \"gray30\", linewidth = 0.5) +\n  geom_sf(\n    data = melt_s, \n    aes(col = Temperatura), \n    size = 3,          \n    alpha = 0.8 \n  ) +\n  scale_color_carto_c(palette = 'Prism', na.value = '#111111') +\n  labs(\n    title = \"7 de marzo de 2024 - 12:00:00\",\n    color = \"Temperatura\"\n  ) +\n  theme_light()+\n  theme(\n    plot.title = element_text(hjust = 0.5, face = \"bold\"))\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-26-1.png){width=672}\n:::\n:::\n\n\n\n\n\n####### Tercer momento\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmelt_s <- data.frame(Value = pred_Ftemp[pred_Ftemp$t==\"2024-03-14 12:00:00\",3], \n                     X = new@coords[,1], Y = new@coords[,2])\n\nmelt_s <- st_as_sf(melt_s,\n                coords = c(\"X\", \"Y\"),\n                crs = CRS_UTM_NY)\n\nggplot() +\n  geom_sf(data = sh_mundos, fill = \"gray90\", color = \"gray30\", linewidth = 0.5) +\n  geom_sf(\n    data = melt_s, \n    aes(col = Temperatura), \n    size = 3,          \n    alpha = 0.8 \n  ) +\n  scale_color_carto_c(palette = 'Prism', na.value = '#111111') +\n  labs(\n    title = \"14 de marzo de 2024 - 12:00:00\",\n    color = \"Temperatura\"\n  ) +\n  theme_light()+\n  theme(\n    plot.title = element_text(hjust = 0.5, face = \"bold\"))\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n\n\n\n\n\n####### Cuarto momento\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmelt_s <- data.frame(Value = pred_Ftemp[pred_Ftemp$t==\"2024-03-28 12:00:00\",3], \n                     X = new@coords[,1], Y = new@coords[,2])\n\nmelt_s <- st_as_sf(melt_s,\n                coords = c(\"X\", \"Y\"),\n                crs = CRS_UTM_NY)\n\nggplot() +\n  geom_sf(data = sh_mundos, fill = \"gray90\", color = \"gray30\", linewidth = 0.5) +\n  geom_sf(\n    data = melt_s, \n    aes(col = Temperatura), \n    size = 3,          \n    alpha = 0.8 \n  ) +\n  scale_color_carto_c(palette = 'Prism', na.value = '#111111') +\n  labs(\n    title = \"28 de marzo de 2024 - 12:00:00\",\n    color = \"Temperatura\"\n  ) +\n  theme_light()+\n  theme(\n    plot.title = element_text(hjust = 0.5, face = \"bold\"))\n```\n\n::: {.cell-output-display}\n![](Geo_fun_files/figure-html/unnamed-chunk-28-1.png){width=672}\n:::\n:::\n\n\n\n\n\n:::\n\nEl Kriging Funcional muestra un patrón espacial de temperatura notablemente estable en California durante el mes de marzo. Las zonas más cálidas se concentran de forma consistente en el Valle Central y en las regiones interiores del sur, mientras que la franja costera y el norte del estado mantienen valores más templados. Las áreas con temperaturas relativamente más bajas parecen estar asociadas a efectos locales de altitud o microclimas, reflejando la influencia directa de la geografía en la distribución térmica al mediodía.\n\nLa similitud entre los mapas correspondientes a los días 1, 7, 14 y 28 de marzo constituye uno de los hallazgos principales del análisis. La persistencia de este patrón sugiere que no se presentaron eventos meteorológicos relevantes que modificaran de manera sustancial la estructura espacial de la temperatura durante el mes. En consecuencia, el modelo evidencia una alta estabilidad temporal en la distribución geográfica del calor a lo largo de marzo.\n\n##### Método de los Lambdas\n\n::: {.callout-caution appearance=\"simple\"}\n##### En desarrollo...\n:::\n\n## Conclusiones\n\n::: {.callout-caution appearance=\"simple\"}\n## En desarrollo...\n:::\n \n# Referencias {.unnumbered}\n",
    "supporting": [
      "Geo_fun_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}