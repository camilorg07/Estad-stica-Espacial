[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Estadística Espacial",
    "section": "",
    "text": "Contenido\nEn este documento tiene como objetivo ilustrar el recorrido de la implementación de la metodología y teoría vista durante el curso de Estadística Espacial. Se implementaran modelos de análisis geoestadístico univariados y bivariados, modelos de análisis espacio-temporar y de datos funcionales.\n\n\nReferencias\n\n\n\n\nBohorquez Castañeda, Martha Patricia. 2024. «Notas de clase: Estadística Espacial y Espacio-Temporal para Campos Aleatorios Escalares y Funcionales». https://sites.google.com/unal.edu.co/marthapatriciabohorquezcastaed/courses.\n\n\nUnited States Environmental Protection Agency (EPA). 2024. «AirNow: Air Quality Data». 2024. https://files.airnowtech.org/.",
    "crumbs": [
      "Contenido"
    ]
  },
  {
    "objectID": "Geo_uni.html",
    "href": "Geo_uni.html",
    "title": "1  Análisis Univariado",
    "section": "",
    "text": "1.1 Introducción\nLa calidad del aire es un factor clave para la salud pública, el bienestar social y la sostenibilidad ambiental, y California se destaca como uno de los estados más afectados de Estados Unidos por la contaminación atmosférica. La combinación de una alta densidad poblacional, una intensa actividad industrial y vehicular, junto con fenómenos naturales como los incendios forestales, ha hecho que varias de sus ciudades se ubiquen entre las más contaminadas del país. Al mismo tiempo, la temperatura cumple un papel fundamental en la dinámica atmosférica, ya que influye en la dispersión, concentración y formación de contaminantes, además de constituir en sí misma un aspecto crítico para comprender las condiciones ambientales regionales. Frente a este contexto, resulta necesario llevar a cabo un análisis geoespacial que considere tanto la calidad del aire como la temperatura en California, con el fin de identificar patrones espaciales, contrastes regionales y áreas críticas que permitan orientar acciones de mitigación y gestión ambiental.",
    "crumbs": [
      "Análisis Geoestadístico",
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Análisis Univariado</span>"
    ]
  },
  {
    "objectID": "Geo_uni.html#descripción",
    "href": "Geo_uni.html#descripción",
    "title": "1  Análisis Univariado",
    "section": "1.2 Descripción",
    "text": "1.2 Descripción\nLos datos objeto de este estudio provienen de la Agencia de Protección Ambiental (EPA) de los Estados Unidos y corresponden a registros horarios obtenidos de las estaciones de monitoreo durante el mes de marzo de 2024. En partícular, se analizan las variables Temperatura y Ozono (O_3).\n\n1.2.1 Unidades\n\nTemperatura: Medido en grados celsius (C°) con una intensidad horaria.\nOzono: Medido en partes por billón (ppb) con una intensidad horaria.\n\n\n\nVer código\n#Librerias necesarias ------------------------------------\n\nset.seed(123)\n\nlibrary(dplyr)\nlibrary(geoR)\nlibrary(sp)\nlibrary(readxl)\nlibrary(tidyr)\nlibrary(sf)\nlibrary(ggplot2)\nlibrary(knitr)\nlibrary(plotly)\nlibrary(leaflet)\nlibrary(raster)\nlibrary(stars)\nlibrary(terra)\n\n#Variale Temperatura --------------------------------------\n\nTemp &lt;- read_excel(\"GeoEst_Cali.xlsx\", sheet = \"Temperatura\")\ncolnames(Temp)[-1] &lt;- as.numeric(colnames(Temp)[-1])\nEstacionesT &lt;- read_excel(\"GeoEst_Cali.xlsx\", sheet = \"Estaciones\")\nEstacionesT &lt;- EstacionesT %&gt;% mutate(AQSID = as.numeric(AQSID))\nEstacionesT &lt;- EstacionesT %&gt;% filter(AQSID %in% colnames(Temp)[-1])\n\n#Variable Ozono ------------------------------------------\n\nOzono &lt;- read_excel(\"GeoEst_Cali.xlsx\", sheet = \"Ozono\")\ncolnames(Ozono)[-1] &lt;- as.numeric(colnames(Ozono)[-1])\nEstacionesOz &lt;- read_excel(\"GeoEst_Cali.xlsx\", sheet = \"Estaciones\")\nEstacionesOz &lt;- EstacionesOz %&gt;% mutate(AQSID = as.numeric(AQSID))\nEstacionesOz &lt;- EstacionesOz %&gt;% filter(AQSID %in% colnames(Ozono)[-1])\n\n#Variable velocidad del viento ----------------------------\n\nWS &lt;- read_excel(\"GeoEst_Cali.xlsx\", sheet = \"WindSpeed\")\ncolnames(WS)[-1] &lt;- as.numeric(colnames(WS)[-1])\nEstacionesWS &lt;- read_excel(\"GeoEst_Cali.xlsx\", sheet = \"Estaciones\")\nEstacionesWS &lt;- EstacionesWS %&gt;% mutate(AQSID = as.numeric(AQSID))\nEstacionesWS &lt;- EstacionesWS %&gt;% filter(AQSID %in% colnames(WS)[-1])\n\n#Variable presión atmosférica -----------------------------\n\nPresion &lt;- read_excel(\"GeoEst_Cali.xlsx\", sheet = \"Presion\")\ncolnames(Presion)[-1] &lt;- as.numeric(colnames(Presion)[-1])\nEstacionesPr &lt;- read_excel(\"GeoEst_Cali.xlsx\", sheet = \"Estaciones\")\nEstacionesPr &lt;- EstacionesPr %&gt;% mutate(AQSID = as.numeric(AQSID))\nEstacionesPr &lt;- EstacionesPr %&gt;% filter(AQSID %in% colnames(Presion)[-1])\n\n\n#Para el mapa de California -------------------------------\n\nsh_mundos&lt;-st_read(\"admin00.shp\",quiet=TRUE)\nsh_mundos &lt;- sh_mundos %&gt;% filter(CNTRY_NAME==\"United States\")\nsh_mundos &lt;- sh_mundos %&gt;% filter(ADMIN_NAME==\"California\")\n\nCRS_UTM_NY = \"+init=epsg:3310\"\n\nsh_mundos_wgs84 &lt;- st_transform(sh_mundos, crs = 4326)\n\nsh_mundos_utm &lt;- st_transform(sh_mundos, crs = CRS(\"EPSG:3310\"))\n\nsh_mundos_sp_utm &lt;- as(sh_mundos_utm, \"Spatial\")\n\nsh_mundos_utm_simple &lt;- st_union(sh_mundos_utm)\nsh_mundos_sp_utm_simple &lt;- as(sh_mundos_utm_simple, \"Spatial\")\n\n#Grilla para hacer kriging ------------------------------\n\nnew &lt;- sp::spsample(as(sh_mundos_utm, \"Spatial\"), n = 50000, type = \"regular\")\n\nproj4string(new) &lt;- CRS(\"EPSG:3310\")\ninvisible(coordinates(new) ~ Este + Norte)\ncolnames(new@coords) &lt;- c(\"Este\", \"Norte\")\n\n#Gráficos de dispersión ----------------------------------\n\nsimple_scatter_plot &lt;- function(datos, variable1, variable2) {\n\n    plot1 &lt;- ggplot(as.data.frame(datos),\n                    aes(x = .data[[variable1]], y = .data[[variable2]],\n                               color = as.factor(1))) +\n                    geom_point() +\n                    scale_colour_viridis_d() +\n                    labs(\n                        x = variable1,\n                        y = variable2\n                        ) +\n                    theme_light() +\n                    theme(legend.position = \"none\")\n\n    return(plot1)\n\n}",
    "crumbs": [
      "Análisis Geoestadístico",
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Análisis Univariado</span>"
    ]
  },
  {
    "objectID": "Geo_uni.html#análisis-geoestadístico-univariado",
    "href": "Geo_uni.html#análisis-geoestadístico-univariado",
    "title": "1  Análisis Univariado",
    "section": "1.3 Análisis geoestadístico univariado",
    "text": "1.3 Análisis geoestadístico univariado\n\n1.3.1 Variable Ozono\nSe tomaron los datos de Temperatura de la madrugada el primero de marzo de 2024:\n\n\nVer código\ny_oz &lt;- Ozono[1,] #Tomar una fecha\ny_oz &lt;- cbind(colnames(y_oz),t(y_oz[1,]))\ny_oz &lt;- y_oz[-1,]\ny_oz &lt;- as.data.frame(y_oz)\ny_oz &lt;- na.omit(y_oz)\ny_oz$V1 &lt;- as.numeric(y_oz$V1)\ny_oz &lt;- inner_join(y_oz, EstacionesOz, by=c(\"V1\"=\"AQSID\"))\ndatosOZ &lt;- y_oz[,c(13,14,2)] #DatosOz es la base con coordenadas + variable\ncolnames(datosOZ)=c(\"Este\",\"Norte\",\"Ozono\")\ndatosOZ$Ozono &lt;- as.numeric(datosOZ$Ozono)\n\ndatosOZ_sf &lt;- st_as_sf(datosOZ, coords = c(\"Este\", \"Norte\"), crs = 3310)\n\ndatosO_sf_wgs84 &lt;- st_transform(datosOZ_sf, crs = 4326)\n\npalO &lt;- colorNumeric(palette = \"viridis\", domain = datosO_sf_wgs84$Ozono)\n\nleaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addPolygons(data = sh_mundos_wgs84, fill = FALSE, color = \"black\", weight = 2) %&gt;%\n  addCircleMarkers(data = datosO_sf_wgs84,\n                   fillColor = ~palO(Ozono),\n                   fillOpacity = 0.8,\n                   color = \"black\",\n                   weight = 1,\n                   radius = 6,\n                   popup = ~paste(\"Ozono:\", Ozono, \"°C\")) %&gt;%\n  addLegend(pal = palO, values = datosO_sf_wgs84$Ozono, title = \"Ozono (ppb)\")\n\n\n\n\n\n\nVer código\nozone &lt;- as.geodata(datosOZ) \npander::pander(summary(ozone))\n\n\n\nn: 139\ncoords.summary:\n\n\n\n\n\n\n\n\n \nEste\nNorte\n\n\n\n\nmin\n-276541\n-598934\n\n\nmax\n500862\n415184\n\n\n\ndistances.summary:\n\n\n\n\n\n\n\nmin\nmax\n\n\n\n\n6305\n1187480\n\n\n\ndata.summary:\n\n\n\n\n\n\n\n\n\n\n\nMin.\n1st Qu.\nMedian\nMean\n3rd Qu.\nMax.\n\n\n\n\n20\n35\n38\n37.48\n40.5\n53\n\n\n\n\n\n\n\n\nGráficos de dispersiónGeoR\n\n\n\n\nVer código\npO1 &lt;- simple_scatter_plot(datosOZ, \"Este\", \"Ozono\")\npO2 &lt;- simple_scatter_plot(datosOZ, \"Norte\", \"Ozono\")\n\ncowplot::plot_grid(pO1,pO2)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(ozone, qt.col = c(\"purple\",\n                          \"pink\",\n                          \"green\",\n                          \"yellow\"),\n     scatter3d=T)\n\n\n\n\n\n\n\n\n\n\n\n\nEl gráfico muestra una relación polinomial de la variable Ozono con respecto a las coordenadas en Norte. Se prueba con varios modelos hasta encontrar aquel que mitigue el efecto espacial.\n\n1.3.1.1 Modelo de tendencia espacial\nEl modelo que mejor atrapa el efecto de la media es:\nOzono = \\beta_0+\\beta_1 \\times Norte^2 + \\beta_2 \\times Norte^3 + \\beta_3 \\times Este\n\n\nVer código\nfitO &lt;- lm(Ozono~I(Norte^2)+I(Norte^3)+Este, data = datosOZ) \npander::pander(summary(fitO))\n\n\n\n\n\n\n\n\n\n\n\n\n \nEstimate\nStd. Error\nt value\nPr(&gt;|t|)\n\n\n\n\n(Intercept)\n34.99\n0.6033\n58\n2.656e-97\n\n\nI(Norte^2)\n5.085e-11\n1.078e-11\n4.716\n5.931e-06\n\n\nI(Norte^3)\n7.94e-17\n1.922e-17\n4.131\n6.297e-05\n\n\nEste\n1.416e-05\n3.326e-06\n4.257\n3.855e-05\n\n\n\n\nFitting linear model: Ozono ~ I(Norte^2) + I(Norte^3) + Este\n\n\n\n\n\n\n\n\nObservations\nResidual Std. Error\nR^2\nAdjusted R^2\n\n\n\n\n139\n3.984\n0.4223\n0.4094\n\n\n\n\n\nGráficamente se observa una mitigación en la tendencia espacial:\n\nGráficos de dispersiónGeoR\n\n\n\n\nVer código\ndatosOZ$Residuos &lt;- fitO$residuals\n\npO1 &lt;- simple_scatter_plot(datosOZ, \"Este\", \"Residuos\")\npO2 &lt;- simple_scatter_plot(datosOZ, \"Norte\", \"Residuos\")\n\ncowplot::plot_grid(pO1,pO2)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(ozone, qt.col = c(\"purple\",\n                          \"pink\",\n                          \"green\",\n                          \"yellow\"),\n     scatter3d=T, trend = ~ poly(Norte,3))\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.1.2 Estimación empírica del semivariograma\nA continuación, se presenta la estimación del semivariograma obtenida con la función variog. Se muestran dos gráficos comparativos: el primero corresponde a los datos originales (sin eliminar la tendencia) y el segundo a los residuales obtenidos tras ajustar el modelo de regresión, lo que permite observar el efecto de remover la tendencia en la estructura espacial.\n\n\nVer código\nvg_O &lt;- variog(ozone,estimator.type = \"modulus\", pairs.min=50) #Sin tendencia espacial\n\nvg1_O &lt;- variog(ozone, trend = ~I(Norte^2)+I(Norte^3)+Este, estimator.type = \"modulus\", pairs.min=50)\n\n\n\nCon tendenciaRemoviendo Tendencia\n\n\n\n\nVer código\nplot(vg_O,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Sin remover tendencia\",\n     col.main = 4, cex.main =1.3)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(vg1_O,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Removiendo tendencia\",\n     col.main = 4, cex.main =1.3)\n\n\n\n\n\n\n\n\n\n\n\n\nSe observa que la estimación de la semivarianza de la variable incrementos es más estable y presenta valores más bajos al remover la tendencia, lo que indica que en este caso el semivariograma refleja de manera más adecuada la verdadera estructura espacial del fenómeno.\n\n\nVer código\nplot(vg1_O$u, vg1_O$n, type=\"b\",\n     xlab=\"distance\", ylab=\"n pairs\",\n     main=\"Número de pares por bin\")\n\n\n\n\n\n\n\n\n\n\n\n1.3.1.3 Estimación del Modelo Teórico de Semivariograma\nLos modelos obtenidos ajustanto por EyeFit, son:\ncov.model sigmasq      phi tausq kappa kappa2 practicalRange\n1    matern    17.0 440676.0     5   0.5     NA        1320147\n2  gneiting    17.5 803585.6     9    NA     NA        1371348\n3    linear    0.25 0.32     0    NA     NA            Inf\n\nMaternGneitingExponencialEsféricoCúbico\n\n\n\n\nVer código\nsigma_0_mO &lt;- 12.0\nphi_0_mO &lt;- 224249.7\nnugget_0_mO &lt;- 2.00 \nkappa_0_mO &lt;- 0.2\n\nini1_mat_O &lt;- c(sigma_0_mO, phi_0_mO)\nfitvar1_mat_O &lt;- variofit(vg1_O,\n                    cov.model = \"matern\",\n                    ini1_mat_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_mO,\n                    kappa = kappa_0_mO,\n                    wei = \"equal\")\n\nfitvar2_mat_O &lt;- variofit(vg1_O,\n                    cov.model = \"matern\",\n                    ini1_mat_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_mO,\n                    kappa = kappa_0_mO,\n                    wei = \"npairs\")\n\nfitvar3_mat_O &lt;- variofit(vg1_O,\n                    cov.model = \"matern\",\n                    ini1_mat_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_mO,\n                    kappa = kappa_0_mO,\n                    wei = \"cressie\")\n\nfitvar4_mat_O &lt;- likfit(ozone,\n                  coords = ozone$coords,\n                  data = ozone$data,\n                  trend = ~ I(Norte^2) + I(Norte^3) + Este,\n                  ini.cov.pars = ini1_mat_O,\n                  fix.nugget = F,\n                  nugget = nugget_0_mO,\n                  kappa = kappa_0_mO,\n                  cov.model = \"matern\",\n                  lik.method = \"ML\")\n\n\nplot(vg1_O,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar1_mat_O, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_mat_O, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_mat_O, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_mat_O, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nsigma_0_gO &lt;- 17.5\nphi_0_gO &lt;- 803585.6\nnugget_0_gO &lt;- 9\n\nini1_g_O &lt;- c(sigma_0_gO, phi_0_gO)\nfitvar1_g_O &lt;- variofit(vg1_O,\n                    cov.model = \"gneiting\",\n                    ini1_g_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_gO,\n                    wei = \"equal\")\n\nfitvar2_g_O &lt;- variofit(vg1_O,\n                    cov.model = \"gneiting\",\n                    ini1_g_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_gO,\n                    wei = \"npairs\")\n\nfitvar3_g_O &lt;- variofit(vg1_O,\n                    cov.model = \"gneiting\",\n                    ini1_g_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_gO,\n                    wei = \"cressie\")\n\nfitvar4_g_O &lt;- likfit(ozone,\n                  coords = ozone$coords,\n                  data = ozone$data,\n                  trend = ~ I(Norte^2) + I(Norte^3) + Este,\n                  ini.cov.pars = ini1_g_O,\n                  fix.nugget = F,\n                  nugget = nugget_0_gO,\n                  cov.model = \"gneiting\",\n                  lik.method = \"ML\")\n\n\nplot(vg1_O,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar1_g_O, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_g_O, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_g_O, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_g_O, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nsigma_0_lO &lt;- 10\nphi_0_lO &lt;- 6e5\nnugget_0_lO &lt;- 10\n\nini1_l_O &lt;- c(sigma_0_lO, phi_0_lO)\nfitvar1_l_O &lt;- variofit(vg1_O,\n                    cov.model = \"exponential\",\n                    ini1_l_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_lO,\n                    wei = \"equal\")\n\nfitvar2_l_O &lt;- variofit(vg1_O,\n                    cov.model = \"exponential\",\n                    ini1_l_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_lO,\n                    wei = \"npairs\")\n\nfitvar3_l_O &lt;- variofit(vg1_O,\n                    cov.model = \"exponential\",\n                    ini1_l_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_lO,\n                    wei = \"cressie\")\n\nfitvar4_l_O &lt;- likfit(ozone,\n                  coords = ozone$coords,\n                  data = ozone$data,\n                  trend = ~ I(Norte^2) + I(Norte^3) + Este,\n                  ini.cov.pars = ini1_l_O,\n                  fix.nugget = F,\n                  nugget = nugget_0_lO,\n                  cov.model = \"exponential\",\n                  lik.method = \"ML\")\n\n\nplot(vg1_O,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar1_l_O, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_l_O, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_l_O, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_l_O, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nsigma_0_lO &lt;- 10\nphi_0_lO &lt;- 6e5\nnugget_0_lO &lt;- 10\n\nini1_l_O &lt;- c(sigma_0_lO, phi_0_lO)\nfitvar1_es_O &lt;- variofit(vg1_O,\n                    cov.model = \"spherical\",\n                    ini1_l_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_lO,\n                    wei = \"equal\")\n\nfitvar2_es_O &lt;- variofit(vg1_O,\n                    cov.model = \"spherical\",\n                    ini1_l_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_lO,\n                    wei = \"npairs\")\n\nfitvar3_es_O &lt;- variofit(vg1_O,\n                    cov.model = \"spherical\",\n                    ini1_l_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_lO,\n                    wei = \"cressie\")\n\nfitvar4_es_O &lt;- likfit(ozone,\n                  coords = ozone$coords,\n                  data = ozone$data,\n                  trend = ~ I(Norte^2) + I(Norte^3) + Este,\n                  ini.cov.pars = ini1_l_O,\n                  fix.nugget = F,\n                  nugget = nugget_0_lO,\n                  cov.model = \"spherical\",\n                  lik.method = \"ML\")\n\n\nplot(vg1_O,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar1_es_O, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_es_O, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_es_O, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_es_O, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nsigma_0_lO &lt;- 10\nphi_0_lO &lt;- 6e5\nnugget_0_lO &lt;- 10\n\nini1_l_O &lt;- c(sigma_0_lO, phi_0_lO)\nfitvar1_c_O &lt;- variofit(vg1_O,\n                    cov.model = \"cubic\",\n                    ini1_l_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_lO,\n                    wei = \"equal\")\n\nfitvar2_c_O &lt;- variofit(vg1_O,\n                    cov.model = \"cubic\",\n                    ini1_l_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_lO,\n                    wei = \"npairs\")\n\nfitvar3_c_O &lt;- variofit(vg1_O,\n                    cov.model = \"cubic\",\n                    ini1_l_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_lO,\n                    wei = \"cressie\")\n\nfitvar4_c_O &lt;- likfit(ozone,\n                  coords = ozone$coords,\n                  data = ozone$data,\n                  trend = ~ I(Norte^2) + I(Norte^3) + Este,\n                  ini.cov.pars = ini1_l_O,\n                  fix.nugget = F,\n                  nugget = nugget_0_lO,\n                  cov.model = \"cubic\",\n                  lik.method = \"ML\")\n\n\nplot(vg1_O,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar1_c_O, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_c_O, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_c_O, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_c_O, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.1.4 Kriging\nUsando el modelo exponencial:\n\n\nVer código\nplot(vg1_O,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Modelo exponencial para Ozono\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar3_l_O, col=\"#008B00\", lwd=1.5)\n\n\n\n\n\n\n\n\n\n\n\nVer código\n#Se ajusta el mejor modelo -------------------------------\n\nbest_model_O &lt;- gstat::vgm(psill = fitvar3_l_O$cov.pars[1],\n                           model = \"Exp\",\n                           range = fitvar3_l_O$cov.pars[2],\n                           nugget = fitvar3_l_O$nugget\n                           \n)\n\n# Se crea un objeto en gstat ------------------------------\n\ncoordinates(datosOZ) &lt;- ~Este + Norte\nproj4string(datosOZ) &lt;- CRS(\"EPSG:3310\")\n\ng_obj&lt;-gstat::gstat(id=\"Ozono\",\n             formula = Ozono ~ I(Norte^2) + I(Norte^3) + Este,\n             model = best_model_O,\n             data = datosOZ)\n\n#Kriging ------------------------------------------------\n\ninvisible(predic &lt;- predict(g_obj, newdata = new, nmin = 12, maxdist=fitvar3_es_O$cov.pars[2]))\n\n\n#Mapas de predicción -------------------------------------\n\ngridded(predic) &lt;- TRUE\n\n#1. Mapa de Kriging --------------------------------------\n\npredic_raster_utm &lt;- raster(predic, layer = \"Ozono.pred\")\n\ncrs(predic_raster_utm) &lt;- \"+init=epsg:3310\"\n\npredic_raster_wgs84 &lt;- raster::projectRaster(\n    raster::mask(\n        predic_raster_utm, \n        sh_mundos_sp_utm_simple\n    ),\n    crs = \"+init=epsg:4326\", \n    method = \"bilinear\"\n)\n\nbins &lt;- seq(15,55, by=5)\n\npred_range &lt;- c(minValue(predic_raster_wgs84), maxValue(predic_raster_wgs84))\npal_pred &lt;- colorBin(\n  palette = \"viridis\", # La paleta de colores\n  domain = pred_range,\n  bins = bins,\n  na.color = \"transparent\"\n)\n\nmapa_kriging_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    predic_raster_wgs84, \n    colors = pal_pred, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n    addCircleMarkers(data = datosO_sf_wgs84,\n                   fillColor = ~palO(Ozono),\n                   fillOpacity = 0.8,\n                   color = \"black\",\n                   weight = 1,\n                   radius = 6,\n                   popup = ~paste(\"Ozn:\", Ozono, \"ppb\")) %&gt;% \n  \n  addLegend(\n    pal = pal_pred, \n    values = pred_range,\n    title = \"Predicción Oz ppb\",\n    position = \"topright\"\n  ) %&gt;%\n  \n  addLegend(pal = palO,\n            values = datosO_sf_wgs84$Ozono,\n            title = \"Ozono Observado\",\n    position = \"topleft\"\n  ) \n\n#2 Mapa Varianza------------------------------------------\n\nvar_raster_utm &lt;- raster(predic, layer = \"Ozono.var\")\n\ncrs(var_raster_utm) &lt;- \"+init=epsg:3310\"\n\nvar_raster_wgs84 &lt;- raster::projectRaster(\n    raster::mask(\n        var_raster_utm, \n        sh_mundos_sp_utm_simple\n    ),\n    crs = \"+init=epsg:4326\", \n    method = \"bilinear\"\n)\n\nbinsv &lt;- seq(0,30, by=5)\n\nvar_range &lt;- c(minValue(var_raster_wgs84), maxValue(var_raster_wgs84))\npal_var &lt;- colorBin(\n  palette = \"Spectral\", # La paleta de colores\n  domain = var_range,\n  bins = binsv,\n  na.color = \"transparent\"\n)\n\nmapa_var_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    var_raster_wgs84,\n    colors = pal_var, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n  addLegend(\n    pal = pal_var, \n    values = var_range,\n    title = \"Varianza\",\n    position = \"topright\"\n  ) \n\n#3. Mapa Cv ----------------------------------------------\n\ncv_raster_utm &lt;- sqrt(var_raster_utm) / abs(predic_raster_utm)\n\nmapa_mayor_a_uno &lt;- cv_raster_utm &gt; 1\ncv_raster_utm[mapa_mayor_a_uno] &lt;- 1\n\ncrs(cv_raster_utm) &lt;- \"+init=epsg:3310\"\n\ncv_raster_masked_utm &lt;- raster::mask(cv_raster_utm, sh_mundos_sp_utm_simple)\n\ncv_raster_cropped_utm &lt;- raster::crop(cv_raster_masked_utm, sh_mundos_sp_utm_simple)\n\ncv_raster_wgs84 &lt;- raster::projectRaster(\n    cv_raster_cropped_utm, \n    crs = \"+init=epsg:4326\", \n    method = \"bilinear\"\n)\n\nbincv &lt;- seq(0,1, by=.1)\n\ncv_range &lt;- c(minValue(cv_raster_wgs84), maxValue(cv_raster_wgs84))\n\npal_cv &lt;- colorBin(\n  palette = \"RdYlGn\", # Rojo-Amarillo-Verde\n  domain = cv_range,\n  na.color = \"transparent\",\n  bins = bincv,\n  reverse = TRUE\n)\n\nmapa_cv_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    cv_raster_wgs84,\n    colors = pal_cv, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n  addLegend(\n    pal = pal_cv, \n    values = cv_range,\n    title = \"Coeficiente de Variación\",\n    position = \"topright\"\n  )\n\n\n\nPredicciónVarianzaCoeficiente de variación\n\n\n\n\nVer código\nmapa_kriging_leaflet\n\n\n\n\n\n\n\n\n\n\nVer código\nmapa_var_leaflet\n\n\n\n\n\n\n\n\n\n\nVer código\nmapa_cv_leaflet\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.2 Variable Temperatura\nSe tomaron los datos de Temperatura de la madrugada el primero de marzo de 2024:\n\n\nVer código\ny_T &lt;- Temp[1,] #Tomar una fecha\ny_T &lt;- cbind(colnames(y_T),t(y_T[1,]))\ny_T &lt;- y_T[-1,]\ny_T &lt;- as.data.frame(y_T)\ny_T &lt;- na.omit(y_T)\ny_T &lt;- y_T[-which.min(y_T$V2),]\ny_T$V1 &lt;- as.numeric(y_T$V1)\ny_T &lt;- inner_join(y_T, EstacionesT, by=c(\"V1\"=\"AQSID\"))\ndatosT &lt;- y_T[,c(13,14,2)]\ncolnames(datosT)=c(\"Este\",\"Norte\",\"Temperatura\")\ndatosT$Temperatura &lt;- as.numeric(datosT$Temperatura)\n\ndatosT_sf &lt;- st_as_sf(datosT, coords = c(\"Este\", \"Norte\"), crs = 3310)\n\ndatosT_sf_wgs84 &lt;- st_transform(datosT_sf, crs = 4326)\n\npal &lt;- colorNumeric(palette = \"viridis\", domain = datosT_sf_wgs84$Temperatura)\n\nleaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addPolygons(data = sh_mundos_wgs84, fill = FALSE, color = \"black\", weight = 2) %&gt;%\n  addCircleMarkers(data = datosT_sf_wgs84,\n                   fillColor = ~pal(Temperatura),\n                   fillOpacity = 0.8,\n                   color = \"black\",\n                   weight = 1,\n                   radius = 6,\n                   popup = ~paste(\"Temp:\", Temperatura, \"°C\")) %&gt;%\n  addLegend(pal = pal, values = datosT_sf_wgs84$Temperatura, title = \"Temperatura (°C)\")\n\n\n\n\n\n\nVer código\ntemp &lt;- as.geodata(datosT) \npander::pander(summary(temp))\n\n\n\nn: 122\ncoords.summary:\n\n\n\n\n\n\n\n\n \nEste\nNorte\n\n\n\n\nmin\n-325701\n-580919\n\n\nmax\n387270\n281577\n\n\n\ndistances.summary:\n\n\n\n\n\n\n\nmin\nmax\n\n\n\n\n609.2\n1e+06\n\n\n\ndata.summary:\n\n\n\n\n\n\n\n\n\n\n\nMin.\n1st Qu.\nMedian\nMean\n3rd Qu.\nMax.\n\n\n\n\n-3.2\n13.15\n15.8\n14.43\n17.2\n24.5\n\n\n\n\n\n\n\n\nGráficos de dispersiónGeoR\n\n\n\n\nVer código\npT1 &lt;- simple_scatter_plot(datosT, \"Este\", \"Temperatura\")\npT2 &lt;- simple_scatter_plot(datosT, \"Norte\", \"Temperatura\")\n\ncowplot::plot_grid(pT1,pT2)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(temp, qt.col = c(\"purple\",\n                    \"pink\",\n                    \"green\",\n                    \"yellow\"),\n     scatter3d=T)\n\n\n\n\n\n\n\n\n\n\n\n\nEn el gráfico se observa un agrupamiento en las coordenadas Norte con respecto a los datos, que puede llegar a corregirse con algún polinomio. Se probará con diferentes modelos a ver si se puede llegar a disminuir el efecto espacial.\n\n1.3.2.1 Modelo de tendencia espacial\nEl modelo que mejor atrapa el efecto de la media es:\n\nTemperatura = \\beta_0 + \\beta_1 \\times Norte + \\beta_2 \\times Norte^2\n\n\n\nVer código\nfitT &lt;- lm(Temperatura~Norte+I(Norte^2), data = datosT) \npander::pander(summary(fitT))\n\n\n\n\n\n\n\n\n\n\n\n\n \nEstimate\nStd. Error\nt value\nPr(&gt;|t|)\n\n\n\n\n(Intercept)\n13.26\n0.5352\n24.77\n8.812e-49\n\n\nNorte\n-2.229e-05\n3.23e-06\n-6.901\n2.676e-10\n\n\nI(Norte^2)\n-3.754e-11\n8.551e-12\n-4.39\n2.469e-05\n\n\n\n\nFitting linear model: Temperatura ~ Norte + I(Norte^2)\n\n\n\n\n\n\n\n\nObservations\nResidual Std. Error\nR^2\nAdjusted R^2\n\n\n\n\n122\n4.049\n0.3199\n0.3084\n\n\n\n\n\nObservamos el comportamiento de sus residuales podemos notar que el modelo ayudo a reducir el efecto espacial.\n\nGráficos de dispersiónGeoR\n\n\n\n\nVer código\ndatosT$Residuos &lt;- fitT$residuals\n\npT1 &lt;- simple_scatter_plot(datosT, \"Este\", \"Residuos\")\npT2 &lt;- simple_scatter_plot(datosT, \"Norte\", \"Residuos\")\n\ncowplot::plot_grid(pT1,pT2)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(temp, qt.col = c(\"purple\",\n                    \"pink\",\n                    \"green\",\n                    \"yellow\"),\n     scatter3d=T, trend=~Norte+I(Norte^2))\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.2.2 Estimación empírica del semivariograma\np¿Presentamos la estimación del semivariograma obtenida mediante la función variog para la variable temperatura. Se comparan los resultados al calcularlo directamente sobre los datos originales (sin remover la tendencia) y al utilizar los residuales de un modelo de regresión, con el objetivo de analizar cómo influye la presencia de tendencia en la estructura espacial.\n\n\nVer código\nvg_T &lt;- variog(temp, estimator.type = \"modulus\", pairs.min=50) #Sin tendencia espacial\n\nvg1_T &lt;- variog(temp, trend = ~Norte+I(Norte^2),\n                estimator.type = \"modulus\", pairs.min=50)\n\n\n\nCon tendenciaRemoviendo tendencia\n\n\n\n\nVer código\nplot(vg_T,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Sin remover tendencia\",\n     col.main = 4, cex.main =1.3)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(vg1_T,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Removiendo tendencia\",\n     col.main = 4, cex.main =1.3)\n\n\n\n\n\n\n\n\n\n\n\n\nCuando no se remueve la tendencia, la semivarianza alcanza valores más altos y presenta una forma aparentemente más regular, aunque dicha regularidad está influenciada por la tendencia global de los datos. En cambio, al eliminar la tendencia, los valores de semivarianza disminuyen y el patrón pierde suavidad, pero el variograma refleja con mayor fidelidad la verdadera dependencia espacial.\n\n\nVer código\nplot(vg1_T$u, vg1_T$n, type=\"b\",\n     xlab=\"distance\", ylab=\"n pairs\",\n     main=\"Número de pares por bin\")\n\n\n\n\n\n\n\n\n\nEn este caso, el último punto corresponde a menos de 25 pares de observaciones, por lo que su interpretación resulta menos confiable.\n\n\n1.3.2.3 Estimación del Modelo Teórico de Semivariograma\n\n\nVer código\ndist_matrix_T &lt;- as.matrix(dist(temp$coords))\n\n#1. Funciones de correlación, covarianza y semivarianza: ----\n\n#1.1 Modelo exponencial ----\n\nrho_exp &lt;- function(h, phi){\n  exp(-(h/phi)) #Correlacion espacial\n}\n\ncov_exp &lt;- function(sigma, h, phi){\n  sigma*rho_exp(h, phi) #Covarianza espacial\n}\n\nsv_exp &lt;- function(nugget, sigma, h, phi){\n  nugget + sigma - cov_exp(sigma, h, phi) #Semivarianza espacial\n} \n\n#1.2 Modelo Gaussianio ----\n\nrho_gauss &lt;- function(h, phi){\n  exp(-(h/phi)^2)\n}\n\ncov_gauss &lt;- function(sigma, h, phi){\n  sigma*rho_gauss(h, phi) #Covarianza espacial\n}\n\nsv_gauss &lt;- function(nugget, sigma, h, phi){\n  nugget + sigma - cov_gauss(sigma, h, phi) #Semivarianza espacial\n}\n#1.3 Modelo Gneting ----\n\ncov_gneiting &lt;- function(h){\n  s &lt;- 0.301187465825\n  ifelse(0&lt;= s*h &  s*h &lt;= 1,\n  (1 + 8*s*h + 25*(s*h)^2 + 32*(s*h)^3) * (1-s*h)^8,\n  0)\n}\n\nsv_gneiting &lt;- function(nugget, sigma, h){\n  nugget + sigma - cov_gneiting(h) #Semivarianza espacial\n}\n\n#1.4 Modelo Spherical ----\n\nrho_spherical &lt;- function(h, phi){\n  ifelse(h&lt;phi,\n         1 - 1.5*(h/phi) + 0.5*(h/phi)^3,\n         0)\n}\n\ncov_spherical &lt;- function(sigma, h, phi){\n  sigma*rho_spherical(h, phi) #Covarianza espacial\n}\n\nsv_spherical &lt;- function(nugget, sigma, h, phi){\n  nugget + sigma - cov_spherical(sigma, h, phi) #Semivarianza espacial\n}\n\n#1.5 Modelo Matern ----\n\nrho_matern &lt;- function(h, phi, kappa){\n  (1/(2*gamma(kappa))) * (h/phi)^kappa * besselK((h/phi), kappa)\n}\n\ncov_matern &lt;- function(sigma, h, phi, kappa){\n  sigma*rho_matern(h, phi, kappa) #Covarianza espacial\n}\n\nsv_matern &lt;- function(nugget, sigma, h, phi, kappa){\n  nugget + sigma - cov_matern(sigma, h, phi, kappa) #Semivarianza espacial\n}\n\n#1.6 Modelo Coseno -----------------\n\ncov_cos &lt;- function(sigma, h, phi){\n  sigma * cos(h/phi)\n}\n\ncos_sv &lt;- function(nugget, sigma, h, phi){\n  nugget +  sigma *(1 - cos(h/phi))\n}\n\n#1.7 Modelo wave ------\n\n\nrho_wave &lt;- function(h, sigma, phi){\n  ifelse(h == 0,\n         1,\n         (phi / h) * sin(h / phi))\n}\n\nsv_wave &lt;- function(nugget, sigma, h, phi) {\n  ifelse(h == 0,\n         nugget,\n         nugget + sigma - sigma * (phi / h) * sin(h / phi))\n}\n\ncov_wave &lt;- function(h, sigma, phi, nugget) {\n  ifelse(h == 0,\n         sigma,\n         sigma * (phi / h) * sin(h / phi))\n}\n\n\n#2. Función para estimar por WLS----\n\nMSE_ponderados &lt;- function(par, h, gamma,kappa=NA,w, model, n, pesos){\n  nugget &lt;- par[1]\n  sigma &lt;- par[2]\n  phi &lt;- par[3]\n  \n  gamma_hat &lt;- switch(model,\n                      \"exponencial\" = sv_exp(nugget, sigma, h, phi),\n                      \"gaussian\"    = sv_gauss(nugget, sigma, h, phi),\n                      \"gneiting\"    = sv_gneiting(nugget, sigma, h, phi),\n                      \"spherical\"   = sv_spherical(nugget, sigma, h, phi),\n                      \"matern\"      = sv_matern(nugget, sigma, h, phi, kappa),\n                      \"cos\"         = cos_sv(nugget, sigma, h, phi)\n  )\n  \n  w &lt;- switch(pesos,\n              \"Cressie\" = 1/(2*(2*gamma_hat)^2/n),\n              \"n\" = 1/n,\n              \"h/n\" = 1/(h/n),\n              \"I\" = 1)\n  \n  sum(w*(gamma - gamma_hat)^2)\n}\n\n\nest_sev_WLS &lt;- function(par, kappa = NA, model, h, gamma, n){\n  sigma_0 &lt;- par[1]\n  phi_0 &lt;- par[2]\n  nugget_0 &lt;- par[3]\n  kappa_0 &lt;- kappa\n  \n  # Selección de función\n  sv &lt;- switch(model,\n               \"exponencial\" = sv_exp,\n               \"gaussian\"    = sv_gauss,\n               \"spherical\"   = sv_spherical,\n               \"gneiting\"    = sv_gneiting,\n               \"matern\"      = sv_matern,\n               \"cos\" = cos_sv\n  )\n  \n  args_sv &lt;- names(formals(sv))\n  \n  args_list &lt;- list(\n    nugget = nugget_0,\n    sigma  = sigma_0,\n    h      = h,\n    phi    = phi_0,\n    kappa  = kappa_0\n  )\n  \n  args_list &lt;- args_list[names(args_list) %in% args_sv]\n  \n  sv_ini &lt;- do.call(sv, args_list)\n  \n  formula_sv &lt;- switch(model,\n                       \"gneiting\" = gamma ~ sv(nugget, sigma, h),\n                       \"matern\" = gamma ~ sv(nugget, sigma, h, phi, kappa),\n                       gamma ~ sv(nugget, sigma, h, phi)\n  )\n  \n  start_list &lt;- switch(model,\n                       \"gneting\" = list(nugget = nugget_0, sigma = sigma_0),\n                       \"matern\" = list(nugget = nugget_0, sigma = sigma_0, phi = phi_0, kappa = kappa_0),\n                       list(nugget = nugget_0, sigma = sigma_0, phi = phi_0)\n  )\n    \n    #1. Ponderación de Bessel\n    \n    WW &lt;- (2*(2*sv_ini)^2/n)\n    \n    Bessel &lt;- nls(formula = formula_sv,\n                  start = start_list,\n                  weights = 1/WW,\n                  lower = c(0, rep(1e-6, length(start_list)-1)),\n                  control = nls.control(maxiter = 500, warnOnly = TRUE))\n    \n    ini_Bessel&lt;-coef(Bessel)\n    \n    #1.1 Optim Bessel\n    \n    optim_bessel &lt;- optim(\n      par = coef(Bessel),\n      fn = MSE_ponderados,\n      h = h,\n      gamma = gamma,\n      pesos = \"Cressie\",\n      model = model,\n      n = n,\n      method = \"L-BFGS-B\",\n      lower = c(0, rep(1e-6, length(start_list)-1))\n    )\n    \n    par_optim_Bess &lt;- optim_bessel$par[c(\"nugget\", \"sigma\", \"phi\")]\n    \n    #2. Ponderación 1/n\n    \n    W1 &lt;- n\n    \n    n_pond &lt;- nls(formula = formula_sv,\n                  start = start_list,\n                  weights = 1/W1,\n                  lower = c(0, rep(1e-6, length(start_list)-1)),\n                  control = nls.control(maxiter = 500, warnOnly = TRUE))\n    \n    ini_n&lt;-coef(n_pond)\n    \n    #2.1 Optimización 1/n\n    \n    optim_n &lt;- optim(\n      par = coef(n_pond),\n      fn = MSE_ponderados,\n      h = h,\n      gamma = gamma,\n      pesos = \"n\",\n      n = n,\n      model = model,\n      method = \"L-BFGS-B\",\n      lower = c(0, rep(1e-6, length(start_list)-1))\n    )    \n    \n    par_optim_n &lt;- optim_n$par[c(\"nugget\", \"sigma\", \"phi\")]\n    \n    \n    #3. Ponderación h/n\n    \n    W2 &lt;- h/n\n    \n    h_n_pond &lt;- nls(formula = formula_sv,\n                    start = start_list,\n                    weights = 1/W2,\n                    lower = c(0, rep(1e-6, length(start_list)-1)),\n                    control = nls.control(maxiter = 500, warnOnly = TRUE))\n    \n    ini_h_n&lt;-coef(h_n_pond)\n    \n    optim_h_n &lt;- optim(\n      par = coef(h_n_pond),\n      fn = MSE_ponderados,\n      h = h,\n      gamma = gamma,\n      pesos = \"h/n\",\n      model = model,\n      n = n,\n      method = \"L-BFGS-B\",\n      lower = c(0, rep(1e-6, length(start_list)-1))\n    )    \n    \n    par_optim_h_n &lt;- optim_h_n$par[c(\"nugget\", \"sigma\", \"phi\")]\n    \n\nres &lt;- list(Bessel = list(Iniciales = ini_Bessel,\n                           Optimizados = par_optim_Bess),\n            `1/n` = list(Iniciales = ini_n,\n                          Optimizados = par_optim_n),\n            `h/n` = list(Iniciales = ini_h_n,\n                          Optimizados = par_optim_h_n))    \nreturn(res)\n}\n\nMSE_sv &lt;- function(gamma_hat, par, kappa, model, h){\n  sigma_0 &lt;- par[[2]]\n  phi_0 &lt;- par[[3]]\n  nugget_0 &lt;- par[[1]]\n  kappa_0 &lt;- kappa\n  \n  sv &lt;- switch(model,\n               \"exponencial\" = sv_exp,\n               \"gaussian\"    = sv_gauss,\n               \"spherical\"   = sv_spherical,\n               \"gneiting\"    = sv_gneiting,\n               \"matern\"      = sv_matern,\n               \"cos\" = cos_sv,\n               \"wave\" = sv_wave\n  )\n  \n  args_sv &lt;- names(formals(sv))\n  \n  args_list &lt;- list(\n    nugget = nugget_0,\n    sigma  = sigma_0,\n    h      = h,\n    phi    = phi_0,\n    kappa  = kappa_0\n  )\n  \n  args_list &lt;- args_list[names(args_list) %in% args_sv]\n  \n  sv_est &lt;- do.call(sv, args_list)\n  \n  return(mean((sv_est-gamma_hat)^2))\n}\n\n#3. Función para etimar por máxima verosimilitud\n\nloglik &lt;- function(par, kappa=NA, z, dist_matrix, model){\n  sigma_0 &lt;- par[1]\n  phi_0 &lt;- par[2]\n  nugget_0 &lt;- par[3]\n  kappa_0 &lt;- kappa\n  \n  cov &lt;- switch(model,\n               \"exponencial\" = cov_exp,\n               \"gaussian\"    = cov_gauss,\n               \"spherical\"   = cov_spherical,\n               \"gneiting\"    = cov_gneiting,\n               \"matern\"      = cov_matern\n  )\n  \n  args_cov &lt;- names(formals(cov))\n  \n  args_list &lt;- list(\n    sigma  = sigma_0,\n    nugget = nugget_0,\n    h      = dist_matrix,\n    phi    = phi_0,\n    kappa  = kappa_0\n  )\n  \n  args_list &lt;- args_list[names(args_list) %in% args_cov]\n  \n  Sigma &lt;- do.call(cov, args_list) \n  diag(Sigma) = diag(Sigma) + nugget_0\n  \n  # Descomposición de Cholesky (más estable que solve o det)\n  inv_Sigma &lt;- solve(Sigma)\n  det &lt;- log(det(Sigma))\n  \n  # Log-verosimilitud del modelo Gaussiano\n  z &lt;- z \n  n &lt;- length(z)\n  ll &lt;- -0.5 * (n * log(2 * pi) + det + crossprod(z, inv_Sigma %*% z))  # Log-verosimilitud (negativa porque optim minimiza)\n  return(-ll)\n}\n\n\nLos modelos obtenidos ajustanto por EyeFit, son:\n\ncov.model sigmasq      phi tausq kappa kappa2 practicalRange\n1 exponential   10.74 109166.3  2.07    NA     NA       327033.0\n2    gaussian   10.00  80000.0  2.07    NA     NA       138465.5\n3   spherical   10.00 157832.8  2.07    NA     NA       157832.8\n\n\nVer código\nvariog_T &lt;- data.frame(h = vg1_T$u, gamma_hat = vg1_T$v,\n                       n = vg1_T$n)\n\nrange_sv_T &lt;- seq(1,max(variog_T$h), by=1000)\n\n# Modelo exponencial ----\n\nsigma_0_eT &lt;- 10.74\nphi_0_eT &lt;- 109166.3\nnugget_0_eT &lt;- 2.07\n\npar_eT &lt;- c(sigma_0_eT, phi_0_eT, nugget_0_eT)\n\nres_e_T &lt;- est_sev_WLS(par=par_eT, kappa = NA,\n                       model=\"exponencial\",\n                       h=variog_T$h,\n                       gamma = variog_T$gamma_hat,\n                       n = variog_T$n)\n\nMLE_eT &lt;- optim(fn = loglik,\n             par = par_eT,\n             kappa=NA,\n             z = datosT$Residuos, \n             dist_matrix=dist_matrix_T,\n             model = \"exponencial\",\n             method = \"L-BFGS-B\",\n             lower = c(0, 0, 0))\n\nestsv_exp_Bess_T &lt;- do.call(sv_exp, c(as.list(res_e_T$Bessel$Optimizados), list(h = range_sv_T)))\nestsv_exp_n_T &lt;- do.call(sv_exp, c(as.list(res_e_T$`1/n`$Optimizados), list(h = range_sv_T)))\nestsv_exp_h_n_T &lt;- do.call(sv_exp, c(as.list(res_e_T$`h/n`$Optimizados), list(h = range_sv_T)))\nestsv_exp_MLE_T &lt;- do.call(sv_exp, c(list(nugget = MLE_eT$par[3], phi = MLE_eT$par[2] , sigma = MLE_eT$par[1],h = range_sv_T)))\n\n# Modelo Gaussiano ----\n\nsigma_0_gT &lt;- 10.00    \nphi_0_gT &lt;- 80000.0\nnugget_0_gT &lt;- 2.07\n\npar_gT &lt;- c(sigma_0_gT, phi_0_gT, nugget_0_gT)\n\nres_g_T &lt;- est_sev_WLS(par=par_gT, kappa = NA,\n                       model=\"gaussian\",\n                       h=variog_T$h,\n                       gamma = variog_T$gamma_hat,\n                       n = variog_T$n)\n\nestsv_g_Bess_T &lt;- do.call(sv_gauss, c(as.list(res_g_T$Bessel$Optimizados), list(h = range_sv_T)))\nestsv_g_n_T &lt;- do.call(sv_gauss, c(as.list(res_g_T$`1/n`$Optimizados), list(h = range_sv_T)))\nestsv_g_h_n_T &lt;- do.call(sv_gauss, c(as.list(res_g_T$`h/n`$Optimizados), list(h = range_sv_T)))\n\n# Modelo esférico\n\nsigma_0_esT &lt;- 10.00   \nphi_0_esT &lt;- 157832.8\nnugget_0_esT &lt;- 2.07\n\npar_esT &lt;- c(sigma_0_esT, phi_0_esT, nugget_0_esT)\n\nres_es_T &lt;- est_sev_WLS(par=par_esT, kappa = NA,\n                       model=\"spherical\",\n                       h=variog_T$h,\n                       gamma = variog_T$gamma_hat,\n                       n = variog_T$n)\n\nMLE_esT &lt;- optim(fn = loglik,\n             par = par_esT,\n             kappa=NA,\n             z = datosT$Residuos, \n             dist_matrix=dist_matrix_T,\n             model = \"spherical\",\n             method = \"L-BFGS-B\",\n             lower = c(0, 0, 0))\n\n\nestsv_es_Bess_T &lt;- do.call(sv_spherical, c(as.list(res_es_T$Bessel$Optimizados), list(h = range_sv_T)))\nestsv_es_n_T &lt;- do.call(sv_spherical, c(as.list(res_es_T$`1/n`$Optimizados), list(h = range_sv_T)))\nestsv_es_h_n_T &lt;- do.call(sv_spherical, c(as.list(res_es_T$`h/n`$Optimizados), list(h = range_sv_T)))\nestsv_es_MLE_T &lt;- do.call(sv_spherical, c(list(nugget = MLE_esT$par[3], phi = MLE_esT$par[2] , sigma = MLE_esT$par[1],h = range_sv_T)))\n\n\n\nExponencialGaussianoEsférico\n\n\n\nOptimGeoR\n\n\n\n\nVer código\nplot(vg1_T,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (optim)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(range_sv_T, estsv_exp_Bess_T, col=\"#FF4040\", lwd=1.5)\nlines(range_sv_T, estsv_exp_n_T, col=\"#4169E1\", lwd=1.5)\nlines(range_sv_T, estsv_exp_h_n_T, col=\"#008B00\", lwd=1.5)\nlines(range_sv_T, estsv_exp_MLE_T, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"Cressie\", \"1/n\", \"n/h\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\nVer código\nresumen_exp_T &lt;- cbind(\n  c(\"Cressie\", \"1/n\", \"n/h\", \"MLE\"),\n  rbind(\n    t(res_e_T$Bessel$Optimizados),\n    t(res_e_T$`1/n`$Optimizados),\n    t(res_e_T$`h/n`$Optimizados),\n    MLE_eT$par[c(3,1,2)]\n  ),\n  MSE = c(\n    MSE_sv(variog_T$gamma_hat, res_e_T$Bessel$Optimizados, NA, model = \"exponencial\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, res_e_T$`1/n`$Optimizados, NA, model = \"exponencial\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, res_e_T$`h/n`$Optimizados, NA, model = \"exponencial\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, list(nugget = MLE_eT$par[3], phi = MLE_eT$par[2] , sigma = MLE_eT$par[1]), NA, model = \"exponencial\", variog_T$h)\n  )\n)\n\nresumen_exp_T &lt;- as.data.frame(resumen_exp_T)\nresumen_exp_T[ , -1] &lt;- lapply(resumen_exp_T[ , -1], function(x) round(as.numeric(x), 3))\n\nkable(resumen_exp_T, digits = 3,\n      col.names = c(\"Método\", \"Nugget\", \"Sigma\", \"Phi\", \"MSE\"),\n      escape = F, row.names = F)\n\n\n\n\n\nMétodo\nNugget\nSigma\nPhi\nMSE\n\n\n\n\nCressie\n0\n12.944\n98216.22\n3.591000e+00\n\n\n1/n\n0\n11.178\n74809.83\n3.867000e+00\n\n\nn/h\n0\n12.797\n98765.50\n3.465000e+00\n\n\nMLE\n0\n31.706\n109166.30\n1.191489e+10\n\n\n\n\n\n\n\n\n\nVer código\nini1_exp_T &lt;- c(sigma_0_eT, phi_0_eT)\nfitvar1_exp_T &lt;- variofit(vg1_T,\n                    cov.model = \"exponential\",\n                    ini1_exp_T,\n                    fix.nugget = F,\n                    nugget = nugget_0_eT,\n                    wei = \"equal\")\n\nfitvar2_exp_T &lt;- variofit(vg1_T,\n                    cov.model = \"exponential\",\n                    ini1_exp_T,\n                    fix.nugget = F,\n                    nugget = nugget_0_eT,\n                    wei = \"npairs\")\n\nfitvar3_exp_T &lt;- variofit(vg1_T,\n                    cov.model = \"exponential\",\n                    ini1_exp_T,\n                    fix.nugget =F,\n                    nugget = nugget_0_eT,\n                    wei = \"cressie\")\n\nfitvar4_exp_T &lt;- likfit(temp,\n                  coords = temp$coords,\n                  data = temp$data,\n                  trend = ~ poly(Norte, 2, raw = FALSE),\n                  ini.cov.pars = ini1_exp_T,\n                  fix.nugget = F,\n                  nugget = nugget_0_eT,\n                  cov.model = \"exponential\",\n                  lik.method = \"ML\")\n\n\nplot(vg1_T,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar1_exp_T, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_exp_T, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_exp_T, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_exp_T, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\nVer código\npar1Texp &lt;- c(fitvar1_exp_T$nugget, fitvar1_exp_T$cov.pars[1], fitvar1_exp_T$cov.pars[2])\npar2Texp &lt;- c(fitvar2_exp_T$nugget, fitvar2_exp_T$cov.pars[1], fitvar2_exp_T$cov.pars[2])\npar3Texp &lt;- c(fitvar3_exp_T$nugget, fitvar3_exp_T$cov.pars[1], fitvar3_exp_T$cov.pars[2])\npar4Texp &lt;- c(fitvar4_exp_T$nugget, fitvar4_exp_T$cov.pars[1], fitvar4_exp_T$cov.pars[2])\n\nresumen_exp_T2 &lt;- cbind(\n  c(\"MCO\", \"1/n\", \"Cressie\",\"MLE\"),\n  rbind(\n    par1Texp,\n    par2Texp,\n    par3Texp,\n    par4Texp\n  ),\n  MSE = c(\n    MSE_sv(variog_T$gamma_hat, par1Texp, NA, model = \"exponencial\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, par2Texp, NA, model = \"exponencial\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, par3Texp, NA, model = \"exponencial\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, par4Texp, NA, model = \"exponencial\", variog_T$h)\n  )\n)\n\nresumen_exp_T2 &lt;- as.data.frame(resumen_exp_T2)\nresumen_exp_T2[ , -1] &lt;- lapply(resumen_exp_T2[ , -1], function(x) round(as.numeric(x), 3))\nkable(resumen_exp_T2, digits = 3,\n      col.names = c(\"Método\", \"Nugget\", \"Sigma\", \"Phi\", \"MSE\"),\n      escape = F, row.names = F)\n\n\n\n\n\nMétodo\nNugget\nSigma\nPhi\nMSE\n\n\n\n\nMCO\n0\n12.141\n82253.47\n3.184\n\n\n1/n\n0\n12.423\n83939.28\n3.243\n\n\nCressie\n0\n13.298\n109166.30\n4.009\n\n\nMLE\n0\n23.536\n75307.83\n117.551\n\n\n\n\n\n\n\n\n\n\n\nOptimGeoR\n\n\n\n\nVer código\nplot(vg1_T,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (optim)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(range_sv_T, estsv_g_Bess_T, col=\"#FF4040\", lwd=1.5)\nlines(range_sv_T, estsv_g_n_T, col=\"#4169E1\", lwd=1.5)\nlines(range_sv_T, estsv_g_h_n_T, col=\"#008B00\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"Cressie\", \"1/n\", \"n/h\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\nVer código\nresumen_g_T &lt;- cbind(\n  c(\"Cressie\", \"1/n\", \"n/h\"),\n  rbind(\n    t(res_g_T$Bessel$Optimizados),\n    t(res_g_T$`1/n`$Optimizados),\n    t(res_g_T$`h/n`$Optimizados)\n  ),\n  MSE = c(\n    MSE_sv(variog_T$gamma_hat, res_g_T$Bessel$Optimizados, NA, model = \"gaussian\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, res_g_T$`1/n`$Optimizados, NA, model = \"gaussian\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, res_g_T$`h/n`$Optimizados, NA, model = \"gaussian\", variog_T$h)\n  )\n)\n\nresumen_g_T &lt;- as.data.frame(resumen_g_T)\nresumen_g_T[ , -1] &lt;- lapply(resumen_g_T[ , -1], function(x) round(as.numeric(x), 3))\n\nkable(resumen_g_T, digits = 3,\n      col.names = c(\"Método\", \"Nugget\", \"Sigma\", \"Phi\", \"MSE\"),\n      escape = F)\n\n\n\n\n\nMétodo\nNugget\nSigma\nPhi\nMSE\n\n\n\n\nCressie\n0\n12.053\n74520.08\n2.809\n\n\n1/n\n0\n11.126\n69275.08\n3.233\n\n\nn/h\n0\n11.620\n72540.06\n2.825\n\n\n\n\n\n\n\n\n\nVer código\nini1_g_T &lt;- c(sigma_0_gT, phi_0_gT)\nfitvar1_g_T &lt;- variofit(vg1_T,\n                    cov.model = \"gaussian\",\n                    ini1_g_T,\n                    fix.nugget = F,\n                    nugget = nugget_0_gT,\n                    wei = \"equal\")\n\nfitvar2_g_T &lt;- variofit(vg1_T,\n                    cov.model = \"gaussian\",\n                    ini1_g_T,\n                    fix.nugget = F,\n                    nugget = nugget_0_gT,\n                    wei = \"npairs\")\n\nfitvar3_g_T &lt;- variofit(vg1_T,\n                    cov.model = \"gaussian\",\n                    ini1_g_T,\n                    fix.nugget = F,\n                    nugget = nugget_0_gT,\n                    wei = \"cressie\")\n\nfitvar4_g_T &lt;- likfit(temp,\n                  coords = temp$coords,\n                  data = temp$data,\n                  trend = ~ poly(Norte, 2, raw = FALSE),\n                  ini.cov.pars = ini1_g_T,\n                  fix.nugget = F,\n                  nugget = nugget_0_gT,\n                  cov.model = \"gaussian\",\n                  lik.method = \"ML\")\n\n\nplot(vg1_T,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar1_g_T, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_g_T, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_g_T, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_g_T, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\nVer código\npar1Tg &lt;- c(fitvar1_g_T$nugget, fitvar1_g_T$cov.pars[1], fitvar1_g_T$cov.pars[2])\npar2Tg &lt;- c(fitvar2_g_T$nugget, fitvar2_g_T$cov.pars[1], fitvar2_g_T$cov.pars[2])\npar3Tg &lt;- c(fitvar3_g_T$nugget, fitvar3_g_T$cov.pars[1], fitvar3_g_T$cov.pars[2])\npar4Tg &lt;- c(fitvar4_g_T$nugget, fitvar4_g_T$cov.pars[1], fitvar4_g_T$cov.pars[2])\n\nresumen_g_T2 &lt;- cbind(\n  c(\"MCO\", \"1/n\", \"Cressie\",\"MLE\"),\n  rbind(\n    par1Tg,\n    par2Tg,\n    par3Tg,\n    par4Tg\n  ),\n  MSE = c(\n    MSE_sv(variog_T$gamma_hat, par1Tg, NA, model = \"gaussian\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, par2Tg, NA, model = \"gaussian\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, par3Tg, NA, model = \"gaussian\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, par4Tg, NA, model = \"gaussian\", variog_T$h)\n  )\n)\n\nresumen_g_T2 &lt;- as.data.frame(resumen_g_T2)\nresumen_g_T2[ , -1] &lt;- lapply(resumen_g_T2[ , -1], function(x) round(as.numeric(x), 3))\n\nkable(resumen_g_T2, digits = 3,\n      col.names = c(\"Método\", \"Nugget\", \"Sigma\", \"Phi\", \"MSE\"),\n      escape = F, row.names = F)\n\n\n\n\n\nMétodo\nNugget\nSigma\nPhi\nMSE\n\n\n\n\nMCO\n0.000\n11.862\n74341.87\n2.776\n\n\n1/n\n0.000\n11.884\n74607.88\n2.777\n\n\nCressie\n0.349\n11.781\n80000.00\n2.835\n\n\nMLE\n3.589\n21.264\n80000.00\n155.000\n\n\n\n\n\n\n\n\n\n\n\nOptimGeoR\n\n\n\n\nVer código\nplot(vg1_T,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (optim)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(range_sv_T, estsv_es_Bess_T, col=\"#FF4040\", lwd=1.5)\nlines(range_sv_T, estsv_es_n_T, col=\"#4169E1\", lwd=1.5)\nlines(range_sv_T, estsv_es_h_n_T, col=\"#008B00\", lwd=1.5)\nlines(range_sv_T, estsv_es_MLE_T, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"Cressie\", \"1/n\", \"n/h\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\nVer código\nresumen_es_T &lt;- cbind(\n  c(\"Cressie\", \"1/n\", \"n/h\",\"MLE\"),\n  rbind(\n    t(res_es_T$Bessel$Optimizados),\n    t(res_es_T$`1/n`$Optimizados),\n    t(res_es_T$`h/n`$Optimizados),\n    MLE_esT$par[c(3,1,2)]\n  ),\n  MSE = c(\n    MSE_sv(variog_T$gamma_hat, res_es_T$Bessel$Optimizados, NA, model = \"spherical\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, res_es_T$`1/n`$Optimizados, NA, model = \"spherical\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, res_es_T$`h/n`$Optimizados, NA, model = \"spherical\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, list(nugget = MLE_esT$par[3], phi = MLE_esT$par[2] , sigma = MLE_esT$par[1]), NA, model = \"spherical\", variog_T$h)\n  )\n)\n\nresumen_es_T &lt;- as.data.frame(resumen_es_T)\nresumen_es_T[ , -1] &lt;- lapply(resumen_es_T[ , -1], function(x) round(as.numeric(x), 3))\n\nkable(resumen_es_T, digits = 3,\n      col.names = c(\"Método\", \"Nugget\", \"Sigma\", \"Phi\", \"MSE\"),\n      escape = F)\n\n\n\n\n\nMétodo\nNugget\nSigma\nPhi\nMSE\n\n\n\n\nCressie\n0\n12.165\n191573.0\n3.044000e+00\n\n\n1/n\n0\n11.128\n165974.5\n3.417000e+00\n\n\nn/h\n0\n11.692\n175441.2\n2.976000e+00\n\n\nMLE\n0\n27.958\n157832.8\n2.490774e+10\n\n\n\n\n\n\n\n\n\nVer código\nini1_es_T &lt;- c(sigma_0_esT, phi_0_esT)\nfitvar1_es_T &lt;- variofit(vg1_T,\n                    cov.model = \"spherical\",\n                    ini1_es_T,\n                    fix.nugget = F,\n                    nugget = nugget_0_esT,\n                    wei = \"equal\")\n\nfitvar2_es_T &lt;- variofit(vg1_T,\n                    cov.model = \"spherical\",\n                    ini1_es_T,\n                    fix.nugget = F,\n                    nugget = nugget_0_esT,\n                    wei = \"npairs\")\n\nfitvar3_es_T &lt;- variofit(vg1_T,\n                    cov.model = \"spherical\",\n                    ini1_es_T,\n                    fix.nugget = F,\n                    nugget = nugget_0_esT,\n                    wei = \"cressie\")\n\nfitvar4_es_T &lt;- likfit(temp,\n                  coords = temp$coords,\n                  data = temp$data,\n                  trend = ~ poly(Norte, 2, raw = FALSE),\n                  ini.cov.pars = ini1_es_T,\n                  fix.nugget = F,\n                  nugget = nugget_0_esT,\n                  cov.model = \"spherical\",\n                  lik.method = \"ML\")\n\n\nplot(vg1_T,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar1_es_T, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_es_T, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_es_T, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_es_T, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\nVer código\npar1Tes &lt;- c(fitvar1_es_T$nugget, fitvar1_es_T$cov.pars[1], fitvar1_es_T$cov.pars[2])\npar2Tes &lt;- c(fitvar2_es_T$nugget, fitvar2_es_T$cov.pars[1], fitvar2_es_T$cov.pars[2])\npar3Tes &lt;- c(fitvar3_es_T$nugget, fitvar3_es_T$cov.pars[1], fitvar3_es_T$cov.pars[2])\npar4Tes &lt;- c(fitvar4_es_T$nugget, fitvar4_es_T$cov.pars[1], fitvar4_es_T$cov.pars[2])\n\nresumen_es_T2 &lt;- cbind(\n  c(\"MCO\", \"1/n\", \"Cressie\",\"MLE\"),\n  rbind(\n    par1Tes,\n    par2Tes,\n    par3Tes,\n    par4Tes\n  ),\n  MSE = c(\n    MSE_sv(variog_T$gamma_hat, par1Tes, NA, model = \"spherical\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, par2Tes, NA, model = \"spherical\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, par3Tes, NA, model = \"spherical\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, par4Tes, NA, model = \"spherical\", variog_T$h)\n  )\n)\n\nresumen_es_T2 &lt;- as.data.frame(resumen_es_T2)\nresumen_es_T2[ , -1] &lt;- lapply(resumen_es_T2[ , -1], function(x) round(as.numeric(x), 3))\n\nkable(resumen_es_T2, digits = 3,\n      col.names = c(\"Método\", \"Nugget\", \"Sigma\", \"Phi\", \"MSE\"),\n      escape = F, row.names = F)\n\n\n\n\n\nMétodo\nNugget\nSigma\nPhi\nMSE\n\n\n\n\nMCO\n0\n11.878\n171733.0\n2.938\n\n\n1/n\n0\n11.898\n166427.4\n2.944\n\n\nCressie\n0\n11.860\n157832.8\n2.977\n\n\nMLE\n0\n25.641\n144147.3\n179.276\n\n\n\n\n\n\n\n\n\n\n\nEl modelo con menor MSE es el modelo Gausiano. Sin embargo, dada la inestabilidad numérica que se observa al realizar la predicción se opta por usar el modelo esférico obtenido por mínimos cuadrados ponderados usando la ponderación h/n, que es el segundo mejor en términos del MSE.\n\n\n1.3.2.4 Kriging\nUsando el modelo esférico:\n\n\nVer código\nplot(vg1_T,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Modelo esférico para Temperatura\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(range_sv_T, estsv_es_h_n_T, col=\"#008B00\", lwd=1.5)\n\n\n\n\n\n\n\n\n\n\n\nVer código\n#Se escoge el mejor modelo --------------------------------\n\nbest_model_T &lt;- gstat::vgm(psill = res_es_T$`h/n`$Optimizados[2],\n                           model = \"Sph\",\n                           range = res_es_T$`h/n`$Optimizados[3],\n                           nugget = res_es_T$`h/n`$Optimizados[1]\n)\n\n#Se crea un objeto en gstat -------------------------------\n\ncoordinates(datosT) &lt;- ~Este + Norte\nproj4string(datosT) &lt;- CRS(\"EPSG:3310\")\n\ng_obj&lt;-gstat::gstat(id=\"Temperatura\",\n             formula = Temperatura ~ Norte + I(Norte^2),\n             model = best_model_T,\n             data = datosT)\n\n#Kriging -------------------------------------------------\n\nsuppressMessages(predic &lt;- predict(g_obj, newdata = new, nmin = 12, maxdist=74809.84))\n\n#Mapas de predicción --------------------------------------\n\ngridded(predic) &lt;- TRUE\n\n#1. Mapa de Kriging ---------------------------------------\n\npredic_raster_utm &lt;- raster(predic, layer = \"Temperatura.pred\")\n\ncrs(predic_raster_utm) &lt;- \"+init=epsg:3310\"\n\npredic_raster_wgs84 &lt;- raster::projectRaster(\n    raster::mask(\n        predic_raster_utm, \n        sh_mundos_sp_utm_simple\n    ),\n    crs = \"+init=epsg:4326\", \n    method = \"bilinear\"\n)\n\nbins &lt;- c(-5,0, 5, 8, 10, 12, 15, 20, 25)\n\npred_range &lt;- c(minValue(predic_raster_wgs84), maxValue(predic_raster_wgs84))\npal_pred &lt;- colorBin(\n  palette = \"viridis\", # La paleta de colores\n  domain = pred_range,\n  bins = bins,\n  na.color = \"transparent\"\n)\n\nmapa_kriging_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    predic_raster_wgs84,\n    colors = pal_pred, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n    addCircleMarkers(data = datosT_sf_wgs84,\n                   fillColor = ~pal(Temperatura),\n                   fillOpacity = 0.8,\n                   color = \"black\",\n                   weight = 1,\n                   radius = 6,\n                   popup = ~paste(\"Temp:\", Temperatura, \"°C\")) %&gt;% \n  addLegend(\n    pal = pal_pred, \n    values = pred_range,\n    title = \"Predicción T (°C)\",\n    position = \"topright\"\n  ) %&gt;%\n  addLegend(pal = pal,\n            values = datosT_sf_wgs84$Temperatura,\n            title = \"Temperatura Observada\",\n    position = \"topleft\"\n  ) \n\n#2 Mapa Varianza------------------------------------------\n\nvar_raster_utm &lt;- raster(predic, layer = \"Temperatura.var\")\n\ncrs(var_raster_utm) &lt;- \"+init=epsg:3310\"\n\nvar_raster_wgs84 &lt;- raster::projectRaster(\n    raster::mask(\n        var_raster_utm, \n        sh_mundos_sp_utm_simple\n    ),\n    crs = \"+init=epsg:4326\", \n    method = \"bilinear\"\n)\n\nbinsv &lt;- seq(0,30, by=5)\n\nvar_range &lt;- c(minValue(var_raster_wgs84), maxValue(var_raster_wgs84))\npal_var &lt;- colorBin(\n  palette = \"Spectral\", # La paleta de colores\n  domain = var_range,\n  bins = binsv,\n  na.color = \"transparent\"\n)\n\nmapa_var_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    var_raster_wgs84, \n    colors = pal_var, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n  addLegend(\n    pal = pal_var, \n    values = var_range,\n    title = \"Varianza\",\n    position = \"topright\"\n  ) \n\n#3. Mapa Cv ----------------------------------------------\n\ncv_raster_utm &lt;- sqrt(var_raster_utm) / abs(predic_raster_utm)\n\nmapa_mayor_a_uno &lt;- cv_raster_utm &gt; 1\ncv_raster_utm[mapa_mayor_a_uno] &lt;- 1\n\ncrs(cv_raster_utm) &lt;- \"+init=epsg:3310\"\n\ncv_raster_masked_utm &lt;- raster::mask(cv_raster_utm, sh_mundos_sp_utm_simple)\n\n\ncv_raster_cropped_utm &lt;- raster::crop(cv_raster_masked_utm, sh_mundos_sp_utm_simple)\n\n\ncv_raster_wgs84 &lt;- raster::projectRaster(\n    cv_raster_cropped_utm, \n    crs = \"+init=epsg:4326\", \n    method = \"bilinear\"\n)\n\nbincv &lt;- seq(0,1, by=.1)\n\ncv_range &lt;- c(minValue(cv_raster_wgs84), maxValue(cv_raster_wgs84))\n\npal_cv &lt;- colorBin(\n  palette = \"RdYlGn\", # Rojo-Amarillo-Verde\n  domain = cv_range,\n  na.color = \"transparent\",\n  bins = bincv,\n  reverse = TRUE \n)\n\nmapa_cv_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    cv_raster_wgs84, \n    colors = pal_cv, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n  \n  addLegend(\n    pal = pal_cv, \n    values = cv_range,\n    title = \"Coeficiente de Variación\",\n    position = \"topright\"\n  )\n\n\n\nPredicciónVarianzaCoeficiente de variación\n\n\n\n\nVer código\nmapa_kriging_leaflet\n\n\n\n\n\n\n\n\n\n\nVer código\nmapa_var_leaflet\n\n\n\n\n\n\n\n\n\n\nVer código\nmapa_cv_leaflet\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.3 Variable Velocidad del viento\n\n\nVer código\nWS &lt;- read_excel(\"GeoEst_Cali.xlsx\", sheet = \"WindSpeed\")\ncolnames(WS)[-1] &lt;- as.numeric(colnames(WS)[-1])\nEstacionesWS &lt;- read_excel(\"GeoEst_Cali.xlsx\", sheet = \"Estaciones\")\nEstacionesWS &lt;- EstacionesWS %&gt;% mutate(AQSID = as.numeric(AQSID))\nEstacionesWS &lt;- EstacionesWS %&gt;% filter(AQSID %in% colnames(WS)[-1])\n\ny_WS &lt;- WS[1,] #Tomar una fecha\ny_WS &lt;- cbind(colnames(y_WS),t(y_WS[1,]))\ny_WS &lt;- y_WS[-1,]\ny_WS &lt;- as.data.frame(y_WS)\ny_WS &lt;- na.omit(y_WS)\ny_WS$V1 &lt;- as.numeric(y_WS$V1)\ny_WS &lt;- inner_join(y_WS, EstacionesWS, by=c(\"V1\"=\"AQSID\"))\ndatosWS &lt;- y_WS[,c(13,14,2)]\ncolnames(datosWS)=c(\"Este\",\"Norte\",\"WindSpeed\")\ndatosWS$WindSpeed &lt;- as.numeric(datosWS$WindSpeed)\n\ndatosWS_sf &lt;- st_as_sf(datosWS, coords = c(\"Este\", \"Norte\"), crs = 3310)\n\ndatosWS_sf_wgs84 &lt;- st_transform(datosWS_sf, crs = 4326)\n\npalWS &lt;- colorNumeric(palette = \"viridis\", domain = datosWS_sf_wgs84$WindSpeed)\n\nleaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addPolygons(data = sh_mundos_wgs84, fill = FALSE, color = \"black\", weight = 2) %&gt;%\n  addCircleMarkers(data = datosWS_sf_wgs84,\n                   fillColor = ~palWS(WindSpeed),\n                   fillOpacity = 0.8,\n                   color = \"black\",\n                   weight = 1,\n                   radius = 6,\n                   popup = ~paste(\"WindSpeed:\", WindSpeed, \"m/s\")) %&gt;%\n  addLegend(pal = palWS, values = datosWS_sf_wgs84$WindSpeed, title = \"WindSpeed (m/s)\")\n\n\n\n\n\n\nVer código\nws &lt;- as.geodata(datosWS)\npander::pander(summary(ws))\n\n\n\nn: 89\ncoords.summary:\n\n\n\n\n\n\n\n\n \nEste\nNorte\n\n\n\n\nmin\n-276541\n-543973\n\n\nmax\n415574\n281577\n\n\n\ndistances.summary:\n\n\n\n\n\n\n\nmin\nmax\n\n\n\n\n2216\n987994\n\n\n\ndata.summary:\n\n\n\n\n\n\n\n\n\n\n\nMin.\n1st Qu.\nMedian\nMean\n3rd Qu.\nMax.\n\n\n\n\n0.8\n2.5\n3.8\n4.375\n5.5\n14.1\n\n\n\n\n\n\n\n\nGráficos de dispersiónGeoR\n\n\n\n\nVer código\npWS1 &lt;- simple_scatter_plot(datosWS, \"Este\", \"WindSpeed\")\npWS2 &lt;- simple_scatter_plot(datosWS, \"Norte\", \"WindSpeed\")\n\ncowplot::plot_grid(pWS1,pWS2)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(ws, qt.col = c(\"purple\",\n                          \"pink\",\n                          \"green\",\n                          \"yellow\"),\n     scatter3d=T)\n\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.3.1 Modelo de tendencia espacial\nEl modelo que mejor atrapa el efecto de la media es:\nWindSpeed = \\beta_0 + \\beta_1 \\times Este + \\beta_2 \\times Norte + + \\beta_3 \\times Este \\times Norte\n\n\nVer código\nfitWS &lt;- lm(WindSpeed~Este*Norte, data = datosWS) \npander::pander(summary(fitWS))\n\n\n\n\n\n\n\n\n\n\n\n\n \nEstimate\nStd. Error\nt value\nPr(&gt;|t|)\n\n\n\n\n(Intercept)\n6.398\n0.3639\n17.58\n4.751e-30\n\n\nEste\n2.069e-05\n2.674e-06\n7.739\n1.895e-11\n\n\nNorte\n1.159e-05\n1.808e-06\n6.411\n7.746e-09\n\n\nEste:Norte\n2.558e-11\n7.483e-12\n3.419\n0.000968\n\n\n\n\nFitting linear model: WindSpeed ~ Este * Norte\n\n\n\n\n\n\n\n\nObservations\nResidual Std. Error\nR^2\nAdjusted R^2\n\n\n\n\n89\n1.938\n0.4851\n0.4669\n\n\n\n\n\nGráficamente se observa una mitigación en la tendencia espacial:\n\nGráficos de dispersiónGeoR\n\n\n\n\nVer código\ndatosWS$Residuos &lt;- fitWS$residuals\n\npWS1 &lt;- simple_scatter_plot(datosWS, \"Este\", \"Residuos\")\npWS2 &lt;- simple_scatter_plot(datosWS, \"Norte\", \"Residuos\")\n\ncowplot::plot_grid(pWS1,pWS2)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(temp, qt.col = c(\"purple\",\n                      \"pink\",\n                      \"green\",\n                      \"yellow\"),\n     scatter3d=T, trend=~Norte*Este)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.3.2 Estimación empírica del semivariograma\n\n\nVer código\nvgO_WS &lt;- variog(ws,estimator.type = \"modulus\", pairs.min=50) \n\nvg1_WS &lt;- variog(ws, trend = ~Norte*Este,\n                estimator.type = \"modulus\", pairs.min=50)\n\n\n\nCon tendenciaRemoviendo Tendencia\n\n\n\n\nVer código\nplot(vgO_WS,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Sin remover tendencia\",\n     col.main = 4, cex.main =1.3)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(vg1_WS,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Removiendo tendencia\",\n     col.main = 4, cex.main =1.3)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.3.3 Estimación del Modelo Teórico de Semivariograma\n\n\nVer código\nvariog_WS &lt;- data.frame(h = vg1_WS$u, gamma_hat = vg1_WS$v,\n                       n = vg1_WS$n)\n\nrange_sv_WS &lt;- seq(1,max(variog_WS$h), by=1000)\n\n#Modelo Coseno---------------------------------------------\n\nsigma_0_cosWS &lt;- 1.5\nphi_0_cosWS &lt;- .6e5\nnugget_0_cosWS &lt;- 1.5\n\n#MCO -------\nI_pond_WS &lt;- nls(formula = gamma_hat ~cos_sv(nugget, sigma, h, phi),\n              start = c(nugget = nugget_0_cosWS, sigma = sigma_0_cosWS, phi = phi_0_cosWS),\n              lower = rep(1e-6,3),\n              data = variog_WS,\n              control = nls.control(maxiter = 500, warnOnly = TRUE))\n\noptim_I_WS &lt;- optim(\n  par = coef(I_pond_WS),\n  fn = MSE_ponderados,\n  h = variog_WS$h,\n  gamma = variog_WS$gamma_hat,\n  pesos = \"I\",\n  model = \"cos\",\n  n = n,\n  method = \"L-BFGS-B\",\n  lower = rep(1e-6,3)\n)\n\npar_optim_I_WS &lt;- optim_I_WS$par[c(\"nugget\", \"sigma\", \"phi\")]\n\nestsv_cos_I_WS &lt;- do.call(cos_sv, c(as.list(par_optim_I_WS), list(h = range_sv_WS)))\n\n\n#WLS -------\n\npar_cosWS &lt;- c(sigma_0_cosWS, phi_0_cosWS, nugget_0_cosWS)\n\nres_cos_WS &lt;- est_sev_WLS(par=par_cosWS, kappa = NA,\n                       model=\"cos\",\n                       h=variog_WS$h,\n                       gamma = variog_WS$gamma_hat,\n                       n = variog_WS$n)\n\nestsv_cos_Bess_WS &lt;- do.call(cos_sv, c(as.list(res_cos_WS$Bessel$Optimizados), list(h = range_sv_WS)))\nestsv_cos_n_WS &lt;- do.call(cos_sv, c(as.list(res_cos_WS$`1/n`$Optimizados), list(h = range_sv_WS)))\nestsv_cos_h_n_WS &lt;- do.call(cos_sv, c(as.list(res_cos_WS$`h/n`$Optimizados), list(h = range_sv_WS)))\n\n#Modelo Wave ---------------------------------------------\n\nnugget_0_wvWS &lt;- 1.5\n\npar_wvWS &lt;- c(3.5,.6e5)\n\nfitvar1_cos_WS &lt;- variofit(vg1_WS,\n                    cov.model = \"wave\",\n                    par_wvWS,\n                    fix.nugget = F,\n                    nugget = nugget_0_wvWS,\n                    wei = \"equal\")\nfitvar2_cos_WS &lt;- variofit(vg1_WS,\n                    cov.model = \"wave\",\n                    par_wvWS,\n                    fix.nugget = F,\n                    nugget = nugget_0_wvWS,\n                    wei = \"npairs\")\n\nfitvar3_cos_WS &lt;- variofit(vg1_WS,\n                    cov.model = \"wave\",\n                    par_wvWS,\n                    fix.nugget = F,\n                    nugget = nugget_0_wvWS,\n                    wei = \"cressie\")\n\nfitvar4_cos_WS &lt;- likfit(ws,\n                       coords = ws$coords,\n                       data = ws$data,\n                       trend = ~ Este*Norte,\n                       ini.cov.pars = par_wvWS,\n                       fix.nugget = F,\n                       nugget = nugget_0_wvWS,\n                       cov.model = \"wave\",\n                       lik.method = \"ML\")\n\n\n\nCoseno (Optim)Wave (GeoR)\n\n\n\n\nVer código\nplot(vg1_WS,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (optim)\",\n     col.main = 4, cex.main =1.3)\nlines(range_sv_WS, estsv_cos_Bess_WS, col=\"#FF4040\", lwd=1.5)\nlines(range_sv_WS, estsv_cos_n_WS, col=\"#4169E1\", lwd=1.5)\nlines(range_sv_WS, estsv_cos_h_n_WS, col=\"#008B00\", lwd=1.5)\nlines(range_sv_WS, estsv_cos_I_WS, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"Cressie\", \"1/n\", \"n/h\", \"MCO\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\nVer código\nresumen_cos_SV &lt;- cbind(\n  c(\"Cressie\", \"1/n\", \"n/h\", \"MCO\"),\n  rbind(\n    t(res_cos_WS$Bessel$Optimizados),\n    t(res_cos_WS$`1/n`$Optimizados),\n    t(res_cos_WS$`h/n`$Optimizados),\n    par_optim_I_WS\n  ),\n  MSE = c(\n    MSE_sv(variog_WS$gamma_hat, res_cos_WS$Bessel$Optimizados, NA, model = \"cos\", variog_WS$h),\n    MSE_sv(variog_WS$gamma_hat, res_cos_WS$`1/n`$Optimizados, NA, model = \"cos\", variog_WS$h),\n    MSE_sv(variog_WS$gamma_hat, res_cos_WS$`h/n`$Optimizados, NA, model = \"cos\", variog_WS$h),\n    MSE_sv(variog_WS$gamma_hat, par_optim_I_WS, NA, model = \"cos\", variog_WS$h)\n  )\n)\n\nresumen_cos_SV &lt;- as.data.frame(resumen_cos_SV)\nresumen_cos_SV[ , -1] &lt;- lapply(resumen_cos_SV[ , -1], function(x) round(as.numeric(x), 3))\n\nkable(resumen_cos_SV, digits = 3,\n      col.names = c(\"Método\", \"Nugget\", \"Sigma\", \"Phi\", \"MSE\"),\n      escape = F, row.names = F)\n\n\n\n\n\nMétodo\nNugget\nSigma\nPhi\nMSE\n\n\n\n\nCressie\n2.445\n0.902\n63679.76\n1.022\n\n\n1/n\n1.342\n1.465\n56886.07\n0.679\n\n\nn/h\n1.519\n1.405\n69426.04\n1.704\n\n\nMCO\n1.865\n1.153\n57996.66\n0.546\n\n\n\n\n\n\n\n\n\nVer código\nplot(vg1_WS,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = 4, cex.main =1.3)\n\nlines(fitvar1_cos_WS, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_cos_WS, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_cos_WS, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_cos_WS, col=\"#FFA500\", lwd=1.5)\n\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\nVer código\npar1WScos &lt;- c(fitvar1_cos_WS$nugget, fitvar1_cos_WS$cov.pars[1], fitvar1_cos_WS$cov.pars[2])\npar2WScos &lt;- c(fitvar2_cos_WS$nugget, fitvar2_cos_WS$cov.pars[1], fitvar2_cos_WS$cov.pars[2])\npar3WScos &lt;- c(fitvar3_cos_WS$nugget, fitvar3_cos_WS$cov.pars[1], fitvar3_cos_WS$cov.pars[2])\npar4WScos &lt;- c(fitvar4_cos_WS$nugget, fitvar4_cos_WS$cov.pars[1], fitvar4_cos_WS$cov.pars[2])\n\nresumen_wv_WS &lt;- cbind(\n  c(\"MCO\", \"1/n\", \"Cressie\",\"MLE\"),\n  rbind(\n    par1WScos,\n    par2WScos,\n    par3WScos,\n    par4WScos\n  ),\n  MSE = c(\n    MSE_sv(variog_WS$gamma_hat, par1WScos, NA, model = \"wave\", variog_WS$h),\n    MSE_sv(variog_WS$gamma_hat, par2WScos, NA, model = \"wave\", variog_WS$h),\n    MSE_sv(variog_WS$gamma_hat, par3WScos, NA, model = \"wave\", variog_WS$h),\n    MSE_sv(variog_WS$gamma_hat, par4WScos, NA, model = \"wave\", variog_WS$h)\n  )\n)\n\nresumen_wv_WS &lt;- as.data.frame(resumen_wv_WS)\nresumen_wv_WS[ , -1] &lt;- lapply(resumen_wv_WS[ , -1], function(x) round(as.numeric(x), 3))\n\nkable(resumen_wv_WS, digits = 3,\n      col.names = c(\"Método\", \"Nugget\", \"Sigma\", \"Phi\", \"MSE\"),\n      escape = F, row.names = F)\n\n\n\n\n\nMétodo\nNugget\nSigma\nPhi\nMSE\n\n\n\n\nMCO\n1.692\n1.447\n60000.00\n1.014\n\n\n1/n\n1.069\n2.467\n50139.56\n0.864\n\n\nCressie\n1.300\n2.284\n50724.55\n0.908\n\n\nMLE\n2.819\n0.890\n60000.00\n1.450\n\n\n\n\n\n\n\n\n\n\n1.3.3.4 Kriging\nUsando el modelo wave:\n\n\nVer código\nplot(vg1_WS,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Modelo wave para WindSpeed\",\n     col.main = 4, cex.main =1.3)\nlines(fitvar2_cos_WS, col=\"#4169E1\", lwd=1.5)\n\n\n\n\n\n\n\n\n\n\n\nVer código\n#Se escoge el mejor modelo --------------------------------\n\nbest_model_WS &lt;- gstat::vgm(psill = par2WScos[2],\n                           model = \"Wav\",\n                           range = par2WScos[3],\n                           nugget = par2WScos[1]\n)\n\n#Se crea un objeto en gstat -------------------------------\n\ncoordinates(datosWS) &lt;- ~Este + Norte\nproj4string(datosWS) &lt;- CRS(\"EPSG:3310\")\n\ng_obj&lt;-gstat::gstat(id=\"WindSpeed\",\n             formula = WindSpeed ~ Norte*Este,\n             model = best_model_WS,\n             data = datosWS)\n\n#Kriging -------------------------------------------------\n\nsuppressMessages(predic &lt;- predict(g_obj, newdata = new, nmin = 12))\n\n#Mapas de predicción --------------------------------------\n\ngridded(predic) &lt;- TRUE\n\n#1. Mapa de Kriging ---------------------------------------\n\npredic_raster_utm &lt;- raster(predic, layer = \"WindSpeed.pred\")\n\ncrs(predic_raster_utm) &lt;- \"+init=epsg:3310\"\n\npredic_raster_wgs84 &lt;- raster::projectRaster(\n    raster::mask(\n        predic_raster_utm, \n        sh_mundos_sp_utm_simple\n    ),\n    crs = \"+init=epsg:4326\", \n    method = \"bilinear\"\n)\n\nbins &lt;- c(0, 5, 8, 10, 12, 15, 20)\n\npred_range &lt;- c(minValue(predic_raster_wgs84), maxValue(predic_raster_wgs84))\npal_pred &lt;- colorBin(\n  palette = \"viridis\", # La paleta de colores\n  domain = pred_range,\n  bins = bins,\n  na.color = \"transparent\"\n)\n\nmapa_kriging_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    predic_raster_wgs84,\n    colors = pal_pred, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n    addCircleMarkers(data = datosWS_sf_wgs84,\n                   fillColor = ~palWS(WindSpeed),\n                   fillOpacity = 0.8,\n                   color = \"black\",\n                   weight = 1,\n                   radius = 6,\n                   popup = ~paste(\"WS:\", WindSpeed, \"m/s\")) %&gt;% \n  addLegend(\n    pal = pal_pred, \n    values = pred_range,\n    title = \"Predicción WS (m/s)\",\n    position = \"topright\"\n  ) %&gt;%\n  addLegend(pal = palWS,\n            values = datosWS_sf_wgs84$WindSpeed,\n            title = \"WS Observada\",\n    position = \"topleft\"\n  ) \n\n#2 Mapa Varianza------------------------------------------\n\nvar_raster_utm &lt;- raster(predic, layer = \"WindSpeed.var\")\n\ncrs(var_raster_utm) &lt;- \"+init=epsg:3310\"\n\nvar_raster_wgs84 &lt;- raster::projectRaster(\n    raster::mask(\n        var_raster_utm, \n        sh_mundos_sp_utm_simple\n    ),\n    crs = \"+init=epsg:4326\", \n    method = \"bilinear\"\n)\n\nbinsv &lt;- seq(0,30, by=5)\n\nvar_range &lt;- c(minValue(var_raster_wgs84), maxValue(var_raster_wgs84))\npal_var &lt;- colorBin(\n  palette = \"Spectral\", # La paleta de colores\n  domain = var_range,\n  bins = binsv,\n  na.color = \"transparent\"\n)\n\nmapa_var_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    var_raster_wgs84, \n    colors = pal_var, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n  addLegend(\n    pal = pal_var, \n    values = var_range,\n    title = \"Varianza\",\n    position = \"topright\"\n  ) \n\n#3. Mapa Cv ----------------------------------------------\n\ncv_raster_utm &lt;- sqrt(var_raster_utm) / abs(predic_raster_utm)\n\nmapa_mayor_a_uno &lt;- cv_raster_utm &gt; 1\ncv_raster_utm[mapa_mayor_a_uno] &lt;- 1\n\ncrs(cv_raster_utm) &lt;- \"+init=epsg:3310\"\n\ncv_raster_masked_utm &lt;- raster::mask(cv_raster_utm, sh_mundos_sp_utm_simple)\n\n\ncv_raster_cropped_utm &lt;- raster::crop(cv_raster_masked_utm, sh_mundos_sp_utm_simple)\n\n\ncv_raster_wgs84 &lt;- raster::projectRaster(\n    cv_raster_cropped_utm, \n    crs = \"+init=epsg:4326\", \n    method = \"bilinear\"\n)\n\nbincv &lt;- seq(0,1, by=.1)\n\ncv_range &lt;- c(minValue(cv_raster_wgs84), maxValue(cv_raster_wgs84))\n\npal_cv &lt;- colorBin(\n  palette = \"RdYlGn\", # Rojo-Amarillo-Verde\n  domain = cv_range,\n  na.color = \"transparent\",\n  bins = bincv,\n  reverse = TRUE \n)\n\nmapa_cv_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    cv_raster_wgs84, \n    colors = pal_cv, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n  \n  addLegend(\n    pal = pal_cv, \n    values = cv_range,\n    title = \"Coeficiente de Variación\",\n    position = \"topright\"\n  )\n\n\n\nPredicciónVarianzaCoeficiente de variación\n\n\n\n\nVer código\nmapa_kriging_leaflet\n\n\n\n\n\n\n\n\n\n\nVer código\nmapa_var_leaflet\n\n\n\n\n\n\n\n\n\n\nVer código\nmapa_cv_leaflet",
    "crumbs": [
      "Análisis Geoestadístico",
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Análisis Univariado</span>"
    ]
  },
  {
    "objectID": "Geo_bi.html",
    "href": "Geo_bi.html",
    "title": "2  Análisis Bivariado",
    "section": "",
    "text": "2.1 Modelos Univariados\nSe consideran las variables temperatura y velocidad del viento:",
    "crumbs": [
      "Análisis Geoestadístico",
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Análisis Bivariado</span>"
    ]
  },
  {
    "objectID": "Geo_bi.html#modelos-univariados",
    "href": "Geo_bi.html#modelos-univariados",
    "title": "2  Análisis Bivariado",
    "section": "",
    "text": "2.1.1 Estacionariedad en Media\n\nTemperaturaVelocidad del viento\n\n\nEl modelo es: Temperatura = \\beta_0 + \\beta_1 \\times Norte + \\beta_2 \\times Norte^2\n\n\nVer código\nplot(temp, qt.col = c(\"purple\",\n                    \"pink\",\n                    \"green\",\n                    \"yellow\"),\n     scatter3d=T, trend=~Norte+I(Norte^2))\n\n\n\n\n\n\n\n\n\nVer código\nfitT &lt;- lm(Temperatura~Norte+I(Norte^2), data = datosT) \npander::pander(summary(fitT))\n\n\n\n\n\n\n\n\n\n\n\n\n \nEstimate\nStd. Error\nt value\nPr(&gt;|t|)\n\n\n\n\n(Intercept)\n13.26\n0.5352\n24.77\n8.812e-49\n\n\nNorte\n-2.229e-05\n3.23e-06\n-6.901\n2.676e-10\n\n\nI(Norte^2)\n-3.754e-11\n8.551e-12\n-4.39\n2.469e-05\n\n\n\n\nFitting linear model: Temperatura ~ Norte + I(Norte^2)\n\n\n\n\n\n\n\n\nObservations\nResidual Std. Error\nR^2\nAdjusted R^2\n\n\n\n\n122\n4.049\n0.3199\n0.3084\n\n\n\n\n\n\n\nEl modelo es: WindSpeed = \\beta_0 + \\beta_1 \\times Este + \\beta_2 \\times Norte + + \\beta_3 \\times Este \\times Norte\n\n\nVer código\nplot(temp, qt.col = c(\"purple\",\n                      \"pink\",\n                      \"green\",\n                      \"yellow\"),\n     scatter3d=T, trend=~Norte*Este)\n\n\n\n\n\n\n\n\n\nVer código\nfitWS &lt;- lm(WindSpeed~Este*Norte, data = datosWS) \npander::pander(summary(fitWS))\n\n\n\n\n\n\n\n\n\n\n\n\n \nEstimate\nStd. Error\nt value\nPr(&gt;|t|)\n\n\n\n\n(Intercept)\n6.398\n0.3639\n17.58\n4.751e-30\n\n\nEste\n2.069e-05\n2.674e-06\n7.739\n1.895e-11\n\n\nNorte\n1.159e-05\n1.808e-06\n6.411\n7.746e-09\n\n\nEste:Norte\n2.558e-11\n7.483e-12\n3.419\n0.000968\n\n\n\n\nFitting linear model: WindSpeed ~ Este * Norte\n\n\n\n\n\n\n\n\nObservations\nResidual Std. Error\nR^2\nAdjusted R^2\n\n\n\n\n89\n1.938\n0.4851\n0.4669\n\n\n\n\n\n\n\n\n\n\n2.1.2 Variogramas\n\n2.1.2.1 Temperatura\nPara esta variable ya se analizo y encontró un modelo apropiado en el capítulo 1.\n\n\n2.1.2.2 Velocidad del viento\n\n\nVer código\nvgO_WS &lt;- variog(ws,estimator.type = \"modulus\", pairs.min=50)\n\nvg1_WS &lt;- variog(ws, trend = ~Norte*Este,\n                estimator.type = \"modulus\", pairs.min=50)\n\n\n\nCon tendenciaSin tendencia\n\n\n\n\nVer código\nplot(vgO_WS,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Sin remover tendencia\",\n     col.main = 4, cex.main =1.3)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(vg1_WS,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Removiendo tendencia\",\n     col.main = 4, cex.main =1.3)\n\n\n\n\n\n\n\n\n\n\n\n\n\n2.1.2.2.1 Estimación teórica del semivariograma\nSe asume un modelo Coseno y Wave:\n\n\nVer código\n#Estimación del coseno ---------------------------------\n\nh_range &lt;- seq(0, max(vg1_WS$u), by = 1000)\n\nMSE_ponderados &lt;- function(par, h, gamma,kappa=NA,w, model, n, pesos){\n  nugget &lt;- par[1]\n  sigma &lt;- par[2]\n  phi &lt;- par[3]\n  \n  gamma_hat &lt;- switch(model,\n                      \"exponencial\" = sv_exp(nugget, sigma, h, phi),\n                      \"gaussian\"    = sv_gauss(nugget, sigma, h, phi),\n                      \"gneiting\"    = sv_gneiting(nugget, sigma, h, phi),\n                      \"spherical\"   = sv_spherical(nugget, sigma, h, phi),\n                      \"matern\"      = sv_matern(nugget, sigma, h, phi, kappa),\n                      \"cos\"         = cos_sv(nugget, sigma, h, phi)\n  )\n  \n  w &lt;- switch(pesos,\n              \"Cressie\" = 1/(2*(2*gamma_hat)^2/n),\n              \"n\" = 1/n,\n              \"h/n\" = 1/(h/n),\n              \"I\" = 1)\n  \n  sum(w*(gamma - gamma_hat)^2)\n}\n\n\nloglik &lt;- function(par, kappa=NA, z, dist_matrix, model){\n  sigma_0 &lt;- par[1]\n  phi_0 &lt;- par[2]\n  nugget_0 &lt;- par[3]\n  kappa_0 &lt;- kappa\n  \n  cov &lt;- switch(model,\n                \"exponencial\" = cov_exp,\n                \"gaussian\"    = cov_gauss,\n                \"spherical\"   = cov_spherical,\n                \"gneiting\"    = cov_gneiting,\n                \"matern\"      = cov_matern,\n                \"cos\"         = cov_cos \n  )\n  \n  args_cov &lt;- names(formals(cov))\n  \n  args_list &lt;- list(\n    sigma  = sigma_0,\n    nugget = nugget_0,\n    h      = dist_matrix,\n    phi    = phi_0,\n    kappa  = kappa_0\n  )\n  \n  args_list &lt;- args_list[names(args_list) %in% args_cov]\n  \n  Sigma &lt;- do.call(cov, args_list) \n  diag(Sigma) = diag(Sigma) + nugget_0\n  \n  if (!is.positive.definite(Sigma)) {\n    Sigma &lt;- as.matrix(nearPD(Sigma, corr = FALSE)$mat)\n  }\n  \n  # Descomposición de Cholesky (más estable que solve o det)\n  inv_Sigma &lt;- solve(Sigma)\n  det &lt;- log(det(Sigma))\n  \n  # Log-verosimilitud del modelo Gaussiano\n  z &lt;- z \n  n &lt;- length(z)\n  ll &lt;- -0.5 * (n * log(2 * pi) + det + crossprod(z, inv_Sigma %*% z))  # Log-verosimilitud (negativa porque optim minimiza)\n  return(-ll)\n}\n\nsv_ini &lt;- cos_sv(1.5, 1.5, vg1_WS$u, .6e5)\nn &lt;- vg1_WS$n\n\nvariog_WS &lt;- data.frame(h = vg1_WS$u, gamma_hat = vg1_WS$v,\n                       n = vg1_WS$n)\n\n# Cressie -------------------------------------------------\n\nWW &lt;- (2*(2*sv_ini)^2/n)\n\nBessel &lt;- nls(formula = gamma_hat ~cos_sv(nugget, sigma, h, phi),\n              start = c(nugget = 1.5, sigma = 1.5, phi = .6e5),\n              weights = 1/WW,\n              lower = rep(1e-6,3),\n              data = variog_WS,\n              control = nls.control(maxiter = 500, warnOnly = TRUE))\n\n\noptim_bessel &lt;- optim(\n  par = coef(Bessel),\n  fn = MSE_ponderados,\n  h = variog_WS$h,\n  gamma = variog_WS$gamma_hat,\n  pesos = \"Cressie\",\n  model = \"cos\",\n  n = n,\n  method = \"L-BFGS-B\",\n  lower = rep(1e-6,3)\n)\n\npar_optim_Bess &lt;- optim_bessel$par[c(\"nugget\", \"sigma\", \"phi\")]\n\n# 1/n ------------------------------------------------------\n\nW1 &lt;- n\n\nn_pond &lt;- nls(formula = gamma_hat ~cos_sv(nugget, sigma, h, phi),\n              start = c(nugget = 1.5, sigma = 1.5, phi = .6e5),\n              weights = 1/W1,\n              lower = rep(1e-6,3),\n              data = variog_WS,\n              control = nls.control(maxiter = 500, warnOnly = TRUE))\n\n\noptim_n &lt;- optim(\n  par = coef(n_pond),\n  fn = MSE_ponderados,\n  h = variog_WS$h,\n  gamma = variog_WS$gamma_hat,\n  pesos = \"n\",\n  model = \"cos\",\n  n = n,\n  method = \"L-BFGS-B\",\n  lower = rep(1e-6,3)\n)\n\npar_optim_n &lt;- optim_n$par[c(\"nugget\", \"sigma\", \"phi\")]\n\n# n/h -----------------------------------------------------\n\nW2 &lt;- variog_WS$h/n\n\nh_n_pond &lt;- nls(formula = gamma_hat ~cos_sv(nugget, sigma, h, phi),\n              start = c(nugget = 1.5, sigma = 1.5, phi = .6e5),\n              weights = 1/W2,\n              lower = rep(1e-6,3),\n              data = variog_WS,\n              control = nls.control(maxiter = 500, warnOnly = TRUE))\n\noptim_h_n &lt;- optim(\n  par = coef(h_n_pond),\n  fn = MSE_ponderados,\n  h = variog_WS$h,\n  gamma = variog_WS$gamma_hat,\n  pesos = \"h/n\",\n  model = \"cos\",\n  n = n,\n  method = \"L-BFGS-B\",\n  lower = rep(1e-6,3)\n)\n\npar_optim_h_n &lt;- optim_h_n$par[c(\"nugget\", \"sigma\", \"phi\")]\n\nI_pond &lt;- nls(formula = gamma_hat ~cos_sv(nugget, sigma, h, phi),\n              start = c(nugget = 1.5, sigma = 1.5, phi = .6e5),\n              lower = rep(1e-6,3),\n              data = variog_WS,\n              control = nls.control(maxiter = 500, warnOnly = TRUE))\n\n# MCO -----------------------------------------------------\n\noptim_I &lt;- optim(\n  par = coef(I_pond),\n  fn = MSE_ponderados,\n  h = variog_WS$h,\n  gamma = variog_WS$gamma_hat,\n  pesos = \"I\",\n  model = \"cos\",\n  n = n,\n  method = \"L-BFGS-B\",\n  lower = rep(1e-6,3)\n)\n\npar_optim_I &lt;- optim_I$par[c(\"nugget\", \"sigma\", \"phi\")]\n\nestcos_sv_Bess_WS &lt;- do.call(cos_sv, c(as.list(par_optim_Bess), list(h = h_range)))\nestcos_sv_n_WS &lt;- do.call(cos_sv, c(as.list(par_optim_n), list(h = h_range)))\nestcos_sv_h_n_WS &lt;- do.call(cos_sv, c(as.list(par_optim_h_n), list(h = h_range)))\nestcos_sv_I_WS &lt;- do.call(cos_sv, c(as.list(par_optim_I), list(h = h_range)))\n\n# Modelo wave ----------------------------------------------\n\nfitvar1 &lt;- variofit(vg1_WS,\n                    cov.model = \"wave\",\n                    c(3.5,.6e5),\n                    fix.nugget = F,\n                    wei = \"equal\")\nfitvar2 &lt;- variofit(vg1_WS,\n                    cov.model = \"wave\",\n                    c(3.5,.6e5),\n                    fix.nugget = F,\n                    wei = \"npairs\")\n\nfitvar3 &lt;- variofit(vg1_WS,\n                    cov.model = \"wave\",\n                    c(3.5,.6e5),\n                    fix.nugget = F,\n                    wei = \"cressie\")\n\nfitvar4_es_T &lt;- likfit(ws,\n                       coords = ws$coords,\n                       data = ws$data,\n                       trend = ~ Este*Norte,\n                       ini.cov.pars = c(3.5, .6e5),\n                       fix.nugget = F,\n                       nugget = 1.5,\n                       cov.model = \"wave\",\n                       lik.method = \"ML\")\n\n\n\nCoseno (Optim)Wave (GeoR)\n\n\n\n\nVer código\nplot(vg1_WS,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Removiendo tendencia\",\n     col.main = 4, cex.main =1.3)\nlines(h_range, estcos_sv_Bess_WS, col=\"#FF4040\", lwd=1.5)\nlines(h_range, estcos_sv_n_WS, col=\"#4169E1\", lwd=1.5)\nlines(h_range, estcos_sv_h_n_WS, col=\"#008B00\", lwd=1.5)\nlines(h_range, estcos_sv_I_WS, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"Cressie\", \"1/n\", \"n/h\", \"MCO\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(vg1_WS,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Removiendo tendencia\",\n     col.main = 4, cex.main =1.3)\n\nlines(fitvar1, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_es_T, col=\"#FFA500\", lwd=1.5)\n\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)",
    "crumbs": [
      "Análisis Geoestadístico",
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Análisis Bivariado</span>"
    ]
  },
  {
    "objectID": "Geo_bi.html#modelo-cruzado-de-semivarianza",
    "href": "Geo_bi.html#modelo-cruzado-de-semivarianza",
    "title": "2  Análisis Bivariado",
    "section": "2.2 Modelo cruzado de semivarianza",
    "text": "2.2 Modelo cruzado de semivarianza\nConsiderando un modelo esférico para Temperatura y un modelo Wave para WS, las matrices para el modelo de coregionalización son:\n\nmat1 &lt;- cbind(c(8, 3.5),\n              c(3.5, 1))\n\nmat2 &lt;-cbind(c(8, 3.5),\n             c(3.5, 1))\n\n\n\nVer código\ndatosT1 &lt;- datosT\ndatosWS1 &lt;- datosWS\ninvisible(coordinates(datosT1) &lt;- ~ Este + Norte)\ninvisible(coordinates(datosWS1) &lt;- ~ Este + Norte)\n\n\nvgmntemp &lt;- vgm(psill = mat1[1, 1],\n              model = \"Sph\",\n              range = 2e5,\n              nugget = .5,\n              add.to = vgm(psill = mat2[1, 1],\n                           model = \"Wav\",\n                           range = .5e5, nugget = 2))\n\nvgmws &lt;- vgm(psill = mat1[2, 2],\n             model = \"Sph\",\n             range = 2e5,\n             nugget = .5,\n             add.to = vgm(psill = mat2[2, 2],\n                          model = \"Wav\",\n                          range = .5e5, nugget = 2))\n\n\nvgmntemp_sv &lt;- vgm(psill = mat1[1, 2], model = \"Sph\",\n                 range = 2e5,\n                 nugget = .5,\n                 add.to = vgm(psill = mat2[1, 2],\n                              model = \"Wav\",\n                              range = .5e5, nugget = 2))\n\n\n\ng &lt;- gstat(NULL, id=\"Temp\", formula=Temperatura~Norte+I(Norte^2),\n           data=datosT1, model = vgmntemp)\ng &lt;- gstat(g, id=\"W_speed\", formula=WindSpeed~Norte*Este,\n           data=datosWS1, model = vgmws)\ng &lt;- gstat(g, c(\"Temp\",\"W_speed\"), model = vgmntemp_sv)\n\nplot(variogram(g),\n     model = g$model,\n     pl = F,\n     xlab = \"Distancias\",\n     ylab = \"Semivarianza\")",
    "crumbs": [
      "Análisis Geoestadístico",
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Análisis Bivariado</span>"
    ]
  },
  {
    "objectID": "Geo_uni.html#análisis-geoestadístico",
    "href": "Geo_uni.html#análisis-geoestadístico",
    "title": "1  Análisis Univariado",
    "section": "1.3 Análisis geoestadístico",
    "text": "1.3 Análisis geoestadístico\n\n1.3.1 Variable Ozono\nSe tomaron los datos de Temperatura de la madrugada el primero de marzo de 2024:\n\n\nVer código\ny_oz &lt;- Ozono[1,] #Tomar una fecha\ny_oz &lt;- cbind(colnames(y_oz),t(y_oz[1,]))\ny_oz &lt;- y_oz[-1,]\ny_oz &lt;- as.data.frame(y_oz)\ny_oz &lt;- na.omit(y_oz)\ny_oz$V1 &lt;- as.numeric(y_oz$V1)\ny_oz &lt;- inner_join(y_oz, EstacionesOz, by=c(\"V1\"=\"AQSID\"))\ndatosOZ &lt;- y_oz[,c(13,14,2)] #DatosOz es la base con coordenadas + variable\ncolnames(datosOZ)=c(\"Este\",\"Norte\",\"Ozono\")\ndatosOZ$Ozono &lt;- as.numeric(datosOZ$Ozono)\n\ndatosOZ_sf &lt;- st_as_sf(datosOZ, coords = c(\"Este\", \"Norte\"), crs = 3310)\n\ndatosO_sf_wgs84 &lt;- st_transform(datosOZ_sf, crs = 4326)\n\npalO &lt;- colorNumeric(palette = \"viridis\", domain = datosO_sf_wgs84$Ozono)\n\nleaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addPolygons(data = sh_mundos_wgs84, fill = FALSE, color = \"black\", weight = 2) %&gt;%\n  addCircleMarkers(data = datosO_sf_wgs84,\n                   fillColor = ~palO(Ozono),\n                   fillOpacity = 0.8,\n                   color = \"black\",\n                   weight = 1,\n                   radius = 3,\n                   popup = ~paste(\"Ozono:\", Ozono, \"°C\")) %&gt;%\n  addLegend(pal = palO, values = datosO_sf_wgs84$Ozono, title = \"Ozono (ppb)\")\n\n\n\n\n\n\nVer código\nozone &lt;- as.geodata(datosOZ) \npander::pander(summary(ozone))\n\n\n\nn: 139\ncoords.summary:\n\n\n\n\n\n\n\n\n \nEste\nNorte\n\n\n\n\nmin\n-276541\n-598934\n\n\nmax\n500862\n415184\n\n\n\ndistances.summary:\n\n\n\n\n\n\n\nmin\nmax\n\n\n\n\n6305\n1187480\n\n\n\ndata.summary:\n\n\n\n\n\n\n\n\n\n\n\nMin.\n1st Qu.\nMedian\nMean\n3rd Qu.\nMax.\n\n\n\n\n20\n35\n38\n37.48\n40.5\n53\n\n\n\n\n\n\n\n\nGráficos de dispersiónGeoR\n\n\n\n\nVer código\npO1 &lt;- simple_scatter_plot(datosOZ, \"Este\", \"Ozono\")\npO2 &lt;- simple_scatter_plot(datosOZ, \"Norte\", \"Ozono\")\n\ncowplot::plot_grid(pO1,pO2)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(ozone, qt.col = c(\"purple\",\n                          \"pink\",\n                          \"green\",\n                          \"yellow\"),\n     scatter3d=T)\n\n\n\n\n\n\n\n\n\n\n\n\nEl gráfico muestra una relación polinomial de la variable Ozono con respecto a las coordenadas en Norte. Se prueba con varios modelos hasta encontrar aquel que mitigue el efecto espacial.\n\n1.3.1.1 Modelo para la Media\nEl modelo que mejor atrapa el efecto de la media es:\nOzono = \\beta_0+\\beta_1 \\times Norte^2 + \\beta_2 \\times Norte^3 + \\beta_3 \\times Este\n\n\nVer código\nfitO &lt;- lm(Ozono~I(Norte^2)+I(Norte^3)+Este, data = datosOZ) \npander::pander(summary(fitO))\n\n\n\n\n\n\n\n\n\n\n\n\n \nEstimate\nStd. Error\nt value\nPr(&gt;|t|)\n\n\n\n\n(Intercept)\n34.99\n0.6033\n58\n2.656e-97\n\n\nI(Norte^2)\n5.085e-11\n1.078e-11\n4.716\n5.931e-06\n\n\nI(Norte^3)\n7.94e-17\n1.922e-17\n4.131\n6.297e-05\n\n\nEste\n1.416e-05\n3.326e-06\n4.257\n3.855e-05\n\n\n\n\nFitting linear model: Ozono ~ I(Norte^2) + I(Norte^3) + Este\n\n\n\n\n\n\n\n\nObservations\nResidual Std. Error\nR^2\nAdjusted R^2\n\n\n\n\n139\n3.984\n0.4223\n0.4094\n\n\n\n\n\nGráficamente se observa una mitigación en la tendencia espacial:\n\nGráficos de dispersiónGeoR\n\n\n\n\nVer código\ndatosOZ$Residuos &lt;- fitO$residuals\n\npO1 &lt;- simple_scatter_plot(datosOZ, \"Este\", \"Residuos\")\npO2 &lt;- simple_scatter_plot(datosOZ, \"Norte\", \"Residuos\")\n\ncowplot::plot_grid(pO1,pO2)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(ozone, qt.col = c(\"purple\",\n                          \"pink\",\n                          \"green\",\n                          \"yellow\"),\n     scatter3d=T, trend = ~ poly(Norte,3))\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.1.2 Estimación Empírica del Semivariograma\nA continuación, se presenta la estimación del semivariograma obtenida con la función variog. Se muestran dos gráficos comparativos: el primero corresponde a los datos originales (sin eliminar la tendencia) y el segundo a los residuales obtenidos tras ajustar el modelo de regresión, lo que permite observar el efecto de remover la tendencia en la estructura espacial.\n\n\nVer código\nvg_O &lt;- variog(ozone,estimator.type = \"modulus\", pairs.min=50) #Sin tendencia espacial\n\nvg1_O &lt;- variog(ozone, trend = ~I(Norte^2)+I(Norte^3)+Este, estimator.type = \"modulus\", pairs.min=50)\n\n\n\nCon tendenciaRemoviendo Tendencia\n\n\n\n\nVer código\nplot(vg_O,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Sin remover tendencia\",\n     col.main = 4, cex.main =1.3)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(vg1_O,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Removiendo tendencia\",\n     col.main = 4, cex.main =1.3)\n\n\n\n\n\n\n\n\n\n\n\n\nSe observa que la estimación de la semivarianza de la variable incrementos es más estable y presenta valores más bajos al remover la tendencia, lo que indica que en este caso el semivariograma refleja de manera más adecuada la verdadera estructura espacial del fenómeno.\n\n\nVer código\nplot(vg1_O$u, vg1_O$n, type=\"b\",\n     xlab=\"distance\", ylab=\"n pairs\",\n     main=\"Número de pares por bin\")\n\n\n\n\n\n\n\n\n\n\n\n1.3.1.3 Estimación del Modelo Teórico de Semivariograma\nLos modelos obtenidos ajustanto por EyeFit, son:\ncov.model sigmasq      phi tausq kappa kappa2 practicalRange\n1    matern    17.0 440676.0     5   0.5     NA        1320147\n2  gneiting    17.5 803585.6     9    NA     NA        1371348\n3    linear    0.25 0.32     0    NA     NA            Inf\n\nMaternGneitingExponencialEsféricoCúbico\n\n\n\n\nVer código\nsigma_0_mO &lt;- 12.0\nphi_0_mO &lt;- 224249.7\nnugget_0_mO &lt;- 2.00 \nkappa_0_mO &lt;- 0.2\n\nini1_mat_O &lt;- c(sigma_0_mO, phi_0_mO)\nfitvar1_mat_O &lt;- variofit(vg1_O,\n                    cov.model = \"matern\",\n                    ini1_mat_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_mO,\n                    kappa = kappa_0_mO,\n                    wei = \"equal\")\n\nfitvar2_mat_O &lt;- variofit(vg1_O,\n                    cov.model = \"matern\",\n                    ini1_mat_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_mO,\n                    kappa = kappa_0_mO,\n                    wei = \"npairs\")\n\nfitvar3_mat_O &lt;- variofit(vg1_O,\n                    cov.model = \"matern\",\n                    ini1_mat_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_mO,\n                    kappa = kappa_0_mO,\n                    wei = \"cressie\")\n\nfitvar4_mat_O &lt;- likfit(ozone,\n                  coords = ozone$coords,\n                  data = ozone$data,\n                  trend = ~ I(Norte^2) + I(Norte^3) + Este,\n                  ini.cov.pars = ini1_mat_O,\n                  fix.nugget = F,\n                  nugget = nugget_0_mO,\n                  kappa = kappa_0_mO,\n                  cov.model = \"matern\",\n                  lik.method = \"ML\")\n\n\nplot(vg1_O,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar1_mat_O, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_mat_O, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_mat_O, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_mat_O, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nsigma_0_gO &lt;- 17.5\nphi_0_gO &lt;- 803585.6\nnugget_0_gO &lt;- 9\n\nini1_g_O &lt;- c(sigma_0_gO, phi_0_gO)\nfitvar1_g_O &lt;- variofit(vg1_O,\n                    cov.model = \"gneiting\",\n                    ini1_g_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_gO,\n                    wei = \"equal\")\n\nfitvar2_g_O &lt;- variofit(vg1_O,\n                    cov.model = \"gneiting\",\n                    ini1_g_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_gO,\n                    wei = \"npairs\")\n\nfitvar3_g_O &lt;- variofit(vg1_O,\n                    cov.model = \"gneiting\",\n                    ini1_g_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_gO,\n                    wei = \"cressie\")\n\nfitvar4_g_O &lt;- likfit(ozone,\n                  coords = ozone$coords,\n                  data = ozone$data,\n                  trend = ~ I(Norte^2) + I(Norte^3) + Este,\n                  ini.cov.pars = ini1_g_O,\n                  fix.nugget = F,\n                  nugget = nugget_0_gO,\n                  cov.model = \"gneiting\",\n                  lik.method = \"ML\")\n\n\nplot(vg1_O,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar1_g_O, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_g_O, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_g_O, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_g_O, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nsigma_0_lO &lt;- 10\nphi_0_lO &lt;- 6e5\nnugget_0_lO &lt;- 10\n\nini1_l_O &lt;- c(sigma_0_lO, phi_0_lO)\nfitvar1_l_O &lt;- variofit(vg1_O,\n                    cov.model = \"exponential\",\n                    ini1_l_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_lO,\n                    wei = \"equal\")\n\nfitvar2_l_O &lt;- variofit(vg1_O,\n                    cov.model = \"exponential\",\n                    ini1_l_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_lO,\n                    wei = \"npairs\")\n\nfitvar3_l_O &lt;- variofit(vg1_O,\n                    cov.model = \"exponential\",\n                    ini1_l_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_lO,\n                    wei = \"cressie\")\n\nfitvar4_l_O &lt;- likfit(ozone,\n                  coords = ozone$coords,\n                  data = ozone$data,\n                  trend = ~ I(Norte^2) + I(Norte^3) + Este,\n                  ini.cov.pars = ini1_l_O,\n                  fix.nugget = F,\n                  nugget = nugget_0_lO,\n                  cov.model = \"exponential\",\n                  lik.method = \"ML\")\n\n\nplot(vg1_O,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar1_l_O, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_l_O, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_l_O, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_l_O, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nsigma_0_lO &lt;- 10\nphi_0_lO &lt;- 6e5\nnugget_0_lO &lt;- 10\n\nini1_l_O &lt;- c(sigma_0_lO, phi_0_lO)\nfitvar1_es_O &lt;- variofit(vg1_O,\n                    cov.model = \"spherical\",\n                    ini1_l_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_lO,\n                    wei = \"equal\")\n\nfitvar2_es_O &lt;- variofit(vg1_O,\n                    cov.model = \"spherical\",\n                    ini1_l_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_lO,\n                    wei = \"npairs\")\n\nfitvar3_es_O &lt;- variofit(vg1_O,\n                    cov.model = \"spherical\",\n                    ini1_l_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_lO,\n                    wei = \"cressie\")\n\nfitvar4_es_O &lt;- likfit(ozone,\n                  coords = ozone$coords,\n                  data = ozone$data,\n                  trend = ~ I(Norte^2) + I(Norte^3) + Este,\n                  ini.cov.pars = ini1_l_O,\n                  fix.nugget = F,\n                  nugget = nugget_0_lO,\n                  cov.model = \"spherical\",\n                  lik.method = \"ML\")\n\n\nplot(vg1_O,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar1_es_O, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_es_O, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_es_O, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_es_O, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nsigma_0_lO &lt;- 10\nphi_0_lO &lt;- 6e5\nnugget_0_lO &lt;- 10\n\nini1_l_O &lt;- c(sigma_0_lO, phi_0_lO)\nfitvar1_c_O &lt;- variofit(vg1_O,\n                    cov.model = \"cubic\",\n                    ini1_l_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_lO,\n                    wei = \"equal\")\n\nfitvar2_c_O &lt;- variofit(vg1_O,\n                    cov.model = \"cubic\",\n                    ini1_l_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_lO,\n                    wei = \"npairs\")\n\nfitvar3_c_O &lt;- variofit(vg1_O,\n                    cov.model = \"cubic\",\n                    ini1_l_O,\n                    fix.nugget = F,\n                    nugget = nugget_0_lO,\n                    wei = \"cressie\")\n\nfitvar4_c_O &lt;- likfit(ozone,\n                  coords = ozone$coords,\n                  data = ozone$data,\n                  trend = ~ I(Norte^2) + I(Norte^3) + Este,\n                  ini.cov.pars = ini1_l_O,\n                  fix.nugget = F,\n                  nugget = nugget_0_lO,\n                  cov.model = \"cubic\",\n                  lik.method = \"ML\")\n\n\nplot(vg1_O,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar1_c_O, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_c_O, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_c_O, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_c_O, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.1.4 Kriging\nUsando el modelo exponencial:\n\n\nVer código\nplot(vg1_O,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Modelo exponencial para Ozono\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar3_l_O, col=\"#008B00\", lwd=1.5)\n\n\n\n\n\n\n\n\n\n\n\nVer código\n#Se ajusta el mejor modelo -------------------------------\n\nbest_model_O &lt;- gstat::vgm(psill = fitvar3_l_O$cov.pars[1],\n                           model = \"Exp\",\n                           range = fitvar3_l_O$cov.pars[2],\n                           nugget = fitvar3_l_O$nugget\n                           \n)\n\n# Se crea un objeto en gstat ------------------------------\n\ncoordinates(datosOZ) &lt;- ~Este + Norte\nproj4string(datosOZ) &lt;- CRS(\"EPSG:3310\")\n\ng_obj&lt;-gstat::gstat(id=\"Ozono\",\n             formula = Ozono ~ I(Norte^2) + I(Norte^3) + Este,\n             model = best_model_O,\n             data = datosOZ)\n\n#Kriging ------------------------------------------------\n\ninvisible(predic &lt;- predict(g_obj, newdata = new, nmin = 20))\n\n\n#Mapas de predicción -------------------------------------\n\ngridded(predic) &lt;- TRUE\n\n#1. Mapa de Kriging --------------------------------------\n\npredic_raster_utm &lt;- raster(predic, layer = \"Ozono.pred\")\n\ncrs(predic_raster_utm) &lt;- \"+init=epsg:3310\"\n\npredic_raster_wgs84 &lt;- raster::projectRaster(\n    raster::mask(\n        predic_raster_utm, \n        sh_mundos_sp_utm_simple\n    ),\n    crs = \"+init=epsg:4326\", \n    method = \"bilinear\"\n)\n\nmin_pred &lt;- raster::cellStats(predic_raster_wgs84, stat='min')\nmax_pred &lt;- raster::cellStats(predic_raster_wgs84, stat='max')\n\npred_range &lt;- c(minValue(predic_raster_wgs84), maxValue(predic_raster_wgs84))\n\nstep_pred &lt;- (max_pred-min_pred)/ 6\n\nbins &lt;- round(seq(min_pred, max_pred, by=step_pred),0)\n\npal_pred &lt;- colorBin(\n  palette = \"viridis\", # La paleta de colores\n  domain = pred_range,\n  bins = bins,\n  na.color = \"transparent\"\n)\n\nmapa_kriging_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    predic_raster_wgs84, \n    colors = pal_pred, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n    addCircleMarkers(data = datosO_sf_wgs84,\n                   fillColor = ~palO(Ozono),\n                   fillOpacity = 0.8,\n                   color = \"black\",\n                   weight = 1,\n                   radius = 3,\n                   popup = ~paste(\"Ozn:\", Ozono, \"ppb\")) %&gt;% \n  \n  addLegend(\n    pal = pal_pred, \n    values = pred_range,\n    title = \"Predicción Oz ppb\",\n    position = \"topright\"\n  ) %&gt;%\n  \n  addLegend(pal = palO,\n            values = datosO_sf_wgs84$Ozono,\n            title = \"Ozono Observado\",\n    position = \"topleft\"\n  ) \n\n#2 Mapa Varianza------------------------------------------\n\nvar_raster_utm &lt;- raster(predic, layer = \"Ozono.var\")\n\ncrs(var_raster_utm) &lt;- \"+init=epsg:3310\"\n\nvar_raster_wgs84 &lt;- raster::projectRaster(\n    raster::mask(\n        var_raster_utm, \n        sh_mundos_sp_utm_simple\n    ),\n    crs = \"+init=epsg:4326\", \n    method = \"bilinear\"\n)\n\nmax_var &lt;- raster::cellStats(var_raster_wgs84, stat='max')\nstep_var &lt;- max_var / 6\n\nbinsv &lt;- round(seq(0, max_var, by=step_var),2)\n\nvar_range &lt;- c(minValue(var_raster_wgs84), maxValue(var_raster_wgs84))\npal_var &lt;- colorBin(\n  palette = \"Spectral\", # La paleta de colores\n  domain = var_range,\n  bins = binsv,\n  na.color = \"transparent\"\n)\n\nmapa_var_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    var_raster_wgs84,\n    colors = pal_var, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n  addLegend(\n    pal = pal_var, \n    values = var_range,\n    title = \"Varianza\",\n    position = \"topright\"\n  ) \n\n#3. Mapa Cv ----------------------------------------------\n\ncv_raster_utm &lt;- sqrt(var_raster_utm) / abs(predic_raster_utm)\n\nmapa_mayor_a_uno &lt;- cv_raster_utm &gt; 1\ncv_raster_utm[mapa_mayor_a_uno] &lt;- 1\n\ncrs(cv_raster_utm) &lt;- \"+init=epsg:3310\"\n\ncv_terra &lt;- terra::rast(cv_raster_utm)\nsh_terra &lt;- terra::vect(sh_mundos_sp_utm_simple)\n\nmasked_cv_terra &lt;- terra::mask(cv_terra, sh_terra)\n\ncv_raster_wgs84_terra &lt;- terra::project(\n    masked_cv_terra, \n    y = \"epsg:4326\", \n    method = \"bilinear\" # Similar a projectRaster\n)\n\ncv_raster_wgs84 &lt;- raster::raster(cv_raster_wgs84_terra)\n\nmax_cv &lt;- raster::cellStats(cv_raster_wgs84, stat='max')\nstep_cv &lt;- max_cv / 10\n\nbincv &lt;- seq(0,max_cv, by=step_cv)\n\ncv_range &lt;- c(minValue(cv_raster_wgs84), maxValue(cv_raster_wgs84))\n\npal_cv &lt;- colorBin(\n  palette = \"RdYlGn\", # Rojo-Amarillo-Verde\n  domain = cv_range,\n  na.color = \"transparent\",\n  bins = bincv,\n  reverse = TRUE\n)\n\nmapa_cv_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    cv_raster_wgs84,\n    colors = pal_cv, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n  addLegend(\n    pal = pal_cv, \n    values = cv_range,\n    title = \"Coeficiente de Variación\",\n    position = \"topright\"\n  )\n\n\n\nPredicciónVarianzaCoeficiente de variación\n\n\n\n\nVer código\nmapa_kriging_leaflet\n\n\n\n\n\n\n\n\n\n\nVer código\nmapa_var_leaflet\n\n\n\n\n\n\n\n\n\n\nVer código\nmapa_cv_leaflet\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.2 Variable Temperatura\nSe tomaron los datos de Temperatura de la madrugada el primero de marzo de 2024:\n\n\nVer código\ny_T &lt;- Temp[1,] #Tomar una fecha\ny_T &lt;- cbind(colnames(y_T),t(y_T[1,]))\ny_T &lt;- y_T[-1,]\ny_T &lt;- as.data.frame(y_T)\ny_T &lt;- na.omit(y_T)\ny_T &lt;- y_T[-which.min(y_T$V2),]\ny_T$V1 &lt;- as.numeric(y_T$V1)\ny_T &lt;- inner_join(y_T, EstacionesT, by=c(\"V1\"=\"AQSID\"))\ndatosT &lt;- y_T[,c(13,14,2)]\ncolnames(datosT)=c(\"Este\",\"Norte\",\"Temperatura\")\ndatosT$Temperatura &lt;- as.numeric(datosT$Temperatura)\n\ndatosT_sf &lt;- st_as_sf(datosT, coords = c(\"Este\", \"Norte\"), crs = 3310)\n\ndatosT_sf_wgs84 &lt;- st_transform(datosT_sf, crs = 4326)\n\npal &lt;- colorNumeric(palette = \"viridis\", domain = datosT_sf_wgs84$Temperatura)\n\nleaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addPolygons(data = sh_mundos_wgs84, fill = FALSE, color = \"black\", weight = 2) %&gt;%\n  addCircleMarkers(data = datosT_sf_wgs84,\n                   fillColor = ~pal(Temperatura),\n                   fillOpacity = 0.8,\n                   color = \"black\",\n                   weight = 1,\n                   radius = 3,\n                   popup = ~paste(\"Temp:\", Temperatura, \"°C\")) %&gt;%\n  addLegend(pal = pal, values = datosT_sf_wgs84$Temperatura, title = \"Temperatura (°C)\")\n\n\n\n\n\n\nVer código\ntemp &lt;- as.geodata(datosT) \npander::pander(summary(temp))\n\n\n\nn: 122\ncoords.summary:\n\n\n\n\n\n\n\n\n \nEste\nNorte\n\n\n\n\nmin\n-325701\n-580919\n\n\nmax\n387270\n281577\n\n\n\ndistances.summary:\n\n\n\n\n\n\n\nmin\nmax\n\n\n\n\n609.2\n1e+06\n\n\n\ndata.summary:\n\n\n\n\n\n\n\n\n\n\n\nMin.\n1st Qu.\nMedian\nMean\n3rd Qu.\nMax.\n\n\n\n\n-3.2\n13.15\n15.8\n14.43\n17.2\n24.5\n\n\n\n\n\n\n\n\nGráficos de dispersiónGeoR\n\n\n\n\nVer código\npT1 &lt;- simple_scatter_plot(datosT, \"Este\", \"Temperatura\")\npT2 &lt;- simple_scatter_plot(datosT, \"Norte\", \"Temperatura\")\n\ncowplot::plot_grid(pT1,pT2)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(temp, qt.col = c(\"purple\",\n                    \"pink\",\n                    \"green\",\n                    \"yellow\"),\n     scatter3d=T)\n\n\n\n\n\n\n\n\n\n\n\n\nEn el gráfico se observa un agrupamiento en las coordenadas Norte con respecto a los datos, que puede llegar a corregirse con algún polinomio. Se probará con diferentes modelos a ver si se puede llegar a disminuir el efecto espacial.\n\n1.3.2.1 Modelo para la Media\nEl modelo que mejor atrapa el efecto de la media es:\n\nTemperatura = \\beta_0 + \\beta_1 \\times Norte + \\beta_2 \\times Norte^2\n\n\n\nVer código\nfitT &lt;- lm(Temperatura~Norte+I(Norte^2), data = datosT) \npander::pander(summary(fitT))\n\n\n\n\n\n\n\n\n\n\n\n\n \nEstimate\nStd. Error\nt value\nPr(&gt;|t|)\n\n\n\n\n(Intercept)\n13.26\n0.5352\n24.77\n8.812e-49\n\n\nNorte\n-2.229e-05\n3.23e-06\n-6.901\n2.676e-10\n\n\nI(Norte^2)\n-3.754e-11\n8.551e-12\n-4.39\n2.469e-05\n\n\n\n\nFitting linear model: Temperatura ~ Norte + I(Norte^2)\n\n\n\n\n\n\n\n\nObservations\nResidual Std. Error\nR^2\nAdjusted R^2\n\n\n\n\n122\n4.049\n0.3199\n0.3084\n\n\n\n\n\nObservamos el comportamiento de sus residuales podemos notar que el modelo ayudo a reducir el efecto espacial.\n\nGráficos de dispersiónGeoR\n\n\n\n\nVer código\ndatosT$Residuos &lt;- fitT$residuals\n\npT1 &lt;- simple_scatter_plot(datosT, \"Este\", \"Residuos\")\npT2 &lt;- simple_scatter_plot(datosT, \"Norte\", \"Residuos\")\n\ncowplot::plot_grid(pT1,pT2)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(temp, qt.col = c(\"purple\",\n                    \"pink\",\n                    \"green\",\n                    \"yellow\"),\n     scatter3d=T, trend=~Norte+I(Norte^2))\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.2.2 Estimación Empírica del Semivariograma\np¿Presentamos la estimación del semivariograma obtenida mediante la función variog para la variable temperatura. Se comparan los resultados al calcularlo directamente sobre los datos originales (sin remover la tendencia) y al utilizar los residuales de un modelo de regresión, con el objetivo de analizar cómo influye la presencia de tendencia en la estructura espacial.\n\n\nVer código\nvg_T &lt;- variog(temp, estimator.type = \"modulus\", pairs.min=50) #Sin tendencia espacial\n\nvg1_T &lt;- variog(temp, trend = ~Norte+I(Norte^2),\n                estimator.type = \"modulus\", pairs.min=50)\n\n\n\nCon tendenciaRemoviendo tendencia\n\n\n\n\nVer código\nplot(vg_T,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Sin remover tendencia\",\n     col.main = 4, cex.main =1.3)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(vg1_T,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Removiendo tendencia\",\n     col.main = 4, cex.main =1.3)\n\n\n\n\n\n\n\n\n\n\n\n\nCuando no se remueve la tendencia, la semivarianza alcanza valores más altos y presenta una forma aparentemente más regular, aunque dicha regularidad está influenciada por la tendencia global de los datos. En cambio, al eliminar la tendencia, los valores de semivarianza disminuyen y el patrón pierde suavidad, pero el variograma refleja con mayor fidelidad la verdadera dependencia espacial.\n\n\nVer código\nplot(vg1_T$u, vg1_T$n, type=\"b\",\n     xlab=\"distance\", ylab=\"n pairs\",\n     main=\"Número de pares por bin\")\n\n\n\n\n\n\n\n\n\nEn este caso, el último punto corresponde a menos de 25 pares de observaciones, por lo que su interpretación resulta menos confiable.\n\n\n1.3.2.3 Estimación del Modelo Teórico de Semivariograma\n\n\nVer código\ndist_matrix_T &lt;- as.matrix(dist(temp$coords))\n\n#1. Funciones de correlación, covarianza y semivarianza: ----\n\n#1.1 Modelo exponencial ----\n\nrho_exp &lt;- function(h, phi){\n  exp(-(h/phi)) #Correlacion espacial\n}\n\ncov_exp &lt;- function(sigma, h, phi){\n  sigma*rho_exp(h, phi) #Covarianza espacial\n}\n\nsv_exp &lt;- function(nugget, sigma, h, phi){\n  nugget + sigma - cov_exp(sigma, h, phi) #Semivarianza espacial\n} \n\n#1.2 Modelo Gaussianio ----\n\nrho_gauss &lt;- function(h, phi){\n  exp(-(h/phi)^2)\n}\n\ncov_gauss &lt;- function(sigma, h, phi){\n  sigma*rho_gauss(h, phi) #Covarianza espacial\n}\n\nsv_gauss &lt;- function(nugget, sigma, h, phi){\n  nugget + sigma - cov_gauss(sigma, h, phi) #Semivarianza espacial\n}\n#1.3 Modelo Gneting ----\n\ncov_gneiting &lt;- function(h){\n  s &lt;- 0.301187465825\n  ifelse(0&lt;= s*h &  s*h &lt;= 1,\n  (1 + 8*s*h + 25*(s*h)^2 + 32*(s*h)^3) * (1-s*h)^8,\n  0)\n}\n\nsv_gneiting &lt;- function(nugget, sigma, h){\n  nugget + sigma - cov_gneiting(h) #Semivarianza espacial\n}\n\n#1.4 Modelo Spherical ----\n\nrho_spherical &lt;- function(h, phi){\n  ifelse(h&lt;phi,\n         1 - 1.5*(h/phi) + 0.5*(h/phi)^3,\n         0)\n}\n\ncov_spherical &lt;- function(sigma, h, phi){\n  sigma*rho_spherical(h, phi) #Covarianza espacial\n}\n\nsv_spherical &lt;- function(nugget, sigma, h, phi){\n  nugget + sigma - cov_spherical(sigma, h, phi) #Semivarianza espacial\n}\n\n#1.5 Modelo Matern ----\n\nrho_matern &lt;- function(h, phi, kappa){\n  (1/(2*gamma(kappa))) * (h/phi)^kappa * besselK((h/phi), kappa)\n}\n\ncov_matern &lt;- function(sigma, h, phi, kappa){\n  sigma*rho_matern(h, phi, kappa) #Covarianza espacial\n}\n\nsv_matern &lt;- function(nugget, sigma, h, phi, kappa){\n  nugget + sigma - cov_matern(sigma, h, phi, kappa) #Semivarianza espacial\n}\n\n#1.6 Modelo Coseno -----------------\n\ncov_cos &lt;- function(sigma, h, phi){\n  sigma * cos(h/phi)\n}\n\ncos_sv &lt;- function(nugget, sigma, h, phi){\n  nugget +  sigma *(1 - cos(h/phi))\n}\n\n#1.7 Modelo wave ------\n\n\nrho_wave &lt;- function(h, sigma, phi){\n  ifelse(h == 0,\n         1,\n         (phi / h) * sin(h / phi))\n}\n\nsv_wave &lt;- function(nugget, sigma, h, phi) {\n  ifelse(h == 0,\n         nugget,\n         nugget + sigma - sigma * (phi / h) * sin(h / phi))\n}\n\ncov_wave &lt;- function(h, sigma, phi, nugget) {\n  ifelse(h == 0,\n         sigma,\n         sigma * (phi / h) * sin(h / phi))\n}\n\n\n#2. Función para estimar por WLS----\n\nMSE_ponderados &lt;- function(par, h, gamma,kappa=NA,w, model, n, pesos){\n  nugget &lt;- par[1]\n  sigma &lt;- par[2]\n  phi &lt;- par[3]\n  \n  gamma_hat &lt;- switch(model,\n                      \"exponencial\" = sv_exp(nugget, sigma, h, phi),\n                      \"gaussian\"    = sv_gauss(nugget, sigma, h, phi),\n                      \"gneiting\"    = sv_gneiting(nugget, sigma, h, phi),\n                      \"spherical\"   = sv_spherical(nugget, sigma, h, phi),\n                      \"matern\"      = sv_matern(nugget, sigma, h, phi, kappa),\n                      \"cos\"         = cos_sv(nugget, sigma, h, phi)\n  )\n  \n  w &lt;- switch(pesos,\n              \"Cressie\" = 1/(2*(2*gamma_hat)^2/n),\n              \"n\" = 1/n,\n              \"h/n\" = 1/(h/n),\n              \"I\" = 1)\n  \n  sum(w*(gamma - gamma_hat)^2)\n}\n\n\nest_sev_WLS &lt;- function(par, kappa = NA, model, h, gamma, n){\n  sigma_0 &lt;- par[1]\n  phi_0 &lt;- par[2]\n  nugget_0 &lt;- par[3]\n  kappa_0 &lt;- kappa\n  \n  # Selección de función\n  sv &lt;- switch(model,\n               \"exponencial\" = sv_exp,\n               \"gaussian\"    = sv_gauss,\n               \"spherical\"   = sv_spherical,\n               \"gneiting\"    = sv_gneiting,\n               \"matern\"      = sv_matern,\n               \"cos\" = cos_sv\n  )\n  \n  args_sv &lt;- names(formals(sv))\n  \n  args_list &lt;- list(\n    nugget = nugget_0,\n    sigma  = sigma_0,\n    h      = h,\n    phi    = phi_0,\n    kappa  = kappa_0\n  )\n  \n  args_list &lt;- args_list[names(args_list) %in% args_sv]\n  \n  sv_ini &lt;- do.call(sv, args_list)\n  \n  formula_sv &lt;- switch(model,\n                       \"gneiting\" = gamma ~ sv(nugget, sigma, h),\n                       \"matern\" = gamma ~ sv(nugget, sigma, h, phi, kappa),\n                       gamma ~ sv(nugget, sigma, h, phi)\n  )\n  \n  start_list &lt;- switch(model,\n                       \"gneting\" = list(nugget = nugget_0, sigma = sigma_0),\n                       \"matern\" = list(nugget = nugget_0, sigma = sigma_0, phi = phi_0, kappa = kappa_0),\n                       list(nugget = nugget_0, sigma = sigma_0, phi = phi_0)\n  )\n    \n    #1. Ponderación de Bessel\n    \n    WW &lt;- (2*(2*sv_ini)^2/n)\n    \n    Bessel &lt;- nls(formula = formula_sv,\n                  start = start_list,\n                  weights = 1/WW,\n                  lower = c(0, rep(1e-6, length(start_list)-1)),\n                  control = nls.control(maxiter = 500, warnOnly = TRUE))\n    \n    ini_Bessel&lt;-coef(Bessel)\n    \n    #1.1 Optim Bessel\n    \n    optim_bessel &lt;- optim(\n      par = coef(Bessel),\n      fn = MSE_ponderados,\n      h = h,\n      gamma = gamma,\n      pesos = \"Cressie\",\n      model = model,\n      n = n,\n      method = \"L-BFGS-B\",\n      lower = c(0, rep(1e-6, length(start_list)-1))\n    )\n    \n    par_optim_Bess &lt;- optim_bessel$par[c(\"nugget\", \"sigma\", \"phi\")]\n    \n    #2. Ponderación 1/n\n    \n    W1 &lt;- n\n    \n    n_pond &lt;- nls(formula = formula_sv,\n                  start = start_list,\n                  weights = 1/W1,\n                  lower = c(0, rep(1e-6, length(start_list)-1)),\n                  control = nls.control(maxiter = 500, warnOnly = TRUE))\n    \n    ini_n&lt;-coef(n_pond)\n    \n    #2.1 Optimización 1/n\n    \n    optim_n &lt;- optim(\n      par = coef(n_pond),\n      fn = MSE_ponderados,\n      h = h,\n      gamma = gamma,\n      pesos = \"n\",\n      n = n,\n      model = model,\n      method = \"L-BFGS-B\",\n      lower = c(0, rep(1e-6, length(start_list)-1))\n    )    \n    \n    par_optim_n &lt;- optim_n$par[c(\"nugget\", \"sigma\", \"phi\")]\n    \n    \n    #3. Ponderación h/n\n    \n    W2 &lt;- h/n\n    \n    h_n_pond &lt;- nls(formula = formula_sv,\n                    start = start_list,\n                    weights = 1/W2,\n                    lower = c(0, rep(1e-6, length(start_list)-1)),\n                    control = nls.control(maxiter = 500, warnOnly = TRUE))\n    \n    ini_h_n&lt;-coef(h_n_pond)\n    \n    optim_h_n &lt;- optim(\n      par = coef(h_n_pond),\n      fn = MSE_ponderados,\n      h = h,\n      gamma = gamma,\n      pesos = \"h/n\",\n      model = model,\n      n = n,\n      method = \"L-BFGS-B\",\n      lower = c(0, rep(1e-6, length(start_list)-1))\n    )    \n    \n    par_optim_h_n &lt;- optim_h_n$par[c(\"nugget\", \"sigma\", \"phi\")]\n    \n\nres &lt;- list(Bessel = list(Iniciales = ini_Bessel,\n                           Optimizados = par_optim_Bess),\n            `1/n` = list(Iniciales = ini_n,\n                          Optimizados = par_optim_n),\n            `h/n` = list(Iniciales = ini_h_n,\n                          Optimizados = par_optim_h_n))    \nreturn(res)\n}\n\nMSE_sv &lt;- function(gamma_hat, par, kappa, model, h){\n  sigma_0 &lt;- par[[2]]\n  phi_0 &lt;- par[[3]]\n  nugget_0 &lt;- par[[1]]\n  kappa_0 &lt;- kappa\n  \n  sv &lt;- switch(model,\n               \"exponencial\" = sv_exp,\n               \"gaussian\"    = sv_gauss,\n               \"spherical\"   = sv_spherical,\n               \"gneiting\"    = sv_gneiting,\n               \"matern\"      = sv_matern,\n               \"cos\" = cos_sv,\n               \"wave\" = sv_wave\n  )\n  \n  args_sv &lt;- names(formals(sv))\n  \n  args_list &lt;- list(\n    nugget = nugget_0,\n    sigma  = sigma_0,\n    h      = h,\n    phi    = phi_0,\n    kappa  = kappa_0\n  )\n  \n  args_list &lt;- args_list[names(args_list) %in% args_sv]\n  \n  sv_est &lt;- do.call(sv, args_list)\n  \n  return(mean((sv_est-gamma_hat)^2))\n}\n\n#3. Función para etimar por máxima verosimilitud\n\nloglik &lt;- function(par, kappa=NA, z, dist_matrix, model){\n  sigma_0 &lt;- par[1]\n  phi_0 &lt;- par[2]\n  nugget_0 &lt;- par[3]\n  kappa_0 &lt;- kappa\n  \n  cov &lt;- switch(model,\n               \"exponencial\" = cov_exp,\n               \"gaussian\"    = cov_gauss,\n               \"spherical\"   = cov_spherical,\n               \"gneiting\"    = cov_gneiting,\n               \"matern\"      = cov_matern\n  )\n  \n  args_cov &lt;- names(formals(cov))\n  \n  args_list &lt;- list(\n    sigma  = sigma_0,\n    nugget = nugget_0,\n    h      = dist_matrix,\n    phi    = phi_0,\n    kappa  = kappa_0\n  )\n  \n  args_list &lt;- args_list[names(args_list) %in% args_cov]\n  \n  Sigma &lt;- do.call(cov, args_list) \n  diag(Sigma) = diag(Sigma) + nugget_0\n  \n  # Descomposición de Cholesky (más estable que solve o det)\n  inv_Sigma &lt;- solve(Sigma)\n  det &lt;- log(det(Sigma))\n  \n  # Log-verosimilitud del modelo Gaussiano\n  z &lt;- z \n  n &lt;- length(z)\n  ll &lt;- -0.5 * (n * log(2 * pi) + det + crossprod(z, inv_Sigma %*% z))  # Log-verosimilitud (negativa porque optim minimiza)\n  return(-ll)\n}\n\n\nLos modelos obtenidos ajustanto por EyeFit, son:\n\ncov.model sigmasq      phi tausq kappa kappa2 practicalRange\n1 exponential   10.74 109166.3  2.07    NA     NA       327033.0\n2    gaussian   10.00  80000.0  2.07    NA     NA       138465.5\n3   spherical   10.00 157832.8  2.07    NA     NA       157832.8\n\n\nVer código\nvariog_T &lt;- data.frame(h = vg1_T$u, gamma_hat = vg1_T$v,\n                       n = vg1_T$n)\n\nrange_sv_T &lt;- seq(1,max(variog_T$h), by=1000)\n\n# Modelo exponencial ----\n\nsigma_0_eT &lt;- 10.74\nphi_0_eT &lt;- 109166.3\nnugget_0_eT &lt;- 2.07\n\npar_eT &lt;- c(sigma_0_eT, phi_0_eT, nugget_0_eT)\n\nres_e_T &lt;- est_sev_WLS(par=par_eT, kappa = NA,\n                       model=\"exponencial\",\n                       h=variog_T$h,\n                       gamma = variog_T$gamma_hat,\n                       n = variog_T$n)\n\nMLE_eT &lt;- optim(fn = loglik,\n             par = par_eT,\n             kappa=NA,\n             z = datosT$Residuos, \n             dist_matrix=dist_matrix_T,\n             model = \"exponencial\",\n             method = \"L-BFGS-B\",\n             lower = c(0, 0, 0))\n\nestsv_exp_Bess_T &lt;- do.call(sv_exp, c(as.list(res_e_T$Bessel$Optimizados), list(h = range_sv_T)))\nestsv_exp_n_T &lt;- do.call(sv_exp, c(as.list(res_e_T$`1/n`$Optimizados), list(h = range_sv_T)))\nestsv_exp_h_n_T &lt;- do.call(sv_exp, c(as.list(res_e_T$`h/n`$Optimizados), list(h = range_sv_T)))\nestsv_exp_MLE_T &lt;- do.call(sv_exp, c(list(nugget = MLE_eT$par[3], phi = MLE_eT$par[2] , sigma = MLE_eT$par[1],h = range_sv_T)))\n\n# Modelo Gaussiano ----\n\nsigma_0_gT &lt;- 10.00    \nphi_0_gT &lt;- 80000.0\nnugget_0_gT &lt;- 2.07\n\npar_gT &lt;- c(sigma_0_gT, phi_0_gT, nugget_0_gT)\n\nres_g_T &lt;- est_sev_WLS(par=par_gT, kappa = NA,\n                       model=\"gaussian\",\n                       h=variog_T$h,\n                       gamma = variog_T$gamma_hat,\n                       n = variog_T$n)\n\nestsv_g_Bess_T &lt;- do.call(sv_gauss, c(as.list(res_g_T$Bessel$Optimizados), list(h = range_sv_T)))\nestsv_g_n_T &lt;- do.call(sv_gauss, c(as.list(res_g_T$`1/n`$Optimizados), list(h = range_sv_T)))\nestsv_g_h_n_T &lt;- do.call(sv_gauss, c(as.list(res_g_T$`h/n`$Optimizados), list(h = range_sv_T)))\n\n# Modelo esférico\n\nsigma_0_esT &lt;- 10.00   \nphi_0_esT &lt;- 157832.8\nnugget_0_esT &lt;- 2.07\n\npar_esT &lt;- c(sigma_0_esT, phi_0_esT, nugget_0_esT)\n\nres_es_T &lt;- est_sev_WLS(par=par_esT, kappa = NA,\n                       model=\"spherical\",\n                       h=variog_T$h,\n                       gamma = variog_T$gamma_hat,\n                       n = variog_T$n)\n\nMLE_esT &lt;- optim(fn = loglik,\n             par = par_esT,\n             kappa=NA,\n             z = datosT$Residuos, \n             dist_matrix=dist_matrix_T,\n             model = \"spherical\",\n             method = \"L-BFGS-B\",\n             lower = c(0, 0, 0))\n\n\nestsv_es_Bess_T &lt;- do.call(sv_spherical, c(as.list(res_es_T$Bessel$Optimizados), list(h = range_sv_T)))\nestsv_es_n_T &lt;- do.call(sv_spherical, c(as.list(res_es_T$`1/n`$Optimizados), list(h = range_sv_T)))\nestsv_es_h_n_T &lt;- do.call(sv_spherical, c(as.list(res_es_T$`h/n`$Optimizados), list(h = range_sv_T)))\nestsv_es_MLE_T &lt;- do.call(sv_spherical, c(list(nugget = MLE_esT$par[3], phi = MLE_esT$par[2] , sigma = MLE_esT$par[1],h = range_sv_T)))\n\n\n\nExponencialGaussianoEsférico\n\n\n\nOptimGeoR\n\n\n\n\nVer código\nplot(vg1_T,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (optim)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(range_sv_T, estsv_exp_Bess_T, col=\"#FF4040\", lwd=1.5)\nlines(range_sv_T, estsv_exp_n_T, col=\"#4169E1\", lwd=1.5)\nlines(range_sv_T, estsv_exp_h_n_T, col=\"#008B00\", lwd=1.5)\nlines(range_sv_T, estsv_exp_MLE_T, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"Cressie\", \"1/n\", \"n/h\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\nVer código\nresumen_exp_T &lt;- cbind(\n  c(\"Cressie\", \"1/n\", \"n/h\", \"MLE\"),\n  rbind(\n    t(res_e_T$Bessel$Optimizados),\n    t(res_e_T$`1/n`$Optimizados),\n    t(res_e_T$`h/n`$Optimizados),\n    MLE_eT$par[c(3,1,2)]\n  ),\n  MSE = c(\n    MSE_sv(variog_T$gamma_hat, res_e_T$Bessel$Optimizados, NA, model = \"exponencial\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, res_e_T$`1/n`$Optimizados, NA, model = \"exponencial\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, res_e_T$`h/n`$Optimizados, NA, model = \"exponencial\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, list(nugget = MLE_eT$par[3], phi = MLE_eT$par[2] , sigma = MLE_eT$par[1]), NA, model = \"exponencial\", variog_T$h)\n  )\n)\n\nresumen_exp_T &lt;- as.data.frame(resumen_exp_T)\nresumen_exp_T[ , -1] &lt;- lapply(resumen_exp_T[ , -1], function(x) round(as.numeric(x), 3))\n\nkable(resumen_exp_T, digits = 3,\n      col.names = c(\"Método\", \"Nugget\", \"Sigma\", \"Phi\", \"MSE\"),\n      escape = F, row.names = F)\n\n\n\n\n\nMétodo\nNugget\nSigma\nPhi\nMSE\n\n\n\n\nCressie\n0\n12.944\n98216.22\n3.591000e+00\n\n\n1/n\n0\n11.178\n74809.83\n3.867000e+00\n\n\nn/h\n0\n12.797\n98765.50\n3.465000e+00\n\n\nMLE\n0\n31.706\n109166.30\n1.191489e+10\n\n\n\n\n\n\n\n\n\nVer código\nini1_exp_T &lt;- c(sigma_0_eT, phi_0_eT)\nfitvar1_exp_T &lt;- variofit(vg1_T,\n                    cov.model = \"exponential\",\n                    ini1_exp_T,\n                    fix.nugget = F,\n                    nugget = nugget_0_eT,\n                    wei = \"equal\")\n\nfitvar2_exp_T &lt;- variofit(vg1_T,\n                    cov.model = \"exponential\",\n                    ini1_exp_T,\n                    fix.nugget = F,\n                    nugget = nugget_0_eT,\n                    wei = \"npairs\")\n\nfitvar3_exp_T &lt;- variofit(vg1_T,\n                    cov.model = \"exponential\",\n                    ini1_exp_T,\n                    fix.nugget =F,\n                    nugget = nugget_0_eT,\n                    wei = \"cressie\")\n\nfitvar4_exp_T &lt;- likfit(temp,\n                  coords = temp$coords,\n                  data = temp$data,\n                  trend = ~ poly(Norte, 2, raw = FALSE),\n                  ini.cov.pars = ini1_exp_T,\n                  fix.nugget = F,\n                  nugget = nugget_0_eT,\n                  cov.model = \"exponential\",\n                  lik.method = \"ML\")\n\n\nplot(vg1_T,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar1_exp_T, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_exp_T, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_exp_T, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_exp_T, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\nVer código\npar1Texp &lt;- c(fitvar1_exp_T$nugget, fitvar1_exp_T$cov.pars[1], fitvar1_exp_T$cov.pars[2])\npar2Texp &lt;- c(fitvar2_exp_T$nugget, fitvar2_exp_T$cov.pars[1], fitvar2_exp_T$cov.pars[2])\npar3Texp &lt;- c(fitvar3_exp_T$nugget, fitvar3_exp_T$cov.pars[1], fitvar3_exp_T$cov.pars[2])\npar4Texp &lt;- c(fitvar4_exp_T$nugget, fitvar4_exp_T$cov.pars[1], fitvar4_exp_T$cov.pars[2])\n\nresumen_exp_T2 &lt;- cbind(\n  c(\"MCO\", \"1/n\", \"Cressie\",\"MLE\"),\n  rbind(\n    par1Texp,\n    par2Texp,\n    par3Texp,\n    par4Texp\n  ),\n  MSE = c(\n    MSE_sv(variog_T$gamma_hat, par1Texp, NA, model = \"exponencial\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, par2Texp, NA, model = \"exponencial\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, par3Texp, NA, model = \"exponencial\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, par4Texp, NA, model = \"exponencial\", variog_T$h)\n  )\n)\n\nresumen_exp_T2 &lt;- as.data.frame(resumen_exp_T2)\nresumen_exp_T2[ , -1] &lt;- lapply(resumen_exp_T2[ , -1], function(x) round(as.numeric(x), 3))\nkable(resumen_exp_T2, digits = 3,\n      col.names = c(\"Método\", \"Nugget\", \"Sigma\", \"Phi\", \"MSE\"),\n      escape = F, row.names = F)\n\n\n\n\n\nMétodo\nNugget\nSigma\nPhi\nMSE\n\n\n\n\nMCO\n0\n12.141\n82253.47\n3.184\n\n\n1/n\n0\n12.423\n83939.28\n3.243\n\n\nCressie\n0\n13.298\n109166.30\n4.009\n\n\nMLE\n0\n23.536\n75307.83\n117.551\n\n\n\n\n\n\n\n\n\n\n\nOptimGeoR\n\n\n\n\nVer código\nplot(vg1_T,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (optim)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(range_sv_T, estsv_g_Bess_T, col=\"#FF4040\", lwd=1.5)\nlines(range_sv_T, estsv_g_n_T, col=\"#4169E1\", lwd=1.5)\nlines(range_sv_T, estsv_g_h_n_T, col=\"#008B00\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"Cressie\", \"1/n\", \"n/h\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\nVer código\nresumen_g_T &lt;- cbind(\n  c(\"Cressie\", \"1/n\", \"n/h\"),\n  rbind(\n    t(res_g_T$Bessel$Optimizados),\n    t(res_g_T$`1/n`$Optimizados),\n    t(res_g_T$`h/n`$Optimizados)\n  ),\n  MSE = c(\n    MSE_sv(variog_T$gamma_hat, res_g_T$Bessel$Optimizados, NA, model = \"gaussian\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, res_g_T$`1/n`$Optimizados, NA, model = \"gaussian\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, res_g_T$`h/n`$Optimizados, NA, model = \"gaussian\", variog_T$h)\n  )\n)\n\nresumen_g_T &lt;- as.data.frame(resumen_g_T)\nresumen_g_T[ , -1] &lt;- lapply(resumen_g_T[ , -1], function(x) round(as.numeric(x), 3))\n\nkable(resumen_g_T, digits = 3,\n      col.names = c(\"Método\", \"Nugget\", \"Sigma\", \"Phi\", \"MSE\"),\n      escape = F)\n\n\n\n\n\nMétodo\nNugget\nSigma\nPhi\nMSE\n\n\n\n\nCressie\n0\n12.053\n74520.08\n2.809\n\n\n1/n\n0\n11.126\n69275.08\n3.233\n\n\nn/h\n0\n11.620\n72540.06\n2.825\n\n\n\n\n\n\n\n\n\nVer código\nini1_g_T &lt;- c(sigma_0_gT, phi_0_gT)\nfitvar1_g_T &lt;- variofit(vg1_T,\n                    cov.model = \"gaussian\",\n                    ini1_g_T,\n                    fix.nugget = F,\n                    nugget = nugget_0_gT,\n                    wei = \"equal\")\n\nfitvar2_g_T &lt;- variofit(vg1_T,\n                    cov.model = \"gaussian\",\n                    ini1_g_T,\n                    fix.nugget = F,\n                    nugget = nugget_0_gT,\n                    wei = \"npairs\")\n\nfitvar3_g_T &lt;- variofit(vg1_T,\n                    cov.model = \"gaussian\",\n                    ini1_g_T,\n                    fix.nugget = F,\n                    nugget = nugget_0_gT,\n                    wei = \"cressie\")\n\nfitvar4_g_T &lt;- likfit(temp,\n                  coords = temp$coords,\n                  data = temp$data,\n                  trend = ~ poly(Norte, 2, raw = FALSE),\n                  ini.cov.pars = ini1_g_T,\n                  fix.nugget = F,\n                  nugget = nugget_0_gT,\n                  cov.model = \"gaussian\",\n                  lik.method = \"ML\")\n\n\nplot(vg1_T,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar1_g_T, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_g_T, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_g_T, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_g_T, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\nVer código\npar1Tg &lt;- c(fitvar1_g_T$nugget, fitvar1_g_T$cov.pars[1], fitvar1_g_T$cov.pars[2])\npar2Tg &lt;- c(fitvar2_g_T$nugget, fitvar2_g_T$cov.pars[1], fitvar2_g_T$cov.pars[2])\npar3Tg &lt;- c(fitvar3_g_T$nugget, fitvar3_g_T$cov.pars[1], fitvar3_g_T$cov.pars[2])\npar4Tg &lt;- c(fitvar4_g_T$nugget, fitvar4_g_T$cov.pars[1], fitvar4_g_T$cov.pars[2])\n\nresumen_g_T2 &lt;- cbind(\n  c(\"MCO\", \"1/n\", \"Cressie\",\"MLE\"),\n  rbind(\n    par1Tg,\n    par2Tg,\n    par3Tg,\n    par4Tg\n  ),\n  MSE = c(\n    MSE_sv(variog_T$gamma_hat, par1Tg, NA, model = \"gaussian\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, par2Tg, NA, model = \"gaussian\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, par3Tg, NA, model = \"gaussian\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, par4Tg, NA, model = \"gaussian\", variog_T$h)\n  )\n)\n\nresumen_g_T2 &lt;- as.data.frame(resumen_g_T2)\nresumen_g_T2[ , -1] &lt;- lapply(resumen_g_T2[ , -1], function(x) round(as.numeric(x), 3))\n\nkable(resumen_g_T2, digits = 3,\n      col.names = c(\"Método\", \"Nugget\", \"Sigma\", \"Phi\", \"MSE\"),\n      escape = F, row.names = F)\n\n\n\n\n\nMétodo\nNugget\nSigma\nPhi\nMSE\n\n\n\n\nMCO\n0.000\n11.862\n74341.87\n2.776\n\n\n1/n\n0.000\n11.884\n74607.88\n2.777\n\n\nCressie\n0.349\n11.781\n80000.00\n2.835\n\n\nMLE\n3.589\n21.264\n80000.00\n155.000\n\n\n\n\n\n\n\n\n\n\n\nOptimGeoR\n\n\n\n\nVer código\nplot(vg1_T,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (optim)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(range_sv_T, estsv_es_Bess_T, col=\"#FF4040\", lwd=1.5)\nlines(range_sv_T, estsv_es_n_T, col=\"#4169E1\", lwd=1.5)\nlines(range_sv_T, estsv_es_h_n_T, col=\"#008B00\", lwd=1.5)\nlines(range_sv_T, estsv_es_MLE_T, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"Cressie\", \"1/n\", \"n/h\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\nVer código\nresumen_es_T &lt;- cbind(\n  c(\"Cressie\", \"1/n\", \"n/h\",\"MLE\"),\n  rbind(\n    t(res_es_T$Bessel$Optimizados),\n    t(res_es_T$`1/n`$Optimizados),\n    t(res_es_T$`h/n`$Optimizados),\n    MLE_esT$par[c(3,1,2)]\n  ),\n  MSE = c(\n    MSE_sv(variog_T$gamma_hat, res_es_T$Bessel$Optimizados, NA, model = \"spherical\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, res_es_T$`1/n`$Optimizados, NA, model = \"spherical\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, res_es_T$`h/n`$Optimizados, NA, model = \"spherical\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, list(nugget = MLE_esT$par[3], phi = MLE_esT$par[2] , sigma = MLE_esT$par[1]), NA, model = \"spherical\", variog_T$h)\n  )\n)\n\nresumen_es_T &lt;- as.data.frame(resumen_es_T)\nresumen_es_T[ , -1] &lt;- lapply(resumen_es_T[ , -1], function(x) round(as.numeric(x), 3))\n\nkable(resumen_es_T, digits = 3,\n      col.names = c(\"Método\", \"Nugget\", \"Sigma\", \"Phi\", \"MSE\"),\n      escape = F)\n\n\n\n\n\nMétodo\nNugget\nSigma\nPhi\nMSE\n\n\n\n\nCressie\n0\n12.165\n191573.0\n3.044000e+00\n\n\n1/n\n0\n11.128\n165974.5\n3.417000e+00\n\n\nn/h\n0\n11.692\n175441.2\n2.976000e+00\n\n\nMLE\n0\n27.958\n157832.8\n2.490774e+10\n\n\n\n\n\n\n\n\n\nVer código\nini1_es_T &lt;- c(sigma_0_esT, phi_0_esT)\nfitvar1_es_T &lt;- variofit(vg1_T,\n                    cov.model = \"spherical\",\n                    ini1_es_T,\n                    fix.nugget = F,\n                    nugget = nugget_0_esT,\n                    wei = \"equal\")\n\nfitvar2_es_T &lt;- variofit(vg1_T,\n                    cov.model = \"spherical\",\n                    ini1_es_T,\n                    fix.nugget = F,\n                    nugget = nugget_0_esT,\n                    wei = \"npairs\")\n\nfitvar3_es_T &lt;- variofit(vg1_T,\n                    cov.model = \"spherical\",\n                    ini1_es_T,\n                    fix.nugget = F,\n                    nugget = nugget_0_esT,\n                    wei = \"cressie\")\n\nfitvar4_es_T &lt;- likfit(temp,\n                  coords = temp$coords,\n                  data = temp$data,\n                  trend = ~ poly(Norte, 2, raw = FALSE),\n                  ini.cov.pars = ini1_es_T,\n                  fix.nugget = F,\n                  nugget = nugget_0_esT,\n                  cov.model = \"spherical\",\n                  lik.method = \"ML\")\n\n\nplot(vg1_T,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar1_es_T, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_es_T, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_es_T, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_es_T, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\nVer código\npar1Tes &lt;- c(fitvar1_es_T$nugget, fitvar1_es_T$cov.pars[1], fitvar1_es_T$cov.pars[2])\npar2Tes &lt;- c(fitvar2_es_T$nugget, fitvar2_es_T$cov.pars[1], fitvar2_es_T$cov.pars[2])\npar3Tes &lt;- c(fitvar3_es_T$nugget, fitvar3_es_T$cov.pars[1], fitvar3_es_T$cov.pars[2])\npar4Tes &lt;- c(fitvar4_es_T$nugget, fitvar4_es_T$cov.pars[1], fitvar4_es_T$cov.pars[2])\n\nresumen_es_T2 &lt;- cbind(\n  c(\"MCO\", \"1/n\", \"Cressie\",\"MLE\"),\n  rbind(\n    par1Tes,\n    par2Tes,\n    par3Tes,\n    par4Tes\n  ),\n  MSE = c(\n    MSE_sv(variog_T$gamma_hat, par1Tes, NA, model = \"spherical\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, par2Tes, NA, model = \"spherical\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, par3Tes, NA, model = \"spherical\", variog_T$h),\n    MSE_sv(variog_T$gamma_hat, par4Tes, NA, model = \"spherical\", variog_T$h)\n  )\n)\n\nresumen_es_T2 &lt;- as.data.frame(resumen_es_T2)\nresumen_es_T2[ , -1] &lt;- lapply(resumen_es_T2[ , -1], function(x) round(as.numeric(x), 3))\n\nkable(resumen_es_T2, digits = 3,\n      col.names = c(\"Método\", \"Nugget\", \"Sigma\", \"Phi\", \"MSE\"),\n      escape = F, row.names = F)\n\n\n\n\n\nMétodo\nNugget\nSigma\nPhi\nMSE\n\n\n\n\nMCO\n0\n11.878\n171733.0\n2.938\n\n\n1/n\n0\n11.898\n166427.4\n2.944\n\n\nCressie\n0\n11.860\n157832.8\n2.977\n\n\nMLE\n0\n25.641\n144147.3\n179.276\n\n\n\n\n\n\n\n\n\n\n\nEl modelo con menor MSE es el modelo Gausiano. Sin embargo, dada la inestabilidad numérica que se observa al realizar la predicción se opta por usar el modelo esférico obtenido por mínimos cuadrados ponderados usando la ponderación h/n, que es el segundo mejor en términos del MSE.\n\n\n1.3.2.4 Kriging\nUsando el modelo esférico:\n\n\nVer código\nplot(vg1_T,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Modelo esférico para Temperatura\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(range_sv_T, estsv_es_h_n_T, col=\"#008B00\", lwd=1.5)\n\n\n\n\n\n\n\n\n\n\n\nVer código\n#Se escoge el mejor modelo --------------------------------\n\nbest_model_T &lt;- gstat::vgm(psill = res_es_T$`h/n`$Optimizados[2],\n                           model = \"Sph\",\n                           range = res_es_T$`h/n`$Optimizados[3],\n                           nugget = res_es_T$`h/n`$Optimizados[1]\n)\n\n#Se crea un objeto en gstat -------------------------------\n\ncoordinates(datosT) &lt;- ~Este + Norte\nproj4string(datosT) &lt;- CRS(\"EPSG:3310\")\n\ng_obj&lt;-gstat::gstat(id=\"Temperatura\",\n             formula = Temperatura ~ Norte + I(Norte^2),\n             model = best_model_T,\n             data = datosT)\n\n#Kriging -------------------------------------------------\n\nsuppressMessages(predic &lt;- predict(g_obj, newdata = new, nmin = 20))\n\n#Mapas de predicción --------------------------------------\n\ngridded(predic) &lt;- TRUE\n\n#1. Mapa de Kriging ---------------------------------------\n\npredic_raster_utm &lt;- raster(predic, layer = \"Temperatura.pred\")\n\ncrs(predic_raster_utm) &lt;- \"+init=epsg:3310\"\n\npredic_raster_wgs84 &lt;- raster::projectRaster(\n    raster::mask(\n        predic_raster_utm, \n        sh_mundos_sp_utm_simple\n    ),\n    crs = \"+init=epsg:4326\", \n    method = \"bilinear\"\n)\n\nmin_pred &lt;- raster::cellStats(predic_raster_wgs84, stat='min')\nmax_pred &lt;- raster::cellStats(predic_raster_wgs84, stat='max')\n\npred_range &lt;- c(minValue(predic_raster_wgs84), maxValue(predic_raster_wgs84))\n\nstep_pred &lt;- (max_pred-min_pred)/ 6\n\nbins &lt;- round(seq(min_pred, max_pred, by=step_pred),0)\n\npal_pred &lt;- colorBin(\n  palette = \"viridis\", # La paleta de colores\n  domain = pred_range,\n  bins = bins,\n  na.color = \"transparent\"\n)\n\nmapa_kriging_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    predic_raster_wgs84,\n    colors = pal_pred, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n    addCircleMarkers(data = datosT_sf_wgs84,\n                   fillColor = ~pal(Temperatura),\n                   fillOpacity = 0.8,\n                   color = \"black\",\n                   weight = 1,\n                   radius = 3,\n                   popup = ~paste(\"Temp:\", Temperatura, \"°C\")) %&gt;% \n  addLegend(\n    pal = pal_pred, \n    values = pred_range,\n    title = \"Predicción T (°C)\",\n    position = \"topright\"\n  ) %&gt;%\n  addLegend(pal = pal,\n            values = datosT_sf_wgs84$Temperatura,\n            title = \"Temperatura Observada\",\n    position = \"topleft\"\n  ) \n\n#2 Mapa Varianza------------------------------------------\n\nvar_raster_utm &lt;- raster(predic, layer = \"Temperatura.var\")\n\ncrs(var_raster_utm) &lt;- \"+init=epsg:3310\"\n\nvar_raster_wgs84 &lt;- raster::projectRaster(\n    raster::mask(\n        var_raster_utm, \n        sh_mundos_sp_utm_simple\n    ),\n    crs = \"+init=epsg:4326\", \n    method = \"bilinear\"\n)\n\nmax_var &lt;- raster::cellStats(var_raster_wgs84, stat='max')\nstep_var &lt;- max_var / 6\n\nbinsv &lt;- round(seq(0, max_var, by=step_var),2)\n\nvar_range &lt;- c(minValue(var_raster_wgs84), maxValue(var_raster_wgs84))\npal_var &lt;- colorBin(\n  palette = \"Spectral\", # La paleta de colores\n  domain = var_range,\n  bins = binsv,\n  na.color = \"transparent\"\n)\n\nmapa_var_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    var_raster_wgs84, \n    colors = pal_var, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n  addLegend(\n    pal = pal_var, \n    values = var_range,\n    title = \"Varianza\",\n    position = \"topright\"\n  ) \n\n#3. Mapa Cv ----------------------------------------------\n\ncv_raster_utm &lt;- sqrt(var_raster_utm) / abs(predic_raster_utm)\n\nmapa_mayor_a_uno &lt;- cv_raster_utm &gt; 1\ncv_raster_utm[mapa_mayor_a_uno] &lt;- 1\n\ncrs(cv_raster_utm) &lt;- \"+init=epsg:3310\"\n\ncv_terra &lt;- terra::rast(cv_raster_utm)\n\nmasked_cv_terra &lt;- terra::mask(cv_terra, sh_terra)\n\ncv_raster_wgs84_terra &lt;- terra::project(\n    masked_cv_terra, \n    y = \"epsg:4326\", \n    method = \"bilinear\" # Similar a projectRaster\n)\n\ncv_raster_wgs84 &lt;- raster::raster(cv_raster_wgs84_terra)\n\nmax_cv &lt;- raster::cellStats(cv_raster_wgs84, stat='max')\nstep_cv &lt;- max_cv / 10\n\nbincv &lt;- seq(0,max_cv, by=step_cv)\n\ncv_range &lt;- c(minValue(cv_raster_wgs84), maxValue(cv_raster_wgs84))\n\npal_cv &lt;- colorBin(\n  palette = \"RdYlGn\", # Rojo-Amarillo-Verde\n  domain = cv_range,\n  na.color = \"transparent\",\n  bins = bincv,\n  reverse = TRUE \n)\n\nmapa_cv_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    cv_raster_wgs84, \n    colors = pal_cv, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n  \n  addLegend(\n    pal = pal_cv, \n    values = cv_range,\n    title = \"Coeficiente de Variación\",\n    position = \"topright\"\n  )\n\n\n\nPredicciónVarianzaCoeficiente de variación\n\n\n\n\nVer código\nmapa_kriging_leaflet\n\n\n\n\n\n\n\n\n\n\nVer código\nmapa_var_leaflet\n\n\n\n\n\n\n\n\n\n\nVer código\nmapa_cv_leaflet\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.3 Variable Velocidad del viento\n\n\nVer código\ny_WS &lt;- WS[1,] #Tomar una fecha\ny_WS &lt;- cbind(colnames(y_WS),t(y_WS[1,]))\ny_WS &lt;- y_WS[-1,]\ny_WS &lt;- as.data.frame(y_WS)\ny_WS &lt;- na.omit(y_WS)\ny_WS$V1 &lt;- as.numeric(y_WS$V1)\ny_WS &lt;- inner_join(y_WS, EstacionesWS, by=c(\"V1\"=\"AQSID\"))\ndatosWS &lt;- y_WS[,c(13,14,2)]\ncolnames(datosWS)=c(\"Este\",\"Norte\",\"WindSpeed\")\ndatosWS$WindSpeed &lt;- as.numeric(datosWS$WindSpeed)\n\ndatosWS_sf &lt;- st_as_sf(datosWS, coords = c(\"Este\", \"Norte\"), crs = 3310)\n\ndatosWS_sf_wgs84 &lt;- st_transform(datosWS_sf, crs = 4326)\n\npalWS &lt;- colorNumeric(palette = \"viridis\", domain = datosWS_sf_wgs84$WindSpeed)\n\nleaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addPolygons(data = sh_mundos_wgs84, fill = FALSE, color = \"black\", weight = 2) %&gt;%\n  addCircleMarkers(data = datosWS_sf_wgs84,\n                   fillColor = ~palWS(WindSpeed),\n                   fillOpacity = 0.8,\n                   color = \"black\",\n                   weight = 1,\n                   radius = 3,\n                   popup = ~paste(\"WindSpeed:\", WindSpeed, \"m/s\")) %&gt;%\n  addLegend(pal = palWS, values = datosWS_sf_wgs84$WindSpeed, title = \"WindSpeed (m/s)\")\n\n\n\n\n\n\nVer código\nws &lt;- as.geodata(datosWS)\npander::pander(summary(ws))\n\n\n\nn: 89\ncoords.summary:\n\n\n\n\n\n\n\n\n \nEste\nNorte\n\n\n\n\nmin\n-276541\n-543973\n\n\nmax\n415574\n281577\n\n\n\ndistances.summary:\n\n\n\n\n\n\n\nmin\nmax\n\n\n\n\n2216\n987994\n\n\n\ndata.summary:\n\n\n\n\n\n\n\n\n\n\n\nMin.\n1st Qu.\nMedian\nMean\n3rd Qu.\nMax.\n\n\n\n\n0.8\n2.5\n3.8\n4.375\n5.5\n14.1\n\n\n\n\n\n\n\n\nGráficos de dispersiónGeoR\n\n\n\n\nVer código\npWS1 &lt;- simple_scatter_plot(datosWS, \"Este\", \"WindSpeed\")\npWS2 &lt;- simple_scatter_plot(datosWS, \"Norte\", \"WindSpeed\")\n\ncowplot::plot_grid(pWS1,pWS2)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(ws, qt.col = c(\"purple\",\n                          \"pink\",\n                          \"green\",\n                          \"yellow\"),\n     scatter3d=T)\n\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.3.1 Modelo para la Media\nEl modelo que mejor atrapa el efecto de la media es:\nWindSpeed = \\beta_0 + \\beta_1 \\times Este + \\beta_2 \\times Norte + \\beta_3 \\times Este \\times Norte\n\n\nVer código\nfitWS &lt;- lm(WindSpeed~Este*Norte, data = datosWS) \npander::pander(summary(fitWS))\n\n\n\n\n\n\n\n\n\n\n\n\n \nEstimate\nStd. Error\nt value\nPr(&gt;|t|)\n\n\n\n\n(Intercept)\n6.398\n0.3639\n17.58\n4.751e-30\n\n\nEste\n2.069e-05\n2.674e-06\n7.739\n1.895e-11\n\n\nNorte\n1.159e-05\n1.808e-06\n6.411\n7.746e-09\n\n\nEste:Norte\n2.558e-11\n7.483e-12\n3.419\n0.000968\n\n\n\n\nFitting linear model: WindSpeed ~ Este * Norte\n\n\n\n\n\n\n\n\nObservations\nResidual Std. Error\nR^2\nAdjusted R^2\n\n\n\n\n89\n1.938\n0.4851\n0.4669\n\n\n\n\n\nGráficamente se observa una mitigación en la tendencia espacial:\n\nGráficos de dispersiónGeoR\n\n\n\n\nVer código\ndatosWS$Residuos &lt;- fitWS$residuals\n\npWS1 &lt;- simple_scatter_plot(datosWS, \"Este\", \"Residuos\")\npWS2 &lt;- simple_scatter_plot(datosWS, \"Norte\", \"Residuos\")\n\ncowplot::plot_grid(pWS1,pWS2)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(temp, qt.col = c(\"purple\",\n                      \"pink\",\n                      \"green\",\n                      \"yellow\"),\n     scatter3d=T, trend=~Norte*Este)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.3.2 Estimación Empírica del Semivariograma\n\n\nVer código\nvgO_WS &lt;- variog(ws,estimator.type = \"modulus\", pairs.min=50) \n\nvg1_WS &lt;- variog(ws, trend = ~Norte*Este,\n                estimator.type = \"modulus\", pairs.min=50)\n\n\n\nCon tendenciaRemoviendo Tendencia\n\n\n\n\nVer código\nplot(vgO_WS,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Sin remover tendencia\",\n     col.main = 4, cex.main =1.3)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(vg1_WS,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Removiendo tendencia\",\n     col.main = 4, cex.main =1.3)\n\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.3.2.1 Asintropía\n\n\nVer código\npar(mfrow = c(2, 2),\n    mar = c(3, 3, 1, 1),\n    mgp = c(2, 1, 0))\n\nvg1_WS_0 &lt;- variog(ws, trend = ~Norte*Este,\n                estimator.type = \"modulus\", pairs.min=50,\n                direction = 0)\nvg1_WS_45 &lt;- variog(ws, trend = ~Norte*Este,\n                estimator.type = \"modulus\", pairs.min = 20,\n                direction = pi / 4)\nvg1_WS_90 &lt;- variog(ws, trend = ~Norte*Este,\n                estimator.type = \"modulus\", pairs.min=50,\n                direction = pi / 2)\nvg1_WS_135 &lt;- variog(ws, trend = ~Norte*Este,\n                estimator.type = \"modulus\", pairs.min=50,\n                direction = 3 * pi / 4)\n\nplot(vg1_WS_0,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     main = \"0°\",\n     col.main = 4)\nplot(vg1_WS_45,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     main = \"45°\",\n     col.main = 4)\nplot(vg1_WS_90,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     main = \"90°\",\n     col.main = 4)\nplot(vg1_WS_135,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     main = \"135°\",\n     col.main = 4)\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.3.3 Estimación del Modelo Teórico de Semivariograma\n\n\nVer código\nvariog_WS &lt;- data.frame(h = vg1_WS$u, gamma_hat = vg1_WS$v,\n                       n = vg1_WS$n)\n\nrange_sv_WS &lt;- seq(1,max(variog_WS$h), by=1000)\n\n#Modelo Coseno---------------------------------------------\n\nsigma_0_cosWS &lt;- 1.5\nphi_0_cosWS &lt;- .6e5\nnugget_0_cosWS &lt;- 1.5\n\n#MCO -------\nI_pond_WS &lt;- nls(formula = gamma_hat ~cos_sv(nugget, sigma, h, phi),\n              start = c(nugget = nugget_0_cosWS, sigma = sigma_0_cosWS, phi = phi_0_cosWS),\n              lower = rep(1e-6,3),\n              data = variog_WS,\n              control = nls.control(maxiter = 500, warnOnly = TRUE))\n\noptim_I_WS &lt;- optim(\n  par = coef(I_pond_WS),\n  fn = MSE_ponderados,\n  h = variog_WS$h,\n  gamma = variog_WS$gamma_hat,\n  pesos = \"I\",\n  model = \"cos\",\n  n = n,\n  method = \"L-BFGS-B\",\n  lower = rep(1e-6,3)\n)\n\npar_optim_I_WS &lt;- optim_I_WS$par[c(\"nugget\", \"sigma\", \"phi\")]\n\nestsv_cos_I_WS &lt;- do.call(cos_sv, c(as.list(par_optim_I_WS), list(h = range_sv_WS)))\n\n\n#WLS -------\n\npar_cosWS &lt;- c(sigma_0_cosWS, phi_0_cosWS, nugget_0_cosWS)\n\nres_cos_WS &lt;- est_sev_WLS(par=par_cosWS, kappa = NA,\n                       model=\"cos\",\n                       h=variog_WS$h,\n                       gamma = variog_WS$gamma_hat,\n                       n = variog_WS$n)\n\nestsv_cos_Bess_WS &lt;- do.call(cos_sv, c(as.list(res_cos_WS$Bessel$Optimizados), list(h = range_sv_WS)))\nestsv_cos_n_WS &lt;- do.call(cos_sv, c(as.list(res_cos_WS$`1/n`$Optimizados), list(h = range_sv_WS)))\nestsv_cos_h_n_WS &lt;- do.call(cos_sv, c(as.list(res_cos_WS$`h/n`$Optimizados), list(h = range_sv_WS)))\n\n#Modelo Wave ---------------------------------------------\n\nnugget_0_wvWS &lt;- 1.5\n\npar_wvWS &lt;- c(3.5,.6e5)\n\nfitvar1_cos_WS &lt;- variofit(vg1_WS,\n                    cov.model = \"wave\",\n                    par_wvWS,\n                    fix.nugget = F,\n                    nugget = nugget_0_wvWS,\n                    wei = \"equal\")\nfitvar2_cos_WS &lt;- variofit(vg1_WS,\n                    cov.model = \"wave\",\n                    par_wvWS,\n                    fix.nugget = F,\n                    nugget = nugget_0_wvWS,\n                    wei = \"npairs\")\n\nfitvar3_cos_WS &lt;- variofit(vg1_WS,\n                    cov.model = \"wave\",\n                    par_wvWS,\n                    fix.nugget = F,\n                    nugget = nugget_0_wvWS,\n                    wei = \"cressie\")\n\nfitvar4_cos_WS &lt;- likfit(ws,\n                       coords = ws$coords,\n                       data = ws$data,\n                       trend = ~ Este*Norte,\n                       ini.cov.pars = par_wvWS,\n                       fix.nugget = F,\n                       nugget = nugget_0_wvWS,\n                       cov.model = \"wave\",\n                       lik.method = \"ML\")\n\n\n\nCoseno (Optim)Wave (GeoR)\n\n\n\n\nVer código\nplot(vg1_WS,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (optim)\",\n     col.main = 4, cex.main =1.3)\nlines(range_sv_WS, estsv_cos_Bess_WS, col=\"#FF4040\", lwd=1.5)\nlines(range_sv_WS, estsv_cos_n_WS, col=\"#4169E1\", lwd=1.5)\nlines(range_sv_WS, estsv_cos_h_n_WS, col=\"#008B00\", lwd=1.5)\nlines(range_sv_WS, estsv_cos_I_WS, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"Cressie\", \"1/n\", \"n/h\", \"MCO\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\nVer código\nresumen_cos_SV &lt;- cbind(\n  c(\"Cressie\", \"1/n\", \"n/h\", \"MCO\"),\n  rbind(\n    t(res_cos_WS$Bessel$Optimizados),\n    t(res_cos_WS$`1/n`$Optimizados),\n    t(res_cos_WS$`h/n`$Optimizados),\n    par_optim_I_WS\n  ),\n  MSE = c(\n    MSE_sv(variog_WS$gamma_hat, res_cos_WS$Bessel$Optimizados, NA, model = \"cos\", variog_WS$h),\n    MSE_sv(variog_WS$gamma_hat, res_cos_WS$`1/n`$Optimizados, NA, model = \"cos\", variog_WS$h),\n    MSE_sv(variog_WS$gamma_hat, res_cos_WS$`h/n`$Optimizados, NA, model = \"cos\", variog_WS$h),\n    MSE_sv(variog_WS$gamma_hat, par_optim_I_WS, NA, model = \"cos\", variog_WS$h)\n  )\n)\n\nresumen_cos_SV &lt;- as.data.frame(resumen_cos_SV)\nresumen_cos_SV[ , -1] &lt;- lapply(resumen_cos_SV[ , -1], function(x) round(as.numeric(x), 3))\n\nkable(resumen_cos_SV, digits = 3,\n      col.names = c(\"Método\", \"Nugget\", \"Sigma\", \"Phi\", \"MSE\"),\n      escape = F, row.names = F)\n\n\n\n\n\nMétodo\nNugget\nSigma\nPhi\nMSE\n\n\n\n\nCressie\n2.445\n0.902\n63679.76\n1.022\n\n\n1/n\n1.342\n1.465\n56886.07\n0.679\n\n\nn/h\n1.519\n1.405\n69426.04\n1.704\n\n\nMCO\n1.865\n1.153\n57996.66\n0.546\n\n\n\n\n\n\n\n\n\nVer código\nplot(vg1_WS,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = 4, cex.main =1.3)\n\nlines(fitvar1_cos_WS, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_cos_WS, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_cos_WS, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_cos_WS, col=\"#FFA500\", lwd=1.5)\n\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\nVer código\npar1WScos &lt;- c(fitvar1_cos_WS$nugget, fitvar1_cos_WS$cov.pars[1], fitvar1_cos_WS$cov.pars[2])\npar2WScos &lt;- c(fitvar2_cos_WS$nugget, fitvar2_cos_WS$cov.pars[1], fitvar2_cos_WS$cov.pars[2])\npar3WScos &lt;- c(fitvar3_cos_WS$nugget, fitvar3_cos_WS$cov.pars[1], fitvar3_cos_WS$cov.pars[2])\npar4WScos &lt;- c(fitvar4_cos_WS$nugget, fitvar4_cos_WS$cov.pars[1], fitvar4_cos_WS$cov.pars[2])\n\nresumen_wv_WS &lt;- cbind(\n  c(\"MCO\", \"1/n\", \"Cressie\",\"MLE\"),\n  rbind(\n    par1WScos,\n    par2WScos,\n    par3WScos,\n    par4WScos\n  ),\n  MSE = c(\n    MSE_sv(variog_WS$gamma_hat, par1WScos, NA, model = \"wave\", variog_WS$h),\n    MSE_sv(variog_WS$gamma_hat, par2WScos, NA, model = \"wave\", variog_WS$h),\n    MSE_sv(variog_WS$gamma_hat, par3WScos, NA, model = \"wave\", variog_WS$h),\n    MSE_sv(variog_WS$gamma_hat, par4WScos, NA, model = \"wave\", variog_WS$h)\n  )\n)\n\nresumen_wv_WS &lt;- as.data.frame(resumen_wv_WS)\nresumen_wv_WS[ , -1] &lt;- lapply(resumen_wv_WS[ , -1], function(x) round(as.numeric(x), 3))\n\nkable(resumen_wv_WS, digits = 3,\n      col.names = c(\"Método\", \"Nugget\", \"Sigma\", \"Phi\", \"MSE\"),\n      escape = F, row.names = F)\n\n\n\n\n\nMétodo\nNugget\nSigma\nPhi\nMSE\n\n\n\n\nMCO\n1.692\n1.447\n60000.00\n1.014\n\n\n1/n\n1.069\n2.467\n50139.56\n0.864\n\n\nCressie\n1.300\n2.284\n50724.55\n0.908\n\n\nMLE\n2.819\n0.890\n60000.00\n1.450\n\n\n\n\n\n\n\n\n\n\n1.3.3.4 Kriging\nUsando el modelo wave:\n\n\nVer código\nplot(vg1_WS,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Modelo wave para WindSpeed\",\n     col.main = 4, cex.main =1.3)\nlines(fitvar2_cos_WS, col=\"#4169E1\", lwd=1.5)\n\n\n\n\n\n\n\n\n\n\n\nVer código\n#Se escoge el mejor modelo --------------------------------\n\nbest_model_WS &lt;- gstat::vgm(psill = par2WScos[2],\n                           model = \"Wav\",\n                           range = par2WScos[3],\n                           nugget = par2WScos[1]\n)\n\n#Se crea un objeto en gstat -------------------------------\n\ncoordinates(datosWS) &lt;- ~Este + Norte\nproj4string(datosWS) &lt;- CRS(\"EPSG:3310\")\n\ng_obj&lt;-gstat::gstat(id=\"WindSpeed\",\n             formula = WindSpeed ~ Norte*Este,\n             model = best_model_WS,\n             data = datosWS)\n\n#Kriging -------------------------------------------------\n\nsuppressMessages(predic &lt;- predict(g_obj, newdata = new, nmin = 20))\n\n#Mapas de predicción --------------------------------------\n\ngridded(predic) &lt;- TRUE\n\n#1. Mapa de Kriging ---------------------------------------\n\npredic_raster_utm &lt;- raster(predic, layer = \"WindSpeed.pred\")\n\ncrs(predic_raster_utm) &lt;- \"+init=epsg:3310\"\n\npredic_raster_wgs84 &lt;- raster::projectRaster(\n    raster::mask(\n        predic_raster_utm, \n        sh_mundos_sp_utm_simple\n    ),\n    crs = \"+init=epsg:4326\", \n    method = \"bilinear\"\n)\n\nmin_pred &lt;- raster::cellStats(predic_raster_wgs84, stat='min')\nmax_pred &lt;- raster::cellStats(predic_raster_wgs84, stat='max')\n\npred_range &lt;- c(minValue(predic_raster_wgs84), maxValue(predic_raster_wgs84))\n\nstep_pred &lt;- (max_pred-min_pred)/ 6\n\nbins &lt;- round(seq(min_pred, max_pred, by=step_pred),0)\n\npal_pred &lt;- colorBin(\n  palette = \"viridis\", # La paleta de colores\n  domain = pred_range,\n  bins = bins,\n  na.color = \"transparent\"\n)\n\nmapa_kriging_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    predic_raster_wgs84,\n    colors = pal_pred, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n    addCircleMarkers(data = datosWS_sf_wgs84,\n                   fillColor = ~palWS(WindSpeed),\n                   fillOpacity = 0.8,\n                   color = \"black\",\n                   weight = 1,\n                   radius = 3,\n                   popup = ~paste(\"WS:\", WindSpeed, \"m/s\")) %&gt;% \n  addLegend(\n    pal = pal_pred, \n    values = pred_range,\n    title = \"Predicción WS (m/s)\",\n    position = \"topright\"\n  ) %&gt;%\n  addLegend(pal = palWS,\n            values = datosWS_sf_wgs84$WindSpeed,\n            title = \"WS Observada\",\n    position = \"topleft\"\n  ) \n\n#2 Mapa Varianza------------------------------------------\n\nvar_raster_utm &lt;- raster(predic, layer = \"WindSpeed.var\")\n\ncrs(var_raster_utm) &lt;- \"+init=epsg:3310\"\n\nvar_raster_wgs84 &lt;- raster::projectRaster(\n    raster::mask(\n        var_raster_utm, \n        sh_mundos_sp_utm_simple\n    ),\n    crs = \"+init=epsg:4326\", \n    method = \"bilinear\"\n)\n\nmax_var &lt;- raster::cellStats(var_raster_wgs84, stat='max')\nstep_var &lt;- max_var / 6\n\nbinsv &lt;- round(seq(0, max_var, by=step_var),2)\n\nvar_range &lt;- c(minValue(var_raster_wgs84), maxValue(var_raster_wgs84))\npal_var &lt;- colorBin(\n  palette = \"Spectral\", # La paleta de colores\n  domain = var_range,\n  bins = binsv,\n  na.color = \"transparent\"\n)\n\nmapa_var_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    var_raster_wgs84, \n    colors = pal_var, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n  addLegend(\n    pal = pal_var, \n    values = var_range,\n    title = \"Varianza\",\n    position = \"topright\"\n  ) \n\n#3. Mapa Cv ----------------------------------------------\n\npredic$cv &lt;- sqrt(predic$WindSpeed.var) / pmax(abs(predic$WindSpeed.pred), 1e-6)\n\npredic$cv[predic$cv &gt; 1] &lt;- 1\n\ncv_raster_utm &lt;- raster(predic, layer = \"cv\")\n\ncrs(cv_raster_utm) &lt;- \"+init=epsg:3310\"\n\ncv_terra &lt;- terra::rast(cv_raster_utm)\n\nmasked_cv_terra &lt;- terra::mask(cv_terra, sh_terra)\n\ncv_raster_wgs84_terra &lt;- terra::project(\n    masked_cv_terra, \n    y = \"epsg:4326\", \n    method = \"bilinear\" # Similar a projectRaster\n)\n\ncv_raster_wgs84 &lt;- raster::raster(cv_raster_wgs84_terra)\n\nmax_cv &lt;- raster::cellStats(cv_raster_wgs84, stat='max')\nstep_cv &lt;- max_cv / 10\n\nbincv &lt;- seq(0,max_cv, by=step_cv)\n\ncv_range &lt;- c(minValue(cv_raster_wgs84), maxValue(cv_raster_wgs84))\n\n\npal_cv &lt;- colorBin(\n  palette = \"RdYlGn\", # Rojo-Amarillo-Verde\n  domain = cv_range,\n  na.color = \"transparent\",\n  bins = bincv,\n  reverse = TRUE \n)\n\nmapa_cv_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    cv_raster_wgs84, \n    colors = pal_cv, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n  \n  addLegend(\n    pal = pal_cv, \n    values = cv_range,\n    title = \"Coeficiente de Variación\",\n    position = \"topright\"\n  )\n\n\n\nPredicciónVarianzaCoeficiente de variación\n\n\n\n\nVer código\nmapa_kriging_leaflet\n\n\n\n\n\n\n\n\n\n\nVer código\nmapa_var_leaflet\n\n\n\n\n\n\n\n\n\n\nVer código\nmapa_cv_leaflet\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.4 Variable presión atmosférica\n\n\nVer código\ny_Pr &lt;- Presion[1,] #Tomar una fecha\ny_Pr &lt;- cbind(colnames(y_Pr),t(y_Pr[1,]))\ny_Pr &lt;- y_Pr[-1,]\ny_Pr &lt;- as.data.frame(y_Pr)\ny_Pr &lt;- na.omit(y_Pr)\ny_Pr$V1 &lt;- as.numeric(y_Pr$V1)\ny_Pr &lt;- y_Pr[-which.min(y_Pr$V2),]\ny_Pr &lt;- y_Pr[-which.min(y_Pr$V2),]\ny_Pr &lt;- inner_join(y_Pr, EstacionesPr, by=c(\"V1\"=\"AQSID\"))\ndatosPr &lt;- y_Pr[,c(13,14,2)]\ncolnames(datosPr)=c(\"Este\",\"Norte\",\"Presion\")\ndatosPr$Presion &lt;- as.numeric(datosPr$Presion)\n\ndatosPr_sf &lt;- st_as_sf(datosPr, coords = c(\"Este\", \"Norte\"), crs = 3310)\n\ndatosPr_sf_wgs84 &lt;- st_transform(datosPr_sf, crs = 4326)\n\npalPr &lt;- colorNumeric(palette = \"viridis\", domain = datosPr_sf_wgs84$Presion)\n\nleaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addPolygons(data = sh_mundos_wgs84, fill = FALSE, color = \"black\", weight = 2) %&gt;%\n  addCircleMarkers(data = datosPr_sf_wgs84,\n                   fillColor = ~palPr(Presion),\n                   fillOpacity = 0.8,\n                   color = \"black\",\n                   weight = 1,\n                   radius = 3,\n                   popup = ~paste(\"Presion:\", Presion, \"mb\")) %&gt;%\n  addLegend(pal = palPr, values = datosPr_sf_wgs84$Presion, title = \"Presión Barométrica mb\")\n\n\n\n\n\n\nVer código\npresion &lt;- as.geodata(datosPr)\npander::pander(summary(presion))\n\n\n\nn: 42\ncoords.summary:\n\n\n\n\n\n\n\n\n \nEste\nNorte\n\n\n\n\nmin\n-325701\n-467412\n\n\nmax\n320088\n164450\n\n\n\ndistances.summary:\n\n\n\n\n\n\n\nmin\nmax\n\n\n\n\n3267\n896013\n\n\n\ndata.summary:\n\n\n\n\n\n\n\n\n\n\n\nMin.\n1st Qu.\nMedian\nMean\n3rd Qu.\nMax.\n\n\n\n\n863.6\n957.6\n1003\n975.1\n1008\n1019\n\n\n\n\n\n\n\n\nGráficos de dispersiónGeoR\n\n\n\n\nVer código\npPr1 &lt;- simple_scatter_plot(datosPr, \"Este\", \"Presion\")\npPr2 &lt;- simple_scatter_plot(datosPr, \"Norte\", \"Presion\")\n\ncowplot::plot_grid(pPr1,pPr2)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(presion, qt.col = c(\"purple\",\n                          \"pink\",\n                          \"green\",\n                          \"yellow\"),\n     scatter3d=T)\n\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.4.1 Modelo para la Media\nEl modelo que mejor atrapa el efecto de la media es:\nPresion = \\beta_0 + \\beta_1 \\times Este + \\beta_2 \\times Norte \n\n\nVer código\nfitPr &lt;- lm(Presion~Este+Norte, data=datosPr)\npander::pander(summary(fitPr))\n\n\n\n\n\n\n\n\n\n\n\n\n \nEstimate\nStd. Error\nt value\nPr(&gt;|t|)\n\n\n\n\n(Intercept)\n941.3\n9.702\n97.03\n4.043e-48\n\n\nEste\n-0.0004972\n5.927e-05\n-8.39\n2.88e-10\n\n\nNorte\n-0.000331\n4.65e-05\n-7.117\n1.48e-08\n\n\n\n\nFitting linear model: Presion ~ Este + Norte\n\n\n\n\n\n\n\n\nObservations\nResidual Std. Error\nR^2\nAdjusted R^2\n\n\n\n\n42\n30.61\n0.6454\n0.6272\n\n\n\n\n\nGráficamente se observa una mitigación en la tendencia espacial:\n\nGráficos de dispersiónGeoR\n\n\n\n\nVer código\ndatosPr$Residuos &lt;- fitPr$residuals\n\npPr1 &lt;- simple_scatter_plot(datosPr, \"Este\", \"Residuos\")\npPr2 &lt;- simple_scatter_plot(datosPr, \"Norte\", \"Residuos\")\n\ncowplot::plot_grid(pPr1,pPr2)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(presion, qt.col = c(\"purple\",\n                      \"pink\",\n                      \"green\",\n                      \"yellow\"),\n     scatter3d=T, trend=~Norte+Este)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.4.2 Estimación Empírica del Semivariograma\n\n\nVer código\nvgO_Pr &lt;- variog(presion,estimator.type = \"modulus\", pairs.min=50) \n\nvg1_Pr &lt;- variog(presion, trend = ~Norte+Este,\n                estimator.type = \"modulus\", pairs.min=50)\n\n\n\nCon tendenciaRemoviendo Tendencia\n\n\n\n\nVer código\nplot(vgO_Pr,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Sin remover tendencia\",\n     col.main = 4, cex.main =1.3)\n\n\n\n\n\n\n\n\n\n\n\n\n\nVer código\nplot(vg1_Pr,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Removiendo tendencia\",\n     col.main = 4, cex.main =1.3)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n1.3.4.3 Estimación del Modelo Teórico de Semivariograma\nLos modelos obtenidos ajustanto por EyeFit, son:\n\ncov.model sigmasq      phi tausq kappa kappa2 practicalRange\n1 exponential 1056.47 126360.8 132.06    NA     NA       378543.2\n\n1.3.4.3.1 Exponencial\n\n\nVer código\nvariog_Pr &lt;- data.frame(h = vg1_Pr$u, gamma_hat = vg1_Pr$v,\n                       n = vg1_Pr$n)\n\nnugget_0_ePr &lt;- 132.06\n\npar_ePr &lt;- c(1056.47,126360.8)\n\nfitvar1_exp_Pr &lt;- variofit(vg1_Pr,\n                    cov.model = \"exponential\",\n                    par_ePr,\n                    fix.nugget = F,\n                    nugget = nugget_0_ePr,\n                    wei = \"equal\")\n\nfitvar2_exp_Pr &lt;- variofit(vg1_Pr,\n                    cov.model = \"exponential\",\n                    par_ePr,\n                    fix.nugget = F,\n                    nugget = nugget_0_ePr,\n                    wei = \"npairs\")\n\nfitvar3_exp_Pr &lt;- variofit(vg1_Pr,\n                    cov.model = \"exponential\",\n                    par_ePr,\n                    fix.nugget = F,\n                    nugget = nugget_0_ePr,\n                    wei = \"cressie\")\n\nfitvar4_exp_Pr &lt;- likfit(presion,\n                       coords = presion$coords,\n                       data = presion$data,\n                       trend = ~ Este+Norte,\n                       ini.cov.pars = par_ePr,\n                       fix.nugget = F,\n                       nugget = nugget_0_ePr,\n                       cov.model = \"exponential\",\n                       lik.method = \"ML\")\n\nplot(vg1_Pr,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Estimación teórica del modelo de semivariograma \\n (GeoR, gstat)\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar1_exp_Pr, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2_exp_Pr, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3_exp_Pr, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_exp_Pr, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n\n\n\n\n\n\n\n\n\n\n\nVer código\npar1Prexp &lt;- c(fitvar1_exp_Pr$nugget, fitvar1_exp_Pr$cov.pars[1], fitvar1_exp_Pr$cov.pars[2])\npar2Prexp &lt;- c(fitvar2_exp_Pr$nugget, fitvar2_exp_Pr$cov.pars[1], fitvar2_exp_Pr$cov.pars[2])\npar3Prexp &lt;- c(fitvar3_exp_Pr$nugget, fitvar3_exp_Pr$cov.pars[1], fitvar3_exp_Pr$cov.pars[2])\npar4Prexp &lt;- c(fitvar4_exp_Pr$nugget, fitvar4_exp_Pr$cov.pars[1], fitvar4_exp_Pr$cov.pars[2])\n\nresumen_exp_Pr &lt;- cbind(\n  c(\"MCO\", \"1/n\", \"Cressie\",\"MLE\"),\n  rbind(\n    par1Prexp,\n    par2Prexp,\n    par3Prexp,\n    par4Prexp\n  ),\n  MSE = c(\n    MSE_sv(variog_Pr$gamma_hat, par1Prexp, NA, model = \"exponencial\", variog_Pr$h),\n    MSE_sv(variog_Pr$gamma_hat, par2Prexp, NA, model = \"exponencial\", variog_Pr$h),\n    MSE_sv(variog_Pr$gamma_hat, par3Prexp, NA, model = \"exponencial\", variog_Pr$h),\n    MSE_sv(variog_Pr$gamma_hat, par4Prexp, NA, model = \"exponencial\", variog_Pr$h)\n  )\n)\n\nresumen_exp_Pr &lt;- as.data.frame(resumen_exp_Pr)\nresumen_exp_Pr[ , -1] &lt;- lapply(resumen_exp_Pr[ , -1], function(x) round(as.numeric(x), 3))\nkable(resumen_exp_Pr, digits = 3,\n      col.names = c(\"Método\", \"Nugget\", \"Sigma\", \"Phi\", \"MSE\"),\n      escape = F, row.names = F)\n\n\n\n\n\nMétodo\nNugget\nSigma\nPhi\nMSE\n\n\n\n\nMCO\n0\n998.786\n48215.75\n42965.03\n\n\n1/n\n0\n1008.061\n47795.01\n43055.30\n\n\nCressie\n0\n1099.124\n65376.00\n50323.55\n\n\nMLE\n0\n866.939\n49360.65\n57875.45\n\n\n\n\n\n\n\n\n1.3.4.4 Kriging\nUsando el modelo exponencial:\n\n\nVer código\nplot(vg1_Pr,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Modelo exponencial para Presión\",\n     col.main = \"#36648B\", cex.main =1.3)\nlines(fitvar1_exp_Pr, col=\"#FF4040\", lwd=1.5)\n\n\n\n\n\n\n\n\n\n\n\nVer código\n#Se ajusta el mejor modelo -------------------------------\n\nbest_model_Pr &lt;- gstat::vgm(psill = fitvar1_exp_Pr$cov.pars[1],\n                           model = \"Exp\",\n                           range = fitvar1_exp_Pr$cov.pars[2],\n                           nugget = fitvar1_exp_Pr$nugget\n                           \n)\n\n# Se crea un objeto en gstat ------------------------------\n\ncoordinates(datosPr) &lt;- ~Este + Norte\nproj4string(datosPr) &lt;- CRS(\"EPSG:3310\")\n\ng_obj&lt;-gstat::gstat(id=\"Presion\",\n             formula = Presion ~ Norte + Este,\n             model = best_model_Pr,\n             data = datosPr)\n\n#Kriging ------------------------------------------------\n\ninvisible(predic &lt;- predict(g_obj, newdata = new))\n\n\n#Mapas de predicción -------------------------------------\n\ngridded(predic) &lt;- TRUE\n\n#1. Mapa de Kriging --------------------------------------\n\npredic_raster_utm &lt;- raster(predic, layer = \"Presion.pred\")\n\ncrs(predic_raster_utm) &lt;- \"+init=epsg:3310\"\n\npredic_raster_wgs84 &lt;- raster::projectRaster(\n    raster::mask(\n        predic_raster_utm, \n        sh_mundos_sp_utm_simple\n    ),\n    crs = \"+init=epsg:4326\", \n    method = \"bilinear\"\n)\n\nmin_pred &lt;- raster::cellStats(predic_raster_wgs84, stat='min')\nmax_pred &lt;- raster::cellStats(predic_raster_wgs84, stat='max')\n\npred_range &lt;- c(minValue(predic_raster_wgs84), maxValue(predic_raster_wgs84))\n\nstep_pred &lt;- (max_pred-min_pred)/ 6\n\nbins &lt;- round(seq(min_pred, max_pred, by=step_pred),0)\n\npal_pred &lt;- colorBin(\n  palette = \"viridis\", # La paleta de colores\n  domain = pred_range,\n  bins = bins,\n  na.color = \"transparent\"\n)\n\nmapa_kriging_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    predic_raster_wgs84, \n    colors = pal_pred, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n    addCircleMarkers(data = datosPr_sf_wgs84,\n                   fillColor = ~palPr(Presion),\n                   fillOpacity = 0.8,\n                   color = \"black\",\n                   weight = 1,\n                   radius = 3,\n                   popup = ~paste(\"Presión:\", Presion, \"mb\")) %&gt;% \n  \n  addLegend(\n    pal = pal_pred, \n    values = pred_range,\n    title = \"Predicción Presión mb\",\n    position = \"topright\"\n  ) %&gt;%\n  \n  addLegend(pal = palPr,\n            values = datosPr_sf_wgs84$Presion,\n            title = \"Presión Observada\",\n    position = \"topleft\"\n  ) \n\n#2 Mapa Varianza------------------------------------------\n\nvar_raster_utm &lt;- raster(predic, layer = \"Presion.var\")\n\ncrs(var_raster_utm) &lt;- \"+init=epsg:3310\"\n\nvar_raster_wgs84 &lt;- raster::projectRaster(\n    raster::mask(\n        var_raster_utm, \n        sh_mundos_sp_utm_simple\n    ),\n    crs = \"+init=epsg:4326\", \n    method = \"bilinear\"\n)\n\nmax_var &lt;- raster::cellStats(var_raster_wgs84, stat='max')\nstep_var &lt;- max_var / 6\n\nbinsv &lt;- round(seq(0, max_var, by=step_var),2)\n\nvar_range &lt;- c(minValue(var_raster_wgs84), maxValue(var_raster_wgs84))\npal_var &lt;- colorBin(\n  palette = \"Spectral\", # La paleta de colores\n  domain = var_range,\n  bins = binsv,\n  na.color = \"transparent\"\n)\n\nmapa_var_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    var_raster_wgs84,\n    colors = pal_var, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n  addLegend(\n    pal = pal_var, \n    values = var_range,\n    title = \"Varianza\",\n    position = \"topright\"\n  ) \n\n#3. Mapa Cv ----------------------------------------------\n\ncv_raster_utm &lt;- sqrt(var_raster_utm) / abs(predic_raster_utm)\n\nmapa_mayor_a_uno &lt;- cv_raster_utm &gt; 1\ncv_raster_utm[mapa_mayor_a_uno] &lt;- 1\n\ncrs(cv_raster_utm) &lt;- \"+init=epsg:3310\"\n\ncv_terra &lt;- terra::rast(cv_raster_utm)\nsh_terra &lt;- terra::vect(sh_mundos_sp_utm_simple)\n\nmasked_cv_terra &lt;- terra::mask(cv_terra, sh_terra)\n\ncv_raster_wgs84_terra &lt;- terra::project(\n    masked_cv_terra, \n    y = \"epsg:4326\", \n    method = \"bilinear\" # Similar a projectRaster\n)\n\ncv_raster_wgs84 &lt;- raster::raster(cv_raster_wgs84_terra)\n\nmax_cv &lt;- raster::cellStats(cv_raster_wgs84, stat='max')\nstep_cv &lt;- max_cv / 10\n\nbincv &lt;- seq(0,max_cv, by=step_cv)\n\ncv_range &lt;- c(minValue(cv_raster_wgs84), maxValue(cv_raster_wgs84))\n\npal_cv &lt;- colorBin(\n  palette = \"RdYlGn\", # Rojo-Amarillo-Verde\n  domain = cv_range,\n  na.color = \"transparent\",\n  bins = bincv,\n  reverse = TRUE\n)\n\nmapa_cv_leaflet &lt;- leaflet() %&gt;%\n  addProviderTiles(providers$CartoDB.Positron) %&gt;%\n  addRasterImage(\n    cv_raster_wgs84,\n    colors = pal_cv, \n    opacity = 0.7,\n    group = \"Predicción Kriging\"\n  ) %&gt;%\n  addLegend(\n    pal = pal_cv, \n    values = cv_range,\n    title = \"Coeficiente de Variación\",\n    position = \"topright\"\n  )\n\n\n\nPredicciónVarianzaCoeficiente de variación\n\n\n\n\nVer código\nmapa_kriging_leaflet\n\n\n\n\n\n\n\n\n\n\nVer código\nmapa_var_leaflet\n\n\n\n\n\n\n\n\n\n\nVer código\nmapa_cv_leaflet",
    "crumbs": [
      "Análisis Geoestadístico",
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Análisis Univariado</span>"
    ]
  },
  {
    "objectID": "Geo_uni.html#conclusiones",
    "href": "Geo_uni.html#conclusiones",
    "title": "1  Análisis Univariado",
    "section": "1.4 Conclusiones",
    "text": "1.4 Conclusiones",
    "crumbs": [
      "Análisis Geoestadístico",
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Análisis Univariado</span>"
    ]
  }
]