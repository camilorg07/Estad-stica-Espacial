{
  "hash": "dcb0e14d1da0a8aa3665a3a8ec39569e",
  "result": {
    "engine": "knitr",
    "markdown": "# Análisis Bivariado\n\nSe consideran las variables **temperatura** y **velocidad del viento**: \n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(readxl)\nlibrary(geoR)\nlibrary(matrixcalc)\nlibrary(dplyr)\nlibrary(geoR)\nlibrary(sp)\nlibrary(readxl)\nlibrary(tidyr)\nlibrary(sf)\nlibrary(ggplot2)\nlibrary(knitr)\nlibrary(plotly)\nlibrary(leaflet)\nlibrary(raster)\nlibrary(stars)\nlibrary(gstat)\n\n\ncov_cos <- function(sigma, h, phi){\n  sigma * cos(h/phi)\n}\n\ncos_sv <- function(nugget, sigma, h, phi){\n  nugget +  sigma *(1 - cos(h/phi))\n}\n\n#Variable Temperatura ---------------------------------------\n\nTemp <- read_excel(\"GeoEst_Cali.xlsx\", sheet = \"Temperatura\")\ncolnames(Temp)[-1] <- as.numeric(colnames(Temp)[-1])\nEstacionesT <- read_excel(\"GeoEst_Cali.xlsx\", sheet = \"Estaciones\")\nEstacionesT <- EstacionesT %>% mutate(AQSID = as.numeric(AQSID))\nEstacionesT <- EstacionesT %>% filter(AQSID %in% colnames(Temp)[-1])\n\ny_T <- Temp[1,] #Tomar una fecha\ny_T <- cbind(colnames(y_T),t(y_T[1,]))\ny_T <- y_T[-1,]\ny_T <- as.data.frame(y_T)\ny_T <- na.omit(y_T)\ny_T <- y_T[-which.min(y_T$V2),]\ny_T$V1 <- as.numeric(y_T$V1)\ny_T <- inner_join(y_T, EstacionesT, by=c(\"V1\"=\"AQSID\"))\ndatosT <- y_T[,c(13,14,2)]\ncolnames(datosT)=c(\"Este\",\"Norte\",\"Temperatura\")\ndatosT$Temperatura <- as.numeric(datosT$Temperatura)\n\ntemp <- as.geodata(datosT)\n\n\n\n#Variable Velocidad del viento ------------------------------\n\nWS <- read_excel(\"GeoEst_Cali.xlsx\", sheet = \"WindSpeed\")\ncolnames(WS)[-1] <- as.numeric(colnames(WS)[-1])\nEstacionesWS <- read_excel(\"GeoEst_Cali.xlsx\", sheet = \"Estaciones\")\nEstacionesWS <- EstacionesWS %>% mutate(AQSID = as.numeric(AQSID))\nEstacionesWS <- EstacionesWS %>% filter(AQSID %in% colnames(WS)[-1])\n\ny_WS <- WS[1,] #Tomar una fecha\ny_WS <- cbind(colnames(y_WS),t(y_WS[1,]))\ny_WS <- y_WS[-1,]\ny_WS <- as.data.frame(y_WS)\ny_WS <- na.omit(y_WS)\ny_WS$V1 <- as.numeric(y_WS$V1)\ny_WS <- inner_join(y_WS, EstacionesWS, by=c(\"V1\"=\"AQSID\"))\ndatosWS <- y_WS[,c(13,14,2)]\ncolnames(datosWS)=c(\"Este\",\"Norte\",\"WindSpeed\")\ndatosWS$WindSpeed <- as.numeric(datosWS$WindSpeed)\n\nws <- as.geodata(datosWS)\n```\n:::\n\n\n\n\n\n\n\n\n::: panel-tabset\n\n## Temperatura\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npander::pander(summary(temp))\n```\n\n::: {.cell-output-display}\n\n\n  * **n**: _122_\n  * **coords.summary**:\n\n    -----------------------------\n     &nbsp;     Este      Norte\n    --------- --------- ---------\n     **min**   -325701   -580919\n\n     **max**   387270    281577\n    -----------------------------\n\n  * **distances.summary**:\n\n    ---------------\n      min     max\n    ------- -------\n     609.2   1e+06\n    ---------------\n\n  * **data.summary**:\n\n    --------------------------------------------------\n     Min.   1st Qu.   Median   Mean    3rd Qu.   Max.\n    ------ --------- -------- ------- --------- ------\n     -3.2    13.15     15.8    14.43    17.2     24.5\n    --------------------------------------------------\n\n\n<!-- end of list -->\n\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n## Velocidad del viento\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npander::pander(summary(ws))\n```\n\n::: {.cell-output-display}\n\n\n  * **n**: _89_\n  * **coords.summary**:\n\n    -----------------------------\n     &nbsp;     Este      Norte\n    --------- --------- ---------\n     **min**   -276541   -543973\n\n     **max**   415574    281577\n    -----------------------------\n\n  * **distances.summary**:\n\n    ---------------\n     min     max\n    ------ --------\n     2216   987994\n    ---------------\n\n  * **data.summary**:\n\n    --------------------------------------------------\n     Min.   1st Qu.   Median   Mean    3rd Qu.   Max.\n    ------ --------- -------- ------- --------- ------\n     0.8      2.5      3.8     4.375     5.5     14.1\n    --------------------------------------------------\n\n\n<!-- end of list -->\n\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n:::\n\n## Modelos Univariados\n\n### Estacionariedad en Media\n\n::: panel-tabset\n\n#### Temperatura\n\nEl modelo es: $$Temperatura = \\beta_0 + \\beta_1 \\times Norte + \\beta_2 \\times Norte^2$$\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(temp, qt.col = c(\"purple\",\n                    \"pink\",\n                    \"green\",\n                    \"yellow\"),\n     scatter3d=T, trend=~Norte+I(Norte^2))\n```\n\n::: {.cell-output-display}\n![](Geo_bi_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n\n```{.r .cell-code}\nfitT <- lm(Temperatura~Norte+I(Norte^2), data = datosT) \npander::pander(summary(fitT))\n```\n\n::: {.cell-output-display}\n\n-----------------------------------------------------------------\n     &nbsp;         Estimate    Std. Error   t value   Pr(>|t|)  \n----------------- ------------ ------------ --------- -----------\n **(Intercept)**     13.26        0.5352      24.77    8.812e-49 \n\n    **Norte**      -2.229e-05    3.23e-06    -6.901    2.676e-10 \n\n **I(Norte^2)**    -3.754e-11   8.551e-12     -4.39    2.469e-05 \n-----------------------------------------------------------------\n\n\n--------------------------------------------------------------\n Observations   Residual Std. Error   $R^2$    Adjusted $R^2$ \n-------------- --------------------- -------- ----------------\n     122               4.049          0.3199       0.3084     \n--------------------------------------------------------------\n\nTable: Fitting linear model: Temperatura ~ Norte + I(Norte^2)\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n#### Velocidad del viento\n\nEl modelo es: $$WindSpeed = \\beta_0 + \\beta_1 \\times Este + \\beta_2 \\times Norte + + \\beta_3 \\times Este \\times Norte$$\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(temp, qt.col = c(\"purple\",\n                      \"pink\",\n                      \"green\",\n                      \"yellow\"),\n     scatter3d=T, trend=~Norte*Este)\n```\n\n::: {.cell-output-display}\n![](Geo_bi_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n\n```{.r .cell-code}\nfitWS <- lm(WindSpeed~Este*Norte, data = datosWS) \npander::pander(summary(fitWS))\n```\n\n::: {.cell-output-display}\n\n----------------------------------------------------------------\n     &nbsp;        Estimate    Std. Error   t value   Pr(>|t|)  \n----------------- ----------- ------------ --------- -----------\n **(Intercept)**     6.398       0.3639      17.58    4.751e-30 \n\n    **Este**       2.069e-05   2.674e-06     7.739    1.895e-11 \n\n    **Norte**      1.159e-05   1.808e-06     6.411    7.746e-09 \n\n **Este:Norte**    2.558e-11   7.483e-12     3.419    0.000968  \n----------------------------------------------------------------\n\n\n--------------------------------------------------------------\n Observations   Residual Std. Error   $R^2$    Adjusted $R^2$ \n-------------- --------------------- -------- ----------------\n      89               1.938          0.4851       0.4669     \n--------------------------------------------------------------\n\nTable: Fitting linear model: WindSpeed ~ Este * Norte\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n:::\n\n### Variogramas\n\n#### Temperatura\n\nPara esta variable ya se analizo y encontró un modelo apropiado en el capítulo 1.\n\n#### Velocidad del viento\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvgO_WS <- variog(ws,estimator.type = \"modulus\", pairs.min=50)\n\nvg1_WS <- variog(ws, trend = ~Norte*Este,\n                estimator.type = \"modulus\", pairs.min=50)\n```\n:::\n\n\n\n\n\n\n\n\n::: panel-tabset\n\n##### Con tendencia\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(vgO_WS,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Sin remover tendencia\",\n     col.main = 4, cex.main =1.3)\n```\n\n::: {.cell-output-display}\n![](Geo_bi_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n##### Sin tendencia\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(vg1_WS,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Removiendo tendencia\",\n     col.main = 4, cex.main =1.3)\n```\n\n::: {.cell-output-display}\n![](Geo_bi_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n:::\n\n##### Estimación teórica del semivariograma\n\nSe asume un modelo Coseno y Wave:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Estimación del coseno ---------------------------------\n\nh_range <- seq(0, max(vg1_WS$u), by = 1000)\n\nMSE_ponderados <- function(par, h, gamma,kappa=NA,w, model, n, pesos){\n  nugget <- par[1]\n  sigma <- par[2]\n  phi <- par[3]\n  \n  gamma_hat <- switch(model,\n                      \"exponencial\" = sv_exp(nugget, sigma, h, phi),\n                      \"gaussian\"    = sv_gauss(nugget, sigma, h, phi),\n                      \"gneiting\"    = sv_gneiting(nugget, sigma, h, phi),\n                      \"spherical\"   = sv_spherical(nugget, sigma, h, phi),\n                      \"matern\"      = sv_matern(nugget, sigma, h, phi, kappa),\n                      \"cos\"         = cos_sv(nugget, sigma, h, phi)\n  )\n  \n  w <- switch(pesos,\n              \"Cressie\" = 1/(2*(2*gamma_hat)^2/n),\n              \"n\" = 1/n,\n              \"h/n\" = 1/(h/n),\n              \"I\" = 1)\n  \n  sum(w*(gamma - gamma_hat)^2)\n}\n\n\nloglik <- function(par, kappa=NA, z, dist_matrix, model){\n  sigma_0 <- par[1]\n  phi_0 <- par[2]\n  nugget_0 <- par[3]\n  kappa_0 <- kappa\n  \n  cov <- switch(model,\n                \"exponencial\" = cov_exp,\n                \"gaussian\"    = cov_gauss,\n                \"spherical\"   = cov_spherical,\n                \"gneiting\"    = cov_gneiting,\n                \"matern\"      = cov_matern,\n                \"cos\"         = cov_cos \n  )\n  \n  args_cov <- names(formals(cov))\n  \n  args_list <- list(\n    sigma  = sigma_0,\n    nugget = nugget_0,\n    h      = dist_matrix,\n    phi    = phi_0,\n    kappa  = kappa_0\n  )\n  \n  args_list <- args_list[names(args_list) %in% args_cov]\n  \n  Sigma <- do.call(cov, args_list) \n  diag(Sigma) = diag(Sigma) + nugget_0\n  \n  if (!is.positive.definite(Sigma)) {\n    Sigma <- as.matrix(nearPD(Sigma, corr = FALSE)$mat)\n  }\n  \n  # Descomposición de Cholesky (más estable que solve o det)\n  inv_Sigma <- solve(Sigma)\n  det <- log(det(Sigma))\n  \n  # Log-verosimilitud del modelo Gaussiano\n  z <- z \n  n <- length(z)\n  ll <- -0.5 * (n * log(2 * pi) + det + crossprod(z, inv_Sigma %*% z))  # Log-verosimilitud (negativa porque optim minimiza)\n  return(-ll)\n}\n\nsv_ini <- cos_sv(1.5, 1.5, vg1_WS$u, .6e5)\nn <- vg1_WS$n\n\nvariog_WS <- data.frame(h = vg1_WS$u, gamma_hat = vg1_WS$v,\n                       n = vg1_WS$n)\n\n# Cressie -------------------------------------------------\n\nWW <- (2*(2*sv_ini)^2/n)\n\nBessel <- nls(formula = gamma_hat ~cos_sv(nugget, sigma, h, phi),\n              start = c(nugget = 1.5, sigma = 1.5, phi = .6e5),\n              weights = 1/WW,\n              lower = rep(1e-6,3),\n              data = variog_WS,\n              control = nls.control(maxiter = 500, warnOnly = TRUE))\n\n\noptim_bessel <- optim(\n  par = coef(Bessel),\n  fn = MSE_ponderados,\n  h = variog_WS$h,\n  gamma = variog_WS$gamma_hat,\n  pesos = \"Cressie\",\n  model = \"cos\",\n  n = n,\n  method = \"L-BFGS-B\",\n  lower = rep(1e-6,3)\n)\n\npar_optim_Bess <- optim_bessel$par[c(\"nugget\", \"sigma\", \"phi\")]\n\n# 1/n ------------------------------------------------------\n\nW1 <- n\n\nn_pond <- nls(formula = gamma_hat ~cos_sv(nugget, sigma, h, phi),\n              start = c(nugget = 1.5, sigma = 1.5, phi = .6e5),\n              weights = 1/W1,\n              lower = rep(1e-6,3),\n              data = variog_WS,\n              control = nls.control(maxiter = 500, warnOnly = TRUE))\n\n\noptim_n <- optim(\n  par = coef(n_pond),\n  fn = MSE_ponderados,\n  h = variog_WS$h,\n  gamma = variog_WS$gamma_hat,\n  pesos = \"n\",\n  model = \"cos\",\n  n = n,\n  method = \"L-BFGS-B\",\n  lower = rep(1e-6,3)\n)\n\npar_optim_n <- optim_n$par[c(\"nugget\", \"sigma\", \"phi\")]\n\n# n/h -----------------------------------------------------\n\nW2 <- variog_WS$h/n\n\nh_n_pond <- nls(formula = gamma_hat ~cos_sv(nugget, sigma, h, phi),\n              start = c(nugget = 1.5, sigma = 1.5, phi = .6e5),\n              weights = 1/W2,\n              lower = rep(1e-6,3),\n              data = variog_WS,\n              control = nls.control(maxiter = 500, warnOnly = TRUE))\n\noptim_h_n <- optim(\n  par = coef(h_n_pond),\n  fn = MSE_ponderados,\n  h = variog_WS$h,\n  gamma = variog_WS$gamma_hat,\n  pesos = \"h/n\",\n  model = \"cos\",\n  n = n,\n  method = \"L-BFGS-B\",\n  lower = rep(1e-6,3)\n)\n\npar_optim_h_n <- optim_h_n$par[c(\"nugget\", \"sigma\", \"phi\")]\n\nI_pond <- nls(formula = gamma_hat ~cos_sv(nugget, sigma, h, phi),\n              start = c(nugget = 1.5, sigma = 1.5, phi = .6e5),\n              lower = rep(1e-6,3),\n              data = variog_WS,\n              control = nls.control(maxiter = 500, warnOnly = TRUE))\n\n# MCO -----------------------------------------------------\n\noptim_I <- optim(\n  par = coef(I_pond),\n  fn = MSE_ponderados,\n  h = variog_WS$h,\n  gamma = variog_WS$gamma_hat,\n  pesos = \"I\",\n  model = \"cos\",\n  n = n,\n  method = \"L-BFGS-B\",\n  lower = rep(1e-6,3)\n)\n\npar_optim_I <- optim_I$par[c(\"nugget\", \"sigma\", \"phi\")]\n\nestcos_sv_Bess_WS <- do.call(cos_sv, c(as.list(par_optim_Bess), list(h = h_range)))\nestcos_sv_n_WS <- do.call(cos_sv, c(as.list(par_optim_n), list(h = h_range)))\nestcos_sv_h_n_WS <- do.call(cos_sv, c(as.list(par_optim_h_n), list(h = h_range)))\nestcos_sv_I_WS <- do.call(cos_sv, c(as.list(par_optim_I), list(h = h_range)))\n\n# Modelo wave ----------------------------------------------\n\nfitvar1 <- variofit(vg1_WS,\n                    cov.model = \"wave\",\n                    c(3.5,.6e5),\n                    fix.nugget = F,\n                    wei = \"equal\")\nfitvar2 <- variofit(vg1_WS,\n                    cov.model = \"wave\",\n                    c(3.5,.6e5),\n                    fix.nugget = F,\n                    wei = \"npairs\")\n\nfitvar3 <- variofit(vg1_WS,\n                    cov.model = \"wave\",\n                    c(3.5,.6e5),\n                    fix.nugget = F,\n                    wei = \"cressie\")\n\nfitvar4_es_T <- likfit(ws,\n                       coords = ws$coords,\n                       data = ws$data,\n                       trend = ~ Este*Norte,\n                       ini.cov.pars = c(3.5, .6e5),\n                       fix.nugget = F,\n                       nugget = 1.5,\n                       cov.model = \"wave\",\n                       lik.method = \"ML\")\n```\n:::\n\n\n\n\n\n\n\n\n::: panel-tabset\n\n###### Coseno (Optim)\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(vg1_WS,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Removiendo tendencia\",\n     col.main = 4, cex.main =1.3)\nlines(h_range, estcos_sv_Bess_WS, col=\"#FF4040\", lwd=1.5)\nlines(h_range, estcos_sv_n_WS, col=\"#4169E1\", lwd=1.5)\nlines(h_range, estcos_sv_h_n_WS, col=\"#008B00\", lwd=1.5)\nlines(h_range, estcos_sv_I_WS, col=\"#FFA500\", lwd=1.5)\nlegend(\"topleft\",\n       c(\"Cressie\", \"1/n\", \"n/h\", \"MCO\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n```\n\n::: {.cell-output-display}\n![](Geo_bi_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n###### Wave (GeoR)\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(vg1_WS,\n     xlab = \"h\",\n     ylab = \"Semivarianza\",\n     cex.lab = 1.3,\n     cex.axis = 1.2,\n     main = \"Removiendo tendencia\",\n     col.main = 4, cex.main =1.3)\n\nlines(fitvar1, col=\"#FF4040\", lwd=1.5)\nlines(fitvar2, col=\"#4169E1\", lwd=1.5)\nlines(fitvar3, col=\"#008B00\", lwd=1.5)\nlines(fitvar4_es_T, col=\"#FFA500\", lwd=1.5)\n\nlegend(\"topleft\",\n       c(\"MCO\", \"1/n\", \"Cressie\", \"MLE\"),#, \"REML\"),\n       lwd = 1,\n       lty = 3,\n       col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       box.col = 9,\n       text.col = c(\"#FF4040\", \"#4169E1\", \"#008B00\",\"#FFA500\"),\n       cex=1,\n       seg.len = .5)\n```\n\n::: {.cell-output-display}\n![](Geo_bi_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n:::\n\n## Modelo cruzado de semivarianza\n\nConsiderando un modelo esférico para Temperatura y un modelo Wave para WS, las matrices para el modelo de coregionalización son: \n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\nmat1 <- cbind(c(8, 3.5),\n              c(3.5, 1))\n\nmat2 <-cbind(c(8, 3.5),\n             c(3.5, 1))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndatosT1 <- datosT\ndatosWS1 <- datosWS\ninvisible(coordinates(datosT1) <- ~ Este + Norte)\ninvisible(coordinates(datosWS1) <- ~ Este + Norte)\n\n\nvgmntemp <- vgm(psill = mat1[1, 1],\n              model = \"Sph\",\n              range = 2e5,\n              nugget = .5,\n              add.to = vgm(psill = mat2[1, 1],\n                           model = \"Wav\",\n                           range = .5e5, nugget = 2))\n\nvgmws <- vgm(psill = mat1[2, 2],\n             model = \"Sph\",\n             range = 2e5,\n             nugget = .5,\n             add.to = vgm(psill = mat2[2, 2],\n                          model = \"Wav\",\n                          range = .5e5, nugget = 2))\n\n\nvgmntemp_sv <- vgm(psill = mat1[1, 2], model = \"Sph\",\n                 range = 2e5,\n                 nugget = .5,\n                 add.to = vgm(psill = mat2[1, 2],\n                              model = \"Wav\",\n                              range = .5e5, nugget = 2))\n\n\n\ng <- gstat(NULL, id=\"Temp\", formula=Temperatura~Norte+I(Norte^2),\n           data=datosT1, model = vgmntemp)\ng <- gstat(g, id=\"W_speed\", formula=WindSpeed~Norte*Este,\n           data=datosWS1, model = vgmws)\ng <- gstat(g, c(\"Temp\",\"W_speed\"), model = vgmntemp_sv)\n\nplot(variogram(g),\n     model = g$model,\n     pl = F,\n     xlab = \"Distancias\",\n     ylab = \"Semivarianza\")\n```\n\n::: {.cell-output-display}\n![](Geo_bi_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n# Referencias {-}",
    "supporting": [
      "Geo_bi_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}