---
bibliography: referencias.bib
nocite: '@*'
---

::: {style="font-size: 1.5em; font-weight: bold; margin-bottom: 0.8em; margin-top: 0.5em;"}
Análisis Geoestadístico de la Temperatura y Velocidad del Viento en el Estado de California a las 00:00 horas del primero Marzo de 2024
:::

# Análisis Bivariado

## Planteamiento del problema

### Introducción

La calidad del aire influye directamente en la salud y el bienestar, y en California este tema es especialmente crítico debido a su alta densidad poblacional, el tráfico vehicular, la actividad industrial y fenómenos como los incendios forestales. Estas condiciones favorecen episodios recurrentes de contaminación, cuya intensidad y dispersión dependen en gran medida de factores meteorológicos.

Entre ellos, la temperatura y la velocidad del viento son variables clave, pues afectan la acumulación y transporte de contaminantes y, además, presentan una fuerte dependencia espacial y correlación entre sí. Para capturar esta relación conjunta y mejorar la precisión de la interpolación espacial, empleamos un modelo de cokriging, que permite analizar simultáneamente las estructuras de variabilidad y covariación entre ambas variables a partir de los datos registrados en estaciones meteorológicas de California.

### Descripción de los datos

Los datos objeto de este estudio provienen de la [Agencia de Protección Ambiental (EPA)](https://www.epa.gov/) de los Estados Unidos y corresponden a registros horarios obtenidos de las estaciones de monitoreo durante el mes de marzo de 2024. En particular, se analizan las variables **Temperatura ambiente (Temp)** y **Velocidad del viento (WS)**.

#### Unidades

-   **Temperatura ambiente:** Medida en grados celsius (C°) con una intensidad horaria.

-   **Velocidad del viento:** Medida en metros por segundo (m/s) con una intensidad horaria.

### Objetivos

#### Objetivo general

Estudiar e identificar la tendencia y los patrones espaciales de la temperatura y la velocidad del viento mediante herramientas de análisis geoestadístico bivariado, con el propósito de construir un modelo de cokriging que permita caracterizar y predecir su comportamiento espacial en el estado de California durante un periodo específico de tiempo en marzo de 2024.

#### Objetivos específicos

1.  Construir los semivariogramas empíricos directos y cruzados, y ajustar un Modelo Lineal de Corregionalización (LMC) que describa adecuadamente la dependencia espacial conjunta entre ambas variables, garantizando la validez y coherencia del modelo multivariado.

2.  Aplicar la técnica de Cokriging para construir los mapas de predicción espacial y los mapas de incertidumbre asociados, con el fin de representar la distribución esperada de las variables y evaluar la precisión de las estimaciones.

3.  Comparar los resultados del Cokriging con los obtenidos mediante Kriging univariado, evaluando la ganancia en precisión y estabilidad derivada del uso de información cruzada entre las variables

## Análisis Geoestadístico Bivariado

En este análisis se consideran los datos de **temperatura** y **velocidad del viento** registrados a las 00:00 horas del 1 de marzo de 2024.


```{r, warning=FALSE, message=FALSE}
library(readxl)
library(geoR)
library(matrixcalc)
library(dplyr)
library(geoR)
library(sp)
library(readxl)
library(tidyr)
library(sf)
library(ggplot2)
library(knitr)
library(plotly)
library(leaflet)
library(raster)
library(stars)
library(gstat)
library(Matrix)


#Gráficos de dispersión ----------------------------------

simple_scatter_plot <- function(datos, variable1, variable2) {

    plot1 <- ggplot(as.data.frame(datos),
                    aes(x = .data[[variable1]], y = .data[[variable2]],
                               color = as.factor(1))) +
                    geom_point() +
                    scale_colour_viridis_d() +
                    labs(
                        x = variable1,
                        y = variable2
                        ) +
                    theme_light() +
                    theme(legend.position = "none")

    return(plot1)

}

#Variable Temperatura ---------------------------------------

Temp <- read_excel("GeoEst_Cali.xlsx", sheet = "Temperatura")
colnames(Temp)[-1] <- as.numeric(colnames(Temp)[-1])
EstacionesT <- read_excel("GeoEst_Cali.xlsx", sheet = "Estaciones")
EstacionesT <- EstacionesT %>% mutate(AQSID = as.numeric(AQSID))
EstacionesT <- EstacionesT %>% filter(AQSID %in% colnames(Temp)[-1])

y_T <- Temp[1,] #Tomar una fecha
y_T <- cbind(colnames(y_T),t(y_T[1,]))
y_T <- y_T[-1,]
y_T <- as.data.frame(y_T)
y_T <- na.omit(y_T)
y_T <- y_T[-which.min(y_T$V2),]
y_T$V1 <- as.numeric(y_T$V1)
y_T <- inner_join(y_T, EstacionesT, by=c("V1"="AQSID"))
datosT <- y_T[,c(13,14,2)]
colnames(datosT)=c("Este","Norte","Temperatura")
datosT$Temperatura <- as.numeric(datosT$Temperatura)

temp <- as.geodata(datosT)



#Variable Velocidad del viento ------------------------------

WS <- read_excel("GeoEst_Cali.xlsx", sheet = "WindSpeed")
colnames(WS)[-1] <- as.numeric(colnames(WS)[-1])
EstacionesWS <- read_excel("GeoEst_Cali.xlsx", sheet = "Estaciones")
EstacionesWS <- EstacionesWS %>% mutate(AQSID = as.numeric(AQSID))
EstacionesWS <- EstacionesWS %>% filter(AQSID %in% colnames(WS)[-1])

y_WS <- WS[1,] #Tomar una fecha
y_WS <- cbind(colnames(y_WS),t(y_WS[1,]))
y_WS <- y_WS[-1,]
y_WS <- as.data.frame(y_WS)
y_WS <- na.omit(y_WS)
y_WS$V1 <- as.numeric(y_WS$V1)
y_WS <- inner_join(y_WS, EstacionesWS, by=c("V1"="AQSID"))
datosWS <- y_WS[,c(13,14,2)]
colnames(datosWS)=c("Este","Norte","WindSpeed")
datosWS$WindSpeed <- as.numeric(datosWS$WindSpeed)

ws <- as.geodata(datosWS)

#Para el mapa de California -------------------------------

sh_mundos<-st_read("admin00.shp",quiet=TRUE)
sh_mundos <- sh_mundos %>% filter(CNTRY_NAME=="United States")
sh_mundos <- sh_mundos %>% filter(ADMIN_NAME=="California")

CRS_UTM_NY = "+init=epsg:3310"

sh_mundos_wgs84 <- st_transform(sh_mundos, crs = 4326)

sh_mundos_utm <- st_transform(sh_mundos, crs = CRS("EPSG:3310"))

sh_mundos_sp_utm <- as(sh_mundos_utm, "Spatial")

sh_mundos_utm_simple <- st_union(sh_mundos_utm)
sh_mundos_sp_utm_simple <- as(sh_mundos_utm_simple, "Spatial")

```

::: panel-tabset
### Temperatura

```{r, message=FALSE, warning=FALSE}
datosT_sf <- st_as_sf(datosT, coords = c("Este", "Norte"), crs = 3310)

datosT_sf_wgs84 <- st_transform(datosT_sf, crs = 4326)

pal <- colorNumeric(palette = "viridis", domain = datosT_sf_wgs84$Temperatura)

leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data = sh_mundos_wgs84, fill = FALSE, color = "black", weight = 2) %>%
  addCircleMarkers(data = datosT_sf_wgs84,
                   fillColor = ~pal(Temperatura),
                   fillOpacity = 0.8,
                   color = "black",
                   weight = 1,
                   radius = 3,
                   popup = ~paste("Temp:", Temperatura, "°C")) %>%
  addLegend(pal = pal, values = datosT_sf_wgs84$Temperatura, title = "Temperatura (°C)")

pander::pander(summary(temp))
```

### Velocidad del viento

```{r, message=FALSE, warning=FALSE}
datosWS_sf <- st_as_sf(datosWS, coords = c("Este", "Norte"), crs = 3310)

datosWS_sf_wgs84 <- st_transform(datosWS_sf, crs = 4326)

palWS <- colorNumeric(palette = "viridis", domain = datosWS_sf_wgs84$WindSpeed)

leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data = sh_mundos_wgs84, fill = FALSE, color = "black", weight = 2) %>%
  addCircleMarkers(data = datosWS_sf_wgs84,
                   fillColor = ~palWS(WindSpeed),
                   fillOpacity = 0.8,
                   color = "black",
                   weight = 1,
                   radius = 3,
                   popup = ~paste("WindSpeed:", WindSpeed, "m/s")) %>%
  addLegend(pal = palWS, values = datosWS_sf_wgs84$WindSpeed, title = "WindSpeed (m/s)")

pander::pander(summary(ws))
```
:::

### Modelos Univariados

#### Análisis de Estacionariedad en Media

El estudio de la influencia de las coordenadas espaciales en la media de ambas variables ya se realizó en el [Análisis Univariado](#cap1). A continuación se presenta únicamente un resumen del ajuste.

::: panel-tabset
##### Temperatura

El modelo es: $$Temperatura = \beta_0 + \beta_1 \times Norte + \beta_2 \times Norte^2$$

```{r}
fitT <- lm(Temperatura~Norte+I(Norte^2), data = datosT) 
datosT$Residuos <- fitT$residuals

pT1 <- simple_scatter_plot(datosT, "Este", "Residuos")
pT2 <- simple_scatter_plot(datosT, "Norte", "Residuos")

cowplot::plot_grid(pT1,pT2)
pander::pander(summary(fitT))
```

##### Velocidad del viento

El modelo es: $$WindSpeed = \beta_0 + \beta_1 \times Este + \beta_2 \times Norte + \beta_3 \times Este \times Norte$$

```{r}
fitWS <- lm(WindSpeed~Este*Norte, data = datosWS) 
datosWS$Residuos <- fitWS$residuals

pWS1 <- simple_scatter_plot(datosWS, "Este", "Residuos")
pWS2 <- simple_scatter_plot(datosWS, "Norte", "Residuos")

cowplot::plot_grid(pWS1,pWS2)
pander::pander(summary(fitWS))
```
:::

#### Variogramas

Dado que se hará uso de las herramientas del paquete `gstat` se consideró necesario revisar cuál de las estimaciones presentadas en el [Capítulo 1](#cap1), mediante `GeoR`, se ajustan mejor a este entorno. 

::: panel-tabset
##### Temperatura

```{r}
datosT1 <- datosT
invisible(coordinates(datosT1) <- ~ Este + Norte)
vg_T <-  variogram(Temperatura~Norte+I(Norte^2), datosT1, cressie=T)
exp_T <- fit.variogram(vg_T, vgm("Exp"),
                          fit.method = 2)
plot(vg_T, model = exp_T)
pander::pander(exp_T)
```

##### Velocidad del viento

```{r}
datosWS1 <- datosWS
invisible(coordinates(datosWS1) <- ~ Este + Norte)
vg_WS <-  variogram(WindSpeed~Norte*Este, datosWS1,cressie=T)
exp_WS <- fit.variogram(vg_WS, vgm("Wav"),
                          fit.method = 7)
plot(vg_WS, model = exp_WS)
pander::pander(exp_WS)

```

:::

### Modelo Lineal de Corregionalización

Considerando un modelo **Exponencial** para Temperatura y un modelo **Wave** para WS, se proponen los siguientes valores, ajustados por la función `nearPD` del paquete `Matrix` con el objetivo de garantizar un modelo válido de coregionalización, para las matrices:

```{r, message=FALSE, warning=FALSE}
mat1 <- cbind(c(6, 4),
              c(4, 0))

mat1 <- nearPD(mat1)$mat
mat1 <- as.matrix(mat1)

colnames(mat1) <- rownames(mat1)<- c("Temp","WS")

mat2 <-cbind(c(4.5, 4.2),
             c(4.2, 0))

mat2 <- nearPD(mat2)$mat
mat2 <- as.matrix(mat2)

colnames(mat2) <- rownames(mat2)<- c("Temp","WS")

mat3 <-cbind(c(0, 3),
             c(3, 0.1))

mat3 <- nearPD(mat3)$mat
mat3 <- as.matrix(mat3)

colnames(mat3) <- rownames(mat3)<- c("Temp","WS")

```

::: panel-tabset

#### Exponencial

```{r}
pander::pander(mat1, caption = "Matriz para Temperatura")
```

#### Wave

```{r}
pander::pander(mat2, caption = "Matriz para Velocidad del viento")
```

#### Nugget

```{r}
pander::pander(mat3, caption = "Matriz para Nugget")
```

:::

Para los valores iniciales se tiene el siguiente ajuste:

```{r,, message=FALSE, warning=FALSE}

vgmntemp <- vgm(psill = mat1[1, 1],
              model = "Exp",
              range = exp_T$range[2],
              nugget = mat3[1,1],
              add.to = vgm(psill = mat2[1, 1],
                           model = "Wav",
                           range = exp_WS$range[2]))

vgmws <- vgm(psill = mat1[2, 2],
             model = "Exp",
             range = exp_T$range[2],
             nugget = mat3[2,2],
             add.to = vgm(psill = mat2[2, 2],
                          model = "Wav",
                          range = exp_WS$range[2]))


vgmntemp_sv <- vgm(psill = mat1[1, 2],
                   model = "Exp",
                 range = exp_T$range[2],
                 nugget = mat3[1,2],
                 add.to = vgm(psill = mat2[1, 2],
                              model = "Wav",
                              range = exp_WS$range[2]))



g <- gstat(NULL, id="Temp", formula=Temperatura~Norte+I(Norte^2),
           data=datosT1, model = vgmntemp)
g <- gstat(g, id="W_speed", formula=WindSpeed~Norte*Este,
           data=datosWS1, model = vgmws)
g <- gstat(g, c("Temp","W_speed"), model = vgmntemp_sv)

plot(variogram(g, cressie=T),
     model = g$model,
     pl = F,
     xlab = "Distancias",
     ylab = "Semivarianza")

pander::pander(g$model)

```

Ahora, realizando el ajuste mediante la función `fit.lmc` de `gstat:

```{r}
vgcross <- gstat(NULL, id = "Temp",
                 form = Temperatura~Norte+I(Norte^2),
                 data = datosT1)

vgcross <- gstat(vgcross, id = "W_speed",
                 form = WindSpeed~Norte*Este,
                 data = datosWS1)

vg <- variogram(vgcross, cressie=T)

fit <- fit.lmc(vg, g, fit.method=6, correct.diagonal=1.01)

plot(vg, model = fit$model)

pander::pander(fit$model)

```


::: {.callout-caution appearance="simple"}
## En desarrollo...
:::

### Cokriging

::: {.callout-caution appearance="simple"}
## En desarrollo...
:::

## Kriging vs Cokriging

::: {.callout-caution appearance="simple"}
## En desarrollo...
:::

## Conclusiones

::: {.callout-caution appearance="simple"}
## En desarrollo...
:::

# Referencias {.unnumbered}
